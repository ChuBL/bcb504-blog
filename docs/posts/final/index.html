<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.313">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Jiyin Zhang">
<meta name="dcterms.date" content="2023-05-08">
<meta name="description" content="Discover the power of data visualization as we explore COVID-19 death cases in the United States through various charts.">

<title>My First Blog - End of the Term: Visualizing the Death of COVID-19</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script type="module" src="../../site_libs/quarto-ojs/quarto-ojs-runtime.js"></script>
<link href="../../site_libs/quarto-ojs/quarto-ojs.css" rel="stylesheet">


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">My First Blog</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/ChuBL/bcb504-blog/"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com"><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">End of the Term: Visualizing the Death of COVID-19</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
            <p class="subtitle lead">Creating Effective Visualizations for COVID-19 Death Cases</p>
                  <div>
        <div class="description">
          Discover the power of data visualization as we explore COVID-19 death cases in the United States through various charts.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">Visualization</div>
                <div class="quarto-category">COVID-19</div>
                <div class="quarto-category">Observable</div>
                <div class="quarto-category">Assignment</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Jiyin Zhang </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">May 8, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="preamble" class="level1">
<h1>PREAMBLE</h1>
<p style="color:red">
Covid-19.
</p>
<p>The COVID-19 pandemic has undoubtedly affected every aspect of our lives, and understanding its impact is crucial in our ongoing efforts to mitigate the spread of the virus and protect vulnerable populations. One valuable resource for understanding this impact is the dataset titled <a href="https://catalog.data.gov/dataset/conditions-contributing-to-deaths-involving-coronavirus-disease-2019-covid-19-by-age-group">“Conditions Contributing to COVID-19 Deaths, by State and Age, Provisional 2020-2023”</a> which offers a comprehensive look at the health conditions and causes mentioned in conjunction with COVID-19 related deaths across different age groups and jurisdictions.</p>
<p>In this blog post, I will explore this dataset and showcase a series of visualizations that aim to provide greater insight into the patterns, trends, and relationships hidden within the data. Our visualizations will include a <strong>state-wise stacked bar chart of ages of COVID-19 deaths</strong>, an <strong>animated visualization capturing the changing dynamics of deaths in each state</strong>, an <strong>interactive network chart connecting death age groups with the conditions leading to death</strong>, and finally, a <strong>choropleth map illustrating COVID-19 deaths by state</strong>. By delving into these visualizations, I hope to not only improve our understanding of the pandemic’s impact on various communities but also inspire data-driven decision-making in our ongoing fight against COVID-19. So, let’s dive in and uncover the stories hidden within the data.</p>
</section>
<section id="data-preparation" class="level1">
<h1>Data Preparation</h1>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the input CSV file</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>input_file <span class="op">=</span> <span class="st">'Conditions_Contributing_to_COVID-19_Deaths__by_State_and_Age__Provisional_2020-2023.csv'</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(input_file)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Split the DataFrame based on the "Group" column values</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>df_by_total <span class="op">=</span> df[df[<span class="st">'Group'</span>] <span class="op">==</span> <span class="st">'By Total'</span>]</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>df_by_month <span class="op">=</span> df[df[<span class="st">'Group'</span>] <span class="op">==</span> <span class="st">'By Month'</span>]</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>df_by_year <span class="op">=</span> df[df[<span class="st">'Group'</span>] <span class="op">==</span> <span class="st">'By Year'</span>]</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Write the DataFrames to separate CSV files</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>df_by_total.to_csv(<span class="st">'by_total.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>df_by_month.to_csv(<span class="st">'by_month.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>df_by_year.to_csv(<span class="st">'by_year.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> state_comparison():</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># List of U.S. states</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    us_states <span class="op">=</span> [</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Alabama'</span>, <span class="st">'Alaska'</span>, <span class="st">'Arizona'</span>, <span class="st">'Arkansas'</span>, <span class="st">'California'</span>, <span class="st">'Colorado'</span>, <span class="st">'Connecticut'</span>,</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Delaware'</span>, <span class="st">'Florida'</span>, <span class="st">'Georgia'</span>, <span class="st">'Hawaii'</span>, <span class="st">'Idaho'</span>, <span class="st">'Illinois'</span>, <span class="st">'Indiana'</span>, <span class="st">'Iowa'</span>,</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Kansas'</span>, <span class="st">'Kentucky'</span>, <span class="st">'Louisiana'</span>, <span class="st">'Maine'</span>, <span class="st">'Maryland'</span>, <span class="st">'Massachusetts'</span>, <span class="st">'Michigan'</span>,</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Minnesota'</span>, <span class="st">'Mississippi'</span>, <span class="st">'Missouri'</span>, <span class="st">'Montana'</span>, <span class="st">'Nebraska'</span>, <span class="st">'Nevada'</span>, <span class="st">'New Hampshire'</span>,</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">'New Jersey'</span>, <span class="st">'New Mexico'</span>, <span class="st">'New York'</span>, <span class="st">'North Carolina'</span>, <span class="st">'North Dakota'</span>, <span class="st">'Ohio'</span>, <span class="st">'Oklahoma'</span>,</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Oregon'</span>, <span class="st">'Pennsylvania'</span>, <span class="st">'Rhode Island'</span>, <span class="st">'South Carolina'</span>, <span class="st">'South Dakota'</span>, <span class="st">'Tennessee'</span>,</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Texas'</span>, <span class="st">'Utah'</span>, <span class="st">'Vermont'</span>, <span class="st">'Virginia'</span>, <span class="st">'Washington'</span>, <span class="st">'West Virginia'</span>, <span class="st">'Wisconsin'</span>, <span class="st">'Wyoming'</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Read the CSV file</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    input_file <span class="op">=</span> <span class="st">'by_year.csv'</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(input_file)</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract unique state values from the 'State' column</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>    unique_states_in_csv <span class="op">=</span> df[<span class="st">'State'</span>].unique()</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compare the unique state values with the U.S. states list</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>    missing_states <span class="op">=</span> <span class="bu">set</span>(us_states) <span class="op">-</span> <span class="bu">set</span>(unique_states_in_csv)</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>    extra_states <span class="op">=</span> <span class="bu">set</span>(unique_states_in_csv) <span class="op">-</span> <span class="bu">set</span>(us_states)</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Missing states:"</span>, missing_states)</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Extra states:"</span>, extra_states)</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> state_filter(filename):</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Read the input CSV file</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>    <span class="co">#input_file = 'Conditions_Contributing_to_COVID-19_Deaths__by_State_and_Age__Provisional_2020-2023.csv'</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(filename)</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter out rows with 'State' column having the value 'Puerto Rico'</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>    filtered_df <span class="op">=</span> df[df[<span class="st">'State'</span>] <span class="op">!=</span> <span class="st">'Puerto Rico'</span>]</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Write the filtered DataFrame to a new CSV file</span></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>    output_file <span class="op">=</span> <span class="st">'filtered_'</span> <span class="op">+</span> filename</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>    filtered_df.to_csv(output_file, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">'__main__'</span>:</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>    <span class="co">#state_comparison()</span></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>    <span class="co">#state_filter('by_month.csv')</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>In the data preparation stage, I utilized Python to divide the entire CSV file into three separate subfiles based on the granularity of time - by total, by year, and by month. I then applied a filter to verify the validity of values under the ‘State’ column. An unexpected subset for ‘Puerto Rico’ was discovered and subsequently discarded. Additionally, ‘District of Columbia’ and ‘New York City’ were singled out from the states.</p>
<p>To plot the choropleth, I found a mapping function for R that geocodes state names, including ‘District of Columbia,’ into a map with regions represented by longitudes and latitudes. Unfortunately, the function did not include New York City, so I had to exclude this part of the data when creating the choropleth visualization.</p>
<p>In addition to these preprocessing steps, I carried out further data cleansing tasks using Python, tailored to the specific requirements of each visualization task.</p>
</section>
<section id="visualizations" class="level1">
<h1>Visualizations</h1>
<section id="bar-chart-for-covid-19-deaths-by-state-and-age-group" class="level2">
<h2 class="anchored" data-anchor-id="bar-chart-for-covid-19-deaths-by-state-and-age-group">Bar Chart for COVID-19 Deaths by State and Age Group</h2>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">#library(viridisLite)</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(viridis)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the CSV file</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"./piechart/filtered_by_total.csv"</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Group the data by state and age group</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>df_grouped <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(COVID.<span class="fl">19.</span>Deaths <span class="sc">~</span> State <span class="sc">+</span> Age.Group, <span class="at">data =</span> df, sum)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Exclude the "United States" rows</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>df_grouped <span class="ot">&lt;-</span> <span class="fu">subset</span>(df_grouped, State <span class="sc">!=</span> <span class="st">"United States"</span>)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Order the states by total number of deaths</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>state_order <span class="ot">&lt;-</span> <span class="fu">with</span>(df_grouped, <span class="fu">reorder</span>(State, <span class="sc">-</span>COVID.<span class="fl">19.</span>Deaths, sum))</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the stacked bar chart</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_grouped, <span class="fu">aes</span>(<span class="at">x =</span> state_order, <span class="at">y =</span> COVID.<span class="fl">19.</span>Deaths, <span class="at">fill =</span> Age.Group)) <span class="sc">+</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"COVID-19 Deaths by State and Age Group"</span>) <span class="sc">+</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"State"</span>) <span class="sc">+</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Number of Deaths"</span>) <span class="sc">+</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>) <span class="sc">+</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill=</span><span class="fu">guide_legend</span>(<span class="at">title=</span><span class="st">"Age Group"</span>)) <span class="sc">+</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis</span>(<span class="at">discrete =</span> <span class="cn">TRUE</span>, <span class="at">option =</span> <span class="st">"viridis"</span>, <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>This visualization presents data from the <em>“Conditions Contributing to COVID-19 Deaths, by State and Age, Provisional 2020-2023”</em> dataset, which provides information on the number of COVID-19 deaths by state, age group, and time period. This visualization focuses on the total number of COVID-19 deaths by state and age group, using data from the “By Total” time period.</p>
<p>The bars in the chart represent the total number of COVID-19 deaths for each state and age group, with the color of each bar indicating the age group. The chart allows for easy comparison of the number of COVID-19 deaths between different states and age groups, with the height of each bar corresponding to the number of deaths.</p>
<p>To provide a clear representation of the data, the information for the United States as a whole has been filtered out from the visualization. This is because including it would compress the height of individual state bars, making it difficult to distinguish between the states.</p>
</section>
<section id="animated-visualization-for-covid-19-deaths-in-each-state" class="level2">
<h2 class="anchored" data-anchor-id="animated-visualization-for-covid-19-deaths-in-each-state">Animated Visualization for COVID-19 Deaths in Each State</h2>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the CSV file</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">"filtered_by_month.csv"</span>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the US states list</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>us_states <span class="op">=</span> [<span class="st">'District of Columbia'</span>, <span class="st">'New York City'</span>, <span class="st">'Alabama'</span>, <span class="st">'Alaska'</span>, <span class="st">'Arizona'</span>, <span class="st">'Arkansas'</span>, </span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>             <span class="st">'California'</span>, <span class="st">'Colorado'</span>, <span class="st">'Connecticut'</span>, <span class="st">'Delaware'</span>, <span class="st">'Florida'</span>, <span class="st">'Georgia'</span>, <span class="st">'Hawaii'</span>, <span class="st">'Idaho'</span>, <span class="st">'Illinois'</span>, </span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>             <span class="st">'Indiana'</span>, <span class="st">'Iowa'</span>, <span class="st">'Kansas'</span>, <span class="st">'Kentucky'</span>, <span class="st">'Louisiana'</span>, <span class="st">'Maine'</span>, <span class="st">'Maryland'</span>, <span class="st">'Massachusetts'</span>, <span class="st">'Michigan'</span>,</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>             <span class="st">'Minnesota'</span>, <span class="st">'Mississippi'</span>, <span class="st">'Missouri'</span>, <span class="st">'Montana'</span>, <span class="st">'Nebraska'</span>, <span class="st">'Nevada'</span>, <span class="st">'New Hampshire'</span>, <span class="st">'New Jersey'</span>,</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>             <span class="st">'New Mexico'</span>, <span class="st">'New York'</span>, <span class="st">'North Carolina'</span>, <span class="st">'North Dakota'</span>, <span class="st">'Ohio'</span>, <span class="st">'Oklahoma'</span>, <span class="st">'Oregon'</span>, <span class="st">'Pennsylvania'</span>,</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>             <span class="st">'Rhode Island'</span>, <span class="st">'South Carolina'</span>, <span class="st">'South Dakota'</span>, <span class="st">'Tennessee'</span>, <span class="st">'Texas'</span>, <span class="st">'Utah'</span>, <span class="st">'Vermont'</span>, <span class="st">'Virginia'</span>,</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>             <span class="st">'Washington'</span>, <span class="st">'West Virginia'</span>, <span class="st">'Wisconsin'</span>, <span class="st">'Wyoming'</span>]</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Exclude rows where the 'name' column is 'United States'</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df[df[<span class="st">'State'</span>] <span class="op">!=</span> <span class="st">'United States'</span>]</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the necessary columns and rename them</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df[[<span class="st">'Start Date'</span>, <span class="st">'State'</span>, <span class="st">'COVID-19 Deaths'</span>]]</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.rename(columns<span class="op">=</span>{<span class="st">'Start Date'</span>: <span class="st">'date'</span>, <span class="st">'State'</span>: <span class="st">'name'</span>, <span class="st">'COVID-19 Deaths'</span>: <span class="st">'value'</span>})</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the date column to datetime format</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'date'</span>] <span class="op">=</span> pd.to_datetime(df[<span class="st">'date'</span>], <span class="bu">format</span><span class="op">=</span><span class="st">'%m/</span><span class="sc">%d</span><span class="st">/%Y'</span>)</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Format the date column as '1970-01-01'</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'date'</span>] <span class="op">=</span> df[<span class="st">'date'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: x.strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>))</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the category column using the US states list</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'category'</span>] <span class="op">=</span> df[<span class="st">'name'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: us_states.index(x))</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Group the data by date, name, and category, and sum the values</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.groupby([<span class="st">'date'</span>, <span class="st">'name'</span>, <span class="st">'category'</span>], as_index<span class="op">=</span><span class="va">False</span>).<span class="bu">sum</span>()</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the index column and reorder the columns</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>df.insert(<span class="dv">0</span>, <span class="st">'index'</span>, <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(df) <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df[[<span class="st">'index'</span>, <span class="st">'date'</span>, <span class="st">'name'</span>, <span class="st">'category'</span>, <span class="st">'value'</span>]]</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Cast the index and name columns to string</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'index'</span>] <span class="op">=</span> df[<span class="st">'index'</span>].astype(<span class="bu">str</span>)</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'name'</span>] <span class="op">=</span> df[<span class="st">'name'</span>].astype(<span class="bu">str</span>)</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the output to a CSV file</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>df.to_csv(<span class="st">'./horizontal/output.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the CSV file</span></span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'output.csv'</span>, <span class="st">'r'</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>    csv_data <span class="op">=</span> <span class="bu">file</span>.read()</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the regex pattern</span></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>pattern <span class="op">=</span> <span class="vs">r'(?&lt;=,)([a-zA-Z ]+)(?=,)'</span></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the replacement string</span></span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>replace_str <span class="op">=</span> <span class="vs">r'"\1"'</span></span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace the matches with the original text enclosed in quotes</span></span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>csv_data <span class="op">=</span> re.sub(pattern, replace_str, csv_data)</span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a><span class="co"># Write the updated CSV file</span></span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'output2.csv'</span>, <span class="st">'w'</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>    <span class="bu">file</span>.write(csv_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>This visualization required significant data cleansing and adjustments to the code, which I didn’t initially expect. I used the <a href="https://github.com/ProfessorPolymorphic/RobisonWebSite/blob/master/BCB520/posts/T8-MidtermExample/Zomstates.csv"><code>Zomstates.csv</code></a> as a reference to modify my csv file. I also employed regular expressions to add quotes around the State names to prevent spaces from causing issues in the code.</p>
<p>Moreover, the visualization didn’t work correctly when copying and pasting from the <a href="https://github.com/ProfessorPolymorphic/RobisonWebSite/blob/master/BCB520/posts/T8-MidtermExample/index.qmd"><code>.qmd</code> file</a>. I made a modification in the function bars(svg) as follows:</p>
<pre><code>    &lt;!-- .attr("x", x(0)) --&gt;
    .attr("x", -6)</code></pre>
<p>The variable x(0) appeared unstable, causing many of the bars’ x-axis positions to shift towards the center of the screen. Only a small portion of the data functioned correctly, starting from the left margin. I’m not entirely sure, but -6 might be related to the margin variable. Without this modification, the bars would start from the middle of the graph.</p>
<p>I also found that the original animation speed was too fast for my data compared to the initial zombie data. I increased the duration tenfold to 250.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6" data-startfrom="222" data-source-offset="-1"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 221;"><span id="cb6-222"><a href="#cb6-222" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> d3<span class="op">.</span><span class="fu">csvParse</span>(<span class="cf">await</span> <span class="fu">FileAttachment</span>(<span class="st">"./horizontal/output2.csv"</span>)<span class="op">.</span><span class="fu">text</span>()<span class="op">,</span> d3<span class="op">.</span><span class="at">autoType</span>)</span>
<span id="cb6-223"><a href="#cb6-223" aria-hidden="true" tabindex="-1"></a>viewof replay <span class="op">=</span> <span class="fu">html</span><span class="vs">`&lt;button&gt;Replay`</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-1-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-1-2" data-nodetype="declaration">

</div>
</div>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7" data-startfrom="228" data-source-offset="-0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 227;"><span id="cb7-228"><a href="#cb7-228" aria-hidden="true" tabindex="-1"></a>chart <span class="op">=</span> {</span>
<span id="cb7-229"><a href="#cb7-229" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-230"><a href="#cb7-230" aria-hidden="true" tabindex="-1"></a>  replay<span class="op">;</span></span>
<span id="cb7-231"><a href="#cb7-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-232"><a href="#cb7-232" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> svg <span class="op">=</span> d3<span class="op">.</span><span class="fu">create</span>(<span class="st">"svg"</span>)</span>
<span id="cb7-233"><a href="#cb7-233" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"viewBox"</span><span class="op">,</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> width<span class="op">,</span> height])<span class="op">;</span></span>
<span id="cb7-234"><a href="#cb7-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-235"><a href="#cb7-235" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> updateBars <span class="op">=</span> <span class="fu">bars</span>(svg)<span class="op">;</span></span>
<span id="cb7-236"><a href="#cb7-236" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> updateAxis <span class="op">=</span> <span class="fu">axis</span>(svg)<span class="op">;</span></span>
<span id="cb7-237"><a href="#cb7-237" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> updateLabels <span class="op">=</span> <span class="fu">labels</span>(svg)<span class="op">;</span></span>
<span id="cb7-238"><a href="#cb7-238" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> updateTicker <span class="op">=</span> <span class="fu">ticker</span>(svg)<span class="op">;</span></span>
<span id="cb7-239"><a href="#cb7-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-240"><a href="#cb7-240" aria-hidden="true" tabindex="-1"></a>  <span class="kw">yield</span> svg<span class="op">.</span><span class="fu">node</span>()<span class="op">;</span></span>
<span id="cb7-241"><a href="#cb7-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-242"><a href="#cb7-242" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">const</span> keyframe <span class="kw">of</span> keyframes) {</span>
<span id="cb7-243"><a href="#cb7-243" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> transition <span class="op">=</span> svg<span class="op">.</span><span class="fu">transition</span>()</span>
<span id="cb7-244"><a href="#cb7-244" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">duration</span>(duration)</span>
<span id="cb7-245"><a href="#cb7-245" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">ease</span>(d3<span class="op">.</span><span class="at">easeLinear</span>)<span class="op">;</span></span>
<span id="cb7-246"><a href="#cb7-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-247"><a href="#cb7-247" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Extract the top bar’s value.</span></span>
<span id="cb7-248"><a href="#cb7-248" aria-hidden="true" tabindex="-1"></a>    x<span class="op">.</span><span class="fu">domain</span>([<span class="dv">0</span><span class="op">,</span> keyframe[<span class="dv">1</span>][<span class="dv">0</span>]<span class="op">.</span><span class="at">value</span>])<span class="op">;</span></span>
<span id="cb7-249"><a href="#cb7-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-250"><a href="#cb7-250" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updateAxis</span>(keyframe<span class="op">,</span> transition)<span class="op">;</span></span>
<span id="cb7-251"><a href="#cb7-251" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updateBars</span>(keyframe<span class="op">,</span> transition)<span class="op">;</span></span>
<span id="cb7-252"><a href="#cb7-252" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updateLabels</span>(keyframe<span class="op">,</span> transition)<span class="op">;</span></span>
<span id="cb7-253"><a href="#cb7-253" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updateTicker</span>(keyframe<span class="op">,</span> transition)<span class="op">;</span></span>
<span id="cb7-254"><a href="#cb7-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-255"><a href="#cb7-255" aria-hidden="true" tabindex="-1"></a>    invalidation<span class="op">.</span><span class="fu">then</span>(() <span class="kw">=&gt;</span> svg<span class="op">.</span><span class="fu">interrupt</span>())<span class="op">;</span></span>
<span id="cb7-256"><a href="#cb7-256" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> transition<span class="op">.</span><span class="fu">end</span>()<span class="op">;</span></span>
<span id="cb7-257"><a href="#cb7-257" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-258"><a href="#cb7-258" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-259"><a href="#cb7-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-260"><a href="#cb7-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-261"><a href="#cb7-261" aria-hidden="true" tabindex="-1"></a>duration <span class="op">=</span> <span class="dv">250</span></span>
<span id="cb7-262"><a href="#cb7-262" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="dv">50</span></span>
<span id="cb7-263"><a href="#cb7-263" aria-hidden="true" tabindex="-1"></a>k <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb7-264"><a href="#cb7-264" aria-hidden="true" tabindex="-1"></a>names <span class="op">=</span> <span class="kw">new</span> <span class="bu">Set</span>(data<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">name</span>))</span>
<span id="cb7-265"><a href="#cb7-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-266"><a href="#cb7-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-267"><a href="#cb7-267" aria-hidden="true" tabindex="-1"></a>datevalues <span class="op">=</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(d3<span class="op">.</span><span class="fu">rollup</span>(data<span class="op">,</span> ([d]) <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">value</span><span class="op">,</span> d <span class="kw">=&gt;</span> <span class="op">+</span>d<span class="op">.</span><span class="at">date</span><span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">name</span>))</span>
<span id="cb7-268"><a href="#cb7-268" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(([date<span class="op">,</span> data]) <span class="kw">=&gt;</span> [<span class="kw">new</span> <span class="bu">Date</span>(date)<span class="op">,</span> data])</span>
<span id="cb7-269"><a href="#cb7-269" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">sort</span>(([a]<span class="op">,</span> [b]) <span class="kw">=&gt;</span> d3<span class="op">.</span><span class="fu">ascending</span>(a<span class="op">,</span> b))</span>
<span id="cb7-270"><a href="#cb7-270" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-271"><a href="#cb7-271" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-272"><a href="#cb7-272" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">rank</span>(value) {</span>
<span id="cb7-273"><a href="#cb7-273" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> data <span class="op">=</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(names<span class="op">,</span> name <span class="kw">=&gt;</span> ({name<span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="fu">value</span>(name)}))<span class="op">;</span></span>
<span id="cb7-274"><a href="#cb7-274" aria-hidden="true" tabindex="-1"></a>  data<span class="op">.</span><span class="fu">sort</span>((a<span class="op">,</span> b) <span class="kw">=&gt;</span> d3<span class="op">.</span><span class="fu">descending</span>(a<span class="op">.</span><span class="at">value</span><span class="op">,</span> b<span class="op">.</span><span class="at">value</span>))<span class="op">;</span></span>
<span id="cb7-275"><a href="#cb7-275" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> data<span class="op">.</span><span class="at">length</span><span class="op">;</span> <span class="op">++</span>i) data[i]<span class="op">.</span><span class="at">rank</span> <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">min</span>(n<span class="op">,</span> i)<span class="op">;</span></span>
<span id="cb7-276"><a href="#cb7-276" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> data<span class="op">;</span></span>
<span id="cb7-277"><a href="#cb7-277" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-278"><a href="#cb7-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-279"><a href="#cb7-279" aria-hidden="true" tabindex="-1"></a>keyframes <span class="op">=</span> {</span>
<span id="cb7-280"><a href="#cb7-280" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> keyframes <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb7-281"><a href="#cb7-281" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> ka<span class="op">,</span> a<span class="op">,</span> kb<span class="op">,</span> b<span class="op">;</span></span>
<span id="cb7-282"><a href="#cb7-282" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> ([[ka<span class="op">,</span> a]<span class="op">,</span> [kb<span class="op">,</span> b]] <span class="kw">of</span> d3<span class="op">.</span><span class="fu">pairs</span>(datevalues)) {</span>
<span id="cb7-283"><a href="#cb7-283" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> k<span class="op">;</span> <span class="op">++</span>i) {</span>
<span id="cb7-284"><a href="#cb7-284" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> t <span class="op">=</span> i <span class="op">/</span> k<span class="op">;</span></span>
<span id="cb7-285"><a href="#cb7-285" aria-hidden="true" tabindex="-1"></a>      keyframes<span class="op">.</span><span class="fu">push</span>([</span>
<span id="cb7-286"><a href="#cb7-286" aria-hidden="true" tabindex="-1"></a>        <span class="kw">new</span> <span class="bu">Date</span>(ka <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> t) <span class="op">+</span> kb <span class="op">*</span> t)<span class="op">,</span></span>
<span id="cb7-287"><a href="#cb7-287" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rank</span>(name <span class="kw">=&gt;</span> (a<span class="op">.</span><span class="fu">get</span>(name) <span class="op">||</span> <span class="dv">0</span>) <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> t) <span class="op">+</span> (b<span class="op">.</span><span class="fu">get</span>(name) <span class="op">||</span> <span class="dv">0</span>) <span class="op">*</span> t)</span>
<span id="cb7-288"><a href="#cb7-288" aria-hidden="true" tabindex="-1"></a>      ])<span class="op">;</span></span>
<span id="cb7-289"><a href="#cb7-289" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-290"><a href="#cb7-290" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-291"><a href="#cb7-291" aria-hidden="true" tabindex="-1"></a>  keyframes<span class="op">.</span><span class="fu">push</span>([<span class="kw">new</span> <span class="bu">Date</span>(kb)<span class="op">,</span> <span class="fu">rank</span>(name <span class="kw">=&gt;</span> b<span class="op">.</span><span class="fu">get</span>(name) <span class="op">||</span> <span class="dv">0</span>)])<span class="op">;</span></span>
<span id="cb7-292"><a href="#cb7-292" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> keyframes<span class="op">;</span></span>
<span id="cb7-293"><a href="#cb7-293" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-294"><a href="#cb7-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-295"><a href="#cb7-295" aria-hidden="true" tabindex="-1"></a>nameframes <span class="op">=</span> d3<span class="op">.</span><span class="fu">groups</span>(keyframes<span class="op">.</span><span class="fu">flatMap</span>(([<span class="op">,</span> data]) <span class="kw">=&gt;</span> data)<span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">name</span>)</span>
<span id="cb7-296"><a href="#cb7-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-297"><a href="#cb7-297" aria-hidden="true" tabindex="-1"></a>prev <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>(nameframes<span class="op">.</span><span class="fu">flatMap</span>(([<span class="op">,</span> data]) <span class="kw">=&gt;</span> d3<span class="op">.</span><span class="fu">pairs</span>(data<span class="op">,</span> (a<span class="op">,</span> b) <span class="kw">=&gt;</span> [b<span class="op">,</span> a])))</span>
<span id="cb7-298"><a href="#cb7-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-299"><a href="#cb7-299" aria-hidden="true" tabindex="-1"></a>next <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>(nameframes<span class="op">.</span><span class="fu">flatMap</span>(([<span class="op">,</span> data]) <span class="kw">=&gt;</span> d3<span class="op">.</span><span class="fu">pairs</span>(data)))</span>
<span id="cb7-300"><a href="#cb7-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-301"><a href="#cb7-301" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">bars</span>(svg) {</span>
<span id="cb7-302"><a href="#cb7-302" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> bar <span class="op">=</span> svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)</span>
<span id="cb7-303"><a href="#cb7-303" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill-opacity"</span><span class="op">,</span> <span class="fl">0.6</span>)</span>
<span id="cb7-304"><a href="#cb7-304" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"rect"</span>)<span class="op">;</span></span>
<span id="cb7-305"><a href="#cb7-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-306"><a href="#cb7-306" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> ([date<span class="op">,</span> data]<span class="op">,</span> transition) <span class="kw">=&gt;</span> bar <span class="op">=</span> bar</span>
<span id="cb7-307"><a href="#cb7-307" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">data</span>(data<span class="op">.</span><span class="fu">slice</span>(<span class="dv">0</span><span class="op">,</span> n)<span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">name</span>)</span>
<span id="cb7-308"><a href="#cb7-308" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">join</span>(</span>
<span id="cb7-309"><a href="#cb7-309" aria-hidden="true" tabindex="-1"></a>      enter <span class="kw">=&gt;</span> enter<span class="op">.</span><span class="fu">append</span>(<span class="st">"rect"</span>)</span>
<span id="cb7-310"><a href="#cb7-310" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill"</span><span class="op">,</span> color)</span>
<span id="cb7-311"><a href="#cb7-311" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"height"</span><span class="op">,</span> y<span class="op">.</span><span class="fu">bandwidth</span>())</span>
<span id="cb7-312"><a href="#cb7-312" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;!--</span> <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> <span class="fu">x</span>(<span class="dv">0</span>)) <span class="op">--&gt;</span></span>
<span id="cb7-313"><a href="#cb7-313" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> <span class="op">-</span><span class="dv">6</span>)</span>
<span id="cb7-314"><a href="#cb7-314" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> d <span class="kw">=&gt;</span> <span class="fu">y</span>((prev<span class="op">.</span><span class="fu">get</span>(d) <span class="op">||</span> d)<span class="op">.</span><span class="at">rank</span>))</span>
<span id="cb7-315"><a href="#cb7-315" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"width"</span><span class="op">,</span> d <span class="kw">=&gt;</span> <span class="fu">x</span>((prev<span class="op">.</span><span class="fu">get</span>(d) <span class="op">||</span> d)<span class="op">.</span><span class="at">value</span>) <span class="op">-</span> <span class="fu">x</span>(<span class="dv">0</span>))<span class="op">,</span></span>
<span id="cb7-316"><a href="#cb7-316" aria-hidden="true" tabindex="-1"></a>      update <span class="kw">=&gt;</span> update<span class="op">,</span></span>
<span id="cb7-317"><a href="#cb7-317" aria-hidden="true" tabindex="-1"></a>      exit <span class="kw">=&gt;</span> exit<span class="op">.</span><span class="fu">transition</span>(transition)<span class="op">.</span><span class="fu">remove</span>()</span>
<span id="cb7-318"><a href="#cb7-318" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> d <span class="kw">=&gt;</span> <span class="fu">y</span>((next<span class="op">.</span><span class="fu">get</span>(d) <span class="op">||</span> d)<span class="op">.</span><span class="at">rank</span>))</span>
<span id="cb7-319"><a href="#cb7-319" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"width"</span><span class="op">,</span> d <span class="kw">=&gt;</span> <span class="fu">x</span>((next<span class="op">.</span><span class="fu">get</span>(d) <span class="op">||</span> d)<span class="op">.</span><span class="at">value</span>) <span class="op">-</span> <span class="fu">x</span>(<span class="dv">0</span>))</span>
<span id="cb7-320"><a href="#cb7-320" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-321"><a href="#cb7-321" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">call</span>(bar <span class="kw">=&gt;</span> bar<span class="op">.</span><span class="fu">transition</span>(transition)</span>
<span id="cb7-322"><a href="#cb7-322" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> d <span class="kw">=&gt;</span> <span class="fu">y</span>(d<span class="op">.</span><span class="at">rank</span>))</span>
<span id="cb7-323"><a href="#cb7-323" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"width"</span><span class="op">,</span> d <span class="kw">=&gt;</span> <span class="fu">x</span>(d<span class="op">.</span><span class="at">value</span>) <span class="op">-</span> <span class="fu">x</span>(<span class="dv">0</span>)))<span class="op">;</span></span>
<span id="cb7-324"><a href="#cb7-324" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-325"><a href="#cb7-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-326"><a href="#cb7-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-327"><a href="#cb7-327" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">labels</span>(svg) {</span>
<span id="cb7-328"><a href="#cb7-328" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> label <span class="op">=</span> svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)</span>
<span id="cb7-329"><a href="#cb7-329" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">style</span>(<span class="st">"font"</span><span class="op">,</span> <span class="st">"bold 12px var(--sans-serif)"</span>)</span>
<span id="cb7-330"><a href="#cb7-330" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">style</span>(<span class="st">"font-variant-numeric"</span><span class="op">,</span> <span class="st">"tabular-nums"</span>)</span>
<span id="cb7-331"><a href="#cb7-331" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"text-anchor"</span><span class="op">,</span> <span class="st">"end"</span>)</span>
<span id="cb7-332"><a href="#cb7-332" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"text"</span>)<span class="op">;</span></span>
<span id="cb7-333"><a href="#cb7-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-334"><a href="#cb7-334" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> ([date<span class="op">,</span> data]<span class="op">,</span> transition) <span class="kw">=&gt;</span> label <span class="op">=</span> label</span>
<span id="cb7-335"><a href="#cb7-335" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">data</span>(data<span class="op">.</span><span class="fu">slice</span>(<span class="dv">0</span><span class="op">,</span> n)<span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">name</span>)</span>
<span id="cb7-336"><a href="#cb7-336" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">join</span>(</span>
<span id="cb7-337"><a href="#cb7-337" aria-hidden="true" tabindex="-1"></a>      enter <span class="kw">=&gt;</span> enter<span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>)</span>
<span id="cb7-338"><a href="#cb7-338" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"transform"</span><span class="op">,</span> d <span class="kw">=&gt;</span> <span class="vs">`translate(</span><span class="sc">${</span><span class="fu">x</span>((prev<span class="op">.</span><span class="fu">get</span>(d) <span class="op">||</span> d)<span class="op">.</span><span class="at">value</span>)<span class="sc">}</span><span class="vs">,</span><span class="sc">${</span><span class="fu">y</span>((prev<span class="op">.</span><span class="fu">get</span>(d) <span class="op">||</span> d)<span class="op">.</span><span class="at">rank</span>)<span class="sc">}</span><span class="vs">)`</span>)</span>
<span id="cb7-339"><a href="#cb7-339" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> y<span class="op">.</span><span class="fu">bandwidth</span>() <span class="op">/</span> <span class="dv">2</span>)</span>
<span id="cb7-340"><a href="#cb7-340" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> <span class="op">-</span><span class="dv">6</span>)</span>
<span id="cb7-341"><a href="#cb7-341" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"dy"</span><span class="op">,</span> <span class="st">"-0.25em"</span>)</span>
<span id="cb7-342"><a href="#cb7-342" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">text</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">name</span>)</span>
<span id="cb7-343"><a href="#cb7-343" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">call</span>(text <span class="kw">=&gt;</span> text<span class="op">.</span><span class="fu">append</span>(<span class="st">"tspan"</span>)</span>
<span id="cb7-344"><a href="#cb7-344" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill-opacity"</span><span class="op">,</span> <span class="fl">0.7</span>)</span>
<span id="cb7-345"><a href="#cb7-345" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">attr</span>(<span class="st">"font-weight"</span><span class="op">,</span> <span class="st">"normal"</span>)</span>
<span id="cb7-346"><a href="#cb7-346" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> <span class="op">-</span><span class="dv">6</span>)</span>
<span id="cb7-347"><a href="#cb7-347" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">attr</span>(<span class="st">"dy"</span><span class="op">,</span> <span class="st">"1.15em"</span>))<span class="op">,</span></span>
<span id="cb7-348"><a href="#cb7-348" aria-hidden="true" tabindex="-1"></a>      update <span class="kw">=&gt;</span> update<span class="op">,</span></span>
<span id="cb7-349"><a href="#cb7-349" aria-hidden="true" tabindex="-1"></a>      exit <span class="kw">=&gt;</span> exit<span class="op">.</span><span class="fu">transition</span>(transition)<span class="op">.</span><span class="fu">remove</span>()</span>
<span id="cb7-350"><a href="#cb7-350" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"transform"</span><span class="op">,</span> d <span class="kw">=&gt;</span> <span class="vs">`translate(</span><span class="sc">${</span><span class="fu">x</span>((next<span class="op">.</span><span class="fu">get</span>(d) <span class="op">||</span> d)<span class="op">.</span><span class="at">value</span>)<span class="sc">}</span><span class="vs">,</span><span class="sc">${</span><span class="fu">y</span>((next<span class="op">.</span><span class="fu">get</span>(d) <span class="op">||</span> d)<span class="op">.</span><span class="at">rank</span>)<span class="sc">}</span><span class="vs">)`</span>)</span>
<span id="cb7-351"><a href="#cb7-351" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">call</span>(g <span class="kw">=&gt;</span> g<span class="op">.</span><span class="fu">select</span>(<span class="st">"tspan"</span>)<span class="op">.</span><span class="fu">tween</span>(<span class="st">"text"</span><span class="op">,</span> d <span class="kw">=&gt;</span> <span class="fu">textTween</span>(d<span class="op">.</span><span class="at">value</span><span class="op">,</span> (next<span class="op">.</span><span class="fu">get</span>(d) <span class="op">||</span> d)<span class="op">.</span><span class="at">value</span>)))</span>
<span id="cb7-352"><a href="#cb7-352" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-353"><a href="#cb7-353" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">call</span>(bar <span class="kw">=&gt;</span> bar<span class="op">.</span><span class="fu">transition</span>(transition)</span>
<span id="cb7-354"><a href="#cb7-354" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"transform"</span><span class="op">,</span> d <span class="kw">=&gt;</span> <span class="vs">`translate(</span><span class="sc">${</span><span class="fu">x</span>(d<span class="op">.</span><span class="at">value</span>)<span class="sc">}</span><span class="vs">,</span><span class="sc">${</span><span class="fu">y</span>(d<span class="op">.</span><span class="at">rank</span>)<span class="sc">}</span><span class="vs">)`</span>)</span>
<span id="cb7-355"><a href="#cb7-355" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">call</span>(g <span class="kw">=&gt;</span> g<span class="op">.</span><span class="fu">select</span>(<span class="st">"tspan"</span>)<span class="op">.</span><span class="fu">tween</span>(<span class="st">"text"</span><span class="op">,</span> d <span class="kw">=&gt;</span> <span class="fu">textTween</span>((prev<span class="op">.</span><span class="fu">get</span>(d) <span class="op">||</span> d)<span class="op">.</span><span class="at">value</span><span class="op">,</span> d<span class="op">.</span><span class="at">value</span>))))</span>
<span id="cb7-356"><a href="#cb7-356" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-357"><a href="#cb7-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-358"><a href="#cb7-358" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">textTween</span>(a<span class="op">,</span> b) {</span>
<span id="cb7-359"><a href="#cb7-359" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> i <span class="op">=</span> d3<span class="op">.</span><span class="fu">interpolateNumber</span>(a<span class="op">,</span> b)<span class="op">;</span></span>
<span id="cb7-360"><a href="#cb7-360" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="kw">function</span>(t) {</span>
<span id="cb7-361"><a href="#cb7-361" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> <span class="fu">formatNumber</span>(<span class="fu">i</span>(t))<span class="op">;</span></span>
<span id="cb7-362"><a href="#cb7-362" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb7-363"><a href="#cb7-363" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-364"><a href="#cb7-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-365"><a href="#cb7-365" aria-hidden="true" tabindex="-1"></a>formatNumber <span class="op">=</span> d3<span class="op">.</span><span class="fu">format</span>(<span class="st">",d"</span>)</span>
<span id="cb7-366"><a href="#cb7-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-367"><a href="#cb7-367" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">axis</span>(svg) {</span>
<span id="cb7-368"><a href="#cb7-368" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> g <span class="op">=</span> svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)</span>
<span id="cb7-369"><a href="#cb7-369" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"transform"</span><span class="op">,</span> <span class="vs">`translate(0,</span><span class="sc">${</span>margin<span class="op">.</span><span class="at">top</span><span class="sc">}</span><span class="vs">)`</span>)<span class="op">;</span></span>
<span id="cb7-370"><a href="#cb7-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-371"><a href="#cb7-371" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> axis <span class="op">=</span> d3<span class="op">.</span><span class="fu">axisTop</span>(x)</span>
<span id="cb7-372"><a href="#cb7-372" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">ticks</span>(width <span class="op">/</span> <span class="dv">160</span>)</span>
<span id="cb7-373"><a href="#cb7-373" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">tickSizeOuter</span>(<span class="dv">0</span>)</span>
<span id="cb7-374"><a href="#cb7-374" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">tickSizeInner</span>(<span class="op">-</span>barSize <span class="op">*</span> (n <span class="op">+</span> y<span class="op">.</span><span class="fu">padding</span>()))<span class="op">;</span></span>
<span id="cb7-375"><a href="#cb7-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-376"><a href="#cb7-376" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> (_<span class="op">,</span> transition) <span class="kw">=&gt;</span> {</span>
<span id="cb7-377"><a href="#cb7-377" aria-hidden="true" tabindex="-1"></a>    g<span class="op">.</span><span class="fu">transition</span>(transition)<span class="op">.</span><span class="fu">call</span>(axis)<span class="op">;</span></span>
<span id="cb7-378"><a href="#cb7-378" aria-hidden="true" tabindex="-1"></a>    g<span class="op">.</span><span class="fu">select</span>(<span class="st">".tick:first-of-type text"</span>)<span class="op">.</span><span class="fu">remove</span>()<span class="op">;</span></span>
<span id="cb7-379"><a href="#cb7-379" aria-hidden="true" tabindex="-1"></a>    g<span class="op">.</span><span class="fu">selectAll</span>(<span class="st">".tick:not(:first-of-type) line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke"</span><span class="op">,</span> <span class="st">"white"</span>)<span class="op">;</span></span>
<span id="cb7-380"><a href="#cb7-380" aria-hidden="true" tabindex="-1"></a>    g<span class="op">.</span><span class="fu">select</span>(<span class="st">".domain"</span>)<span class="op">.</span><span class="fu">remove</span>()<span class="op">;</span></span>
<span id="cb7-381"><a href="#cb7-381" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb7-382"><a href="#cb7-382" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-383"><a href="#cb7-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-384"><a href="#cb7-384" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">ticker</span>(svg) {</span>
<span id="cb7-385"><a href="#cb7-385" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> now <span class="op">=</span> svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>)</span>
<span id="cb7-386"><a href="#cb7-386" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">style</span>(<span class="st">"font"</span><span class="op">,</span> <span class="vs">`bold </span><span class="sc">${</span>barSize<span class="sc">}</span><span class="vs">px var(--sans-serif)`</span>)</span>
<span id="cb7-387"><a href="#cb7-387" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">style</span>(<span class="st">"font-variant-numeric"</span><span class="op">,</span> <span class="st">"tabular-nums"</span>)</span>
<span id="cb7-388"><a href="#cb7-388" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"text-anchor"</span><span class="op">,</span> <span class="st">"end"</span>)</span>
<span id="cb7-389"><a href="#cb7-389" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> width <span class="op">-</span> <span class="dv">6</span>)</span>
<span id="cb7-390"><a href="#cb7-390" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> margin<span class="op">.</span><span class="at">top</span> <span class="op">+</span> barSize <span class="op">*</span> (n <span class="op">-</span> <span class="fl">0.45</span>))</span>
<span id="cb7-391"><a href="#cb7-391" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"dy"</span><span class="op">,</span> <span class="st">"0.32em"</span>)</span>
<span id="cb7-392"><a href="#cb7-392" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">text</span>(<span class="fu">formatDate</span>(keyframes[<span class="dv">0</span>][<span class="dv">0</span>]))<span class="op">;</span></span>
<span id="cb7-393"><a href="#cb7-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-394"><a href="#cb7-394" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> ([date]<span class="op">,</span> transition) <span class="kw">=&gt;</span> {</span>
<span id="cb7-395"><a href="#cb7-395" aria-hidden="true" tabindex="-1"></a>    transition<span class="op">.</span><span class="fu">end</span>()<span class="op">.</span><span class="fu">then</span>(() <span class="kw">=&gt;</span> now<span class="op">.</span><span class="fu">text</span>(<span class="fu">formatDate</span>(date)))<span class="op">;</span></span>
<span id="cb7-396"><a href="#cb7-396" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb7-397"><a href="#cb7-397" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-398"><a href="#cb7-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-399"><a href="#cb7-399" aria-hidden="true" tabindex="-1"></a>formatDate <span class="op">=</span> d3<span class="op">.</span><span class="fu">utcFormat</span>(<span class="st">"%Y"</span>)</span>
<span id="cb7-400"><a href="#cb7-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-401"><a href="#cb7-401" aria-hidden="true" tabindex="-1"></a>color <span class="op">=</span> {</span>
<span id="cb7-402"><a href="#cb7-402" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> scale <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleSequential</span>(d3<span class="op">.</span><span class="fu">interpolate</span>(<span class="st">"red"</span><span class="op">,</span> <span class="st">"blue"</span>))<span class="op">.</span><span class="fu">domain</span>([<span class="dv">1</span><span class="op">,</span> <span class="dv">48</span>])<span class="op">;</span></span>
<span id="cb7-403"><a href="#cb7-403" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (data<span class="op">.</span><span class="fu">some</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">category</span> <span class="op">!==</span> <span class="kw">undefined</span>)) {</span>
<span id="cb7-404"><a href="#cb7-404" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> categoryByName <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>(data<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> [d<span class="op">.</span><span class="at">name</span><span class="op">,</span> d<span class="op">.</span><span class="at">category</span>]))</span>
<span id="cb7-405"><a href="#cb7-405" aria-hidden="true" tabindex="-1"></a>    scale<span class="op">.</span><span class="fu">domain</span>(<span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(categoryByName<span class="op">.</span><span class="fu">values</span>()))<span class="op">;</span></span>
<span id="cb7-406"><a href="#cb7-406" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> d <span class="kw">=&gt;</span> <span class="fu">scale</span>(categoryByName<span class="op">.</span><span class="fu">get</span>(d<span class="op">.</span><span class="at">name</span>))<span class="op">;</span></span>
<span id="cb7-407"><a href="#cb7-407" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-408"><a href="#cb7-408" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> d <span class="kw">=&gt;</span> <span class="fu">scale</span>(d<span class="op">.</span><span class="at">name</span>)<span class="op">;</span></span>
<span id="cb7-409"><a href="#cb7-409" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-410"><a href="#cb7-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-411"><a href="#cb7-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-412"><a href="#cb7-412" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;!--</span> color <span class="op">=</span> { <span class="op">--&gt;</span></span>
<span id="cb7-413"><a href="#cb7-413" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;!--</span>   <span class="kw">const</span> scale <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleSequential</span>(d3<span class="op">.</span><span class="fu">interpolate</span>(<span class="st">"red"</span><span class="op">,</span> <span class="st">"blue"</span>))<span class="op">.</span><span class="fu">domain</span>([<span class="dv">1</span><span class="op">,</span> <span class="dv">48</span>])<span class="op">;</span> <span class="op">--&gt;</span></span>
<span id="cb7-414"><a href="#cb7-414" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;!--</span>   <span class="cf">if</span> (data<span class="op">.</span><span class="fu">some</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">category</span> <span class="op">!==</span> <span class="kw">undefined</span>)) { <span class="op">--&gt;</span></span>
<span id="cb7-415"><a href="#cb7-415" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;!--</span>     <span class="kw">const</span> categoryByName <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>(data<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> [d<span class="op">.</span><span class="at">name</span><span class="op">,</span> d<span class="op">.</span><span class="at">category</span>]))<span class="op">;</span> <span class="op">--&gt;</span></span>
<span id="cb7-416"><a href="#cb7-416" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;!--</span>     <span class="kw">const</span> categories <span class="op">=</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(categoryByName<span class="op">.</span><span class="fu">values</span>())<span class="op">.</span><span class="fu">filter</span>((d<span class="op">,</span> i<span class="op">,</span> arr) <span class="kw">=&gt;</span> arr<span class="op">.</span><span class="fu">indexOf</span>(d) <span class="op">===</span> i)<span class="op">;</span> <span class="op">--&gt;</span></span>
<span id="cb7-417"><a href="#cb7-417" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;!--</span>     <span class="kw">const</span> scaleByCategory <span class="op">=</span> <span class="kw">typeof</span> categories[<span class="dv">0</span>] <span class="op">===</span> <span class="st">"number"</span> <span class="op">?</span>  <span class="op">--&gt;</span></span>
<span id="cb7-418"><a href="#cb7-418" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;!--</span>       d3<span class="op">.</span><span class="fu">scaleSequential</span>(d3<span class="op">.</span><span class="at">interpolateSpectral</span>)<span class="op">.</span><span class="fu">domain</span>(d3<span class="op">.</span><span class="fu">extent</span>(categories)) <span class="op">:</span> <span class="op">--&gt;</span></span>
<span id="cb7-419"><a href="#cb7-419" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;!--</span>       d3<span class="op">.</span><span class="fu">scaleOrdinal</span>()<span class="op">.</span><span class="fu">domain</span>(categories)<span class="op">.</span><span class="fu">range</span>(d3<span class="op">.</span><span class="fu">quantize</span>(d3<span class="op">.</span><span class="at">interpolateSpectral</span><span class="op">,</span> categories<span class="op">.</span><span class="at">length</span>))<span class="op">;</span> <span class="op">--&gt;</span></span>
<span id="cb7-420"><a href="#cb7-420" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;!--</span>     <span class="cf">return</span> d <span class="kw">=&gt;</span> <span class="fu">scale</span>(<span class="fu">scaleByCategory</span>(categoryByName<span class="op">.</span><span class="fu">get</span>(d<span class="op">.</span><span class="at">name</span>)))<span class="op">;</span> <span class="op">--&gt;</span></span>
<span id="cb7-421"><a href="#cb7-421" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;!--</span>   } <span class="op">--&gt;</span></span>
<span id="cb7-422"><a href="#cb7-422" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;!--</span>   <span class="cf">return</span> (d<span class="op">,</span> i) <span class="kw">=&gt;</span> <span class="fu">scale</span>(i)<span class="op">;</span> <span class="op">--&gt;</span></span>
<span id="cb7-423"><a href="#cb7-423" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;!--</span> } <span class="op">--&gt;</span></span>
<span id="cb7-424"><a href="#cb7-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-425"><a href="#cb7-425" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;!--</span> x <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleLinear</span>([<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span>]<span class="op">,</span> [margin<span class="op">.</span><span class="at">left</span><span class="op">,</span> width <span class="op">-</span> margin<span class="op">.</span><span class="at">right</span>]) <span class="op">--&gt;</span></span>
<span id="cb7-426"><a href="#cb7-426" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleLinear</span>([<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span>]<span class="op">,</span> [margin<span class="op">.</span><span class="at">left</span><span class="op">,</span>  width <span class="op">-</span> margin<span class="op">.</span><span class="at">right</span>])</span>
<span id="cb7-427"><a href="#cb7-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-428"><a href="#cb7-428" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleBand</span>()</span>
<span id="cb7-429"><a href="#cb7-429" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">domain</span>(d3<span class="op">.</span><span class="fu">range</span>(n <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb7-430"><a href="#cb7-430" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">rangeRound</span>([margin<span class="op">.</span><span class="at">top</span><span class="op">,</span> margin<span class="op">.</span><span class="at">top</span> <span class="op">+</span> barSize <span class="op">*</span> (n <span class="op">+</span> <span class="dv">1</span> <span class="op">+</span> <span class="fl">0.1</span>)])</span>
<span id="cb7-431"><a href="#cb7-431" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">padding</span>(<span class="fl">0.1</span>)</span>
<span id="cb7-432"><a href="#cb7-432" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-433"><a href="#cb7-433" aria-hidden="true" tabindex="-1"></a>height <span class="op">=</span> margin<span class="op">.</span><span class="at">top</span> <span class="op">+</span> barSize <span class="op">*</span> n <span class="op">+</span> margin<span class="op">.</span><span class="at">bottom</span></span>
<span id="cb7-434"><a href="#cb7-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-435"><a href="#cb7-435" aria-hidden="true" tabindex="-1"></a>barSize <span class="op">=</span> <span class="dv">48</span></span>
<span id="cb7-436"><a href="#cb7-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-437"><a href="#cb7-437" aria-hidden="true" tabindex="-1"></a>margin <span class="op">=</span> ({<span class="dt">top</span><span class="op">:</span> <span class="dv">16</span><span class="op">,</span> <span class="dt">right</span><span class="op">:</span> <span class="dv">6</span><span class="op">,</span> <span class="dt">bottom</span><span class="op">:</span> <span class="dv">6</span><span class="op">,</span> <span class="dt">left</span><span class="op">:</span> <span class="dv">0</span>})</span>
<span id="cb7-438"><a href="#cb7-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-439"><a href="#cb7-439" aria-hidden="true" tabindex="-1"></a>d3 <span class="op">=</span> <span class="pp">require</span>(<span class="st">"d3@6"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-2-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-2-2" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-2-3" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-2-4" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-2-5" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-2-6" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-2-7" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-2-8" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-2-9" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-2-10" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-2-11" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-2-12" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-2-13" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-2-14" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-2-15" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-2-16" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-2-17" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-2-18" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-2-19" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-2-20" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-2-21" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-2-22" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-2-23" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-2-24" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-2-25" data-nodetype="declaration">

</div>
</div>
</div>
</div>
<p>This visualization presents the dynamic monthly changes in COVID-19 death cases from 2020 to 2023 in each state across the United States. By showcasing the data in a ranked format, it provides an intuitive way to understand the shifts in state rankings as the pandemic progressed. This visualization helps to identify states with the highest death tolls at different points in time.</p>
</section>
<section id="interactive-network-chart-for-ages-and-conditions" class="level2">
<h2 class="anchored" data-anchor-id="interactive-network-chart-for-ages-and-conditions">Interactive Network Chart for Ages and Conditions</h2>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> csv</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Read in the CSV file</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">"./net/filtered_by_total.csv"</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(filename, <span class="st">"r"</span>) <span class="im">as</span> csvfile:</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    reader <span class="op">=</span> csv.DictReader(csvfile)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    rows <span class="op">=</span> [row <span class="cf">for</span> row <span class="kw">in</span> reader <span class="cf">if</span> row[<span class="st">"State"</span>] <span class="op">==</span> <span class="st">"United States"</span>]</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Create nodes dictionary</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>age_groups <span class="op">=</span> <span class="bu">list</span>(<span class="bu">set</span>(row[<span class="st">"Age Group"</span>] <span class="cf">for</span> row <span class="kw">in</span> rows))</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>condition_groups <span class="op">=</span> <span class="bu">list</span>(<span class="bu">set</span>(row[<span class="st">"Condition Group"</span>] <span class="cf">for</span> row <span class="kw">in</span> rows))</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>nodes <span class="op">=</span> [{<span class="st">"id"</span>: group, <span class="st">"group"</span>: i} <span class="cf">for</span> i, group <span class="kw">in</span> <span class="bu">enumerate</span>(age_groups <span class="op">+</span> condition_groups)]</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Create links dictionary</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>max_value <span class="op">=</span> <span class="bu">max</span>(<span class="bu">int</span>(row[<span class="st">"COVID-19 Deaths"</span>]) <span class="cf">for</span> row <span class="kw">in</span> rows)</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>min_value <span class="op">=</span> <span class="bu">min</span>(<span class="bu">int</span>(row[<span class="st">"COVID-19 Deaths"</span>]) <span class="cf">for</span> row <span class="kw">in</span> rows)</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>links <span class="op">=</span> [{<span class="st">"source"</span>: row[<span class="st">"Age Group"</span>], <span class="st">"target"</span>: row[<span class="st">"Condition Group"</span>], <span class="st">"value"</span>: (<span class="bu">int</span>(row[<span class="st">"COVID-19 Deaths"</span>]) <span class="op">-</span> min_value) <span class="op">/</span> (max_value <span class="op">-</span> min_value) <span class="op">*</span> <span class="dv">100</span>} <span class="cf">for</span> row <span class="kw">in</span> rows]</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine nodes and links into a single dictionary</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>network <span class="op">=</span> {<span class="st">"nodes"</span>: nodes, <span class="st">"links"</span>: links}</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Write to a JSON file</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">"./net/network.json"</span>, <span class="st">"w"</span>) <span class="im">as</span> outfile:</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    json.dump(network, outfile, indent<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the JSON data</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'./net/network.json'</span>, <span class="st">'r'</span>) <span class="im">as</span> f:</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> json.load(f)</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a dictionary to store the max values for each source</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>max_values <span class="op">=</span> {}</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through the links to find the max value for each source</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> link <span class="kw">in</span> data[<span class="st">'links'</span>]:</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>    source <span class="op">=</span> link[<span class="st">'source'</span>]</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>    value <span class="op">=</span> link[<span class="st">'value'</span>]</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> source <span class="kw">in</span> max_values:</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>        max_values[source].append(value)</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>        max_values[source] <span class="op">=</span> [value]</span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through the links again to filter out those with values less than the top 3</span></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>filtered_links <span class="op">=</span> []</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> link <span class="kw">in</span> data[<span class="st">'links'</span>]:</span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>    source <span class="op">=</span> link[<span class="st">'source'</span>]</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>    value <span class="op">=</span> link[<span class="st">'value'</span>]</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(max_values[source]) <span class="op">&gt;</span> <span class="dv">3</span> <span class="kw">and</span> value <span class="op">&lt;</span> <span class="bu">sorted</span>(max_values[source], reverse<span class="op">=</span><span class="va">True</span>)[<span class="dv">2</span>]:</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>    filtered_links.append(link)</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a new dictionary with the filtered links</span></span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>filtered_data <span class="op">=</span> {</span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>    <span class="st">'nodes'</span>: data[<span class="st">'nodes'</span>],</span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>    <span class="st">'links'</span>: filtered_links</span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the filtered data to a new JSON file</span></span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'./net/filtered_network.json'</span>, <span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a>    json.dump(filtered_data, f, indent<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'./net/filtered_network.json'</span>) <span class="im">as</span> f:</span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> json.load(f)</span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>nodes <span class="op">=</span> []</span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a>new_links <span class="op">=</span> []</span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a>sources <span class="op">=</span> <span class="bu">set</span>([link[<span class="st">'source'</span>] <span class="cf">for</span> link <span class="kw">in</span> data[<span class="st">'links'</span>]])</span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a>targets <span class="op">=</span> <span class="bu">set</span>([link[<span class="st">'target'</span>] <span class="cf">for</span> link <span class="kw">in</span> data[<span class="st">'links'</span>]])</span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> node <span class="kw">in</span> sources.union(targets):</span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> node <span class="kw">in</span> sources:</span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a>        nodes.append({<span class="st">"id"</span>: node, <span class="st">"group"</span>: <span class="dv">0</span>})</span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> source <span class="kw">in</span> sources:</span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a>            new_node_id <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>node<span class="sc">}</span><span class="ss">(</span><span class="sc">{</span>source<span class="sc">}</span><span class="ss">)"</span></span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a>            nodes.append({<span class="st">"id"</span>: new_node_id, <span class="st">"group"</span>: <span class="dv">1</span>})</span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> link <span class="kw">in</span> data[<span class="st">'links'</span>]:</span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> link[<span class="st">'source'</span>] <span class="op">==</span> source <span class="kw">and</span> link[<span class="st">'target'</span>] <span class="op">==</span> node:</span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a>                    new_links.append({<span class="st">"source"</span>: source, <span class="st">"target"</span>: new_node_id, <span class="st">"value"</span>: link[<span class="st">'value'</span>]})</span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a>new_data <span class="op">=</span> {<span class="st">"nodes"</span>: nodes, <span class="st">"links"</span>: new_links}</span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'./net/new_filtered_network.json'</span>, <span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a>    json.dump(new_data, f, indent<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the JSON file</span></span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">"./net/new_filtered_network.json"</span>) <span class="im">as</span> f:</span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> json.load(f)</span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-90"><a href="#cb8-90" aria-hidden="true" tabindex="-1"></a><span class="co"># Find all nodes in group 0</span></span>
<span id="cb8-91"><a href="#cb8-91" aria-hidden="true" tabindex="-1"></a>group0_nodes <span class="op">=</span> [node <span class="cf">for</span> node <span class="kw">in</span> data[<span class="st">'nodes'</span>] <span class="cf">if</span> node[<span class="st">'group'</span>] <span class="op">==</span> <span class="dv">0</span>]</span>
<span id="cb8-92"><a href="#cb8-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-93"><a href="#cb8-93" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a center node</span></span>
<span id="cb8-94"><a href="#cb8-94" aria-hidden="true" tabindex="-1"></a>center_node <span class="op">=</span> {<span class="st">'id'</span>: <span class="st">'center'</span>, <span class="st">'group'</span>: <span class="op">-</span><span class="dv">1</span>}</span>
<span id="cb8-95"><a href="#cb8-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-96"><a href="#cb8-96" aria-hidden="true" tabindex="-1"></a><span class="co"># Add links from center node to all group 0 nodes</span></span>
<span id="cb8-97"><a href="#cb8-97" aria-hidden="true" tabindex="-1"></a>links <span class="op">=</span> data[<span class="st">'links'</span>]</span>
<span id="cb8-98"><a href="#cb8-98" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> node <span class="kw">in</span> group0_nodes:</span>
<span id="cb8-99"><a href="#cb8-99" aria-hidden="true" tabindex="-1"></a>    links.append({<span class="st">'source'</span>: <span class="st">'center'</span>, <span class="st">'target'</span>: node[<span class="st">'id'</span>], <span class="st">'value'</span>: <span class="dv">1</span>})</span>
<span id="cb8-100"><a href="#cb8-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-101"><a href="#cb8-101" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the center node to the nodes list</span></span>
<span id="cb8-102"><a href="#cb8-102" aria-hidden="true" tabindex="-1"></a>nodes <span class="op">=</span> data[<span class="st">'nodes'</span>]</span>
<span id="cb8-103"><a href="#cb8-103" aria-hidden="true" tabindex="-1"></a>nodes.append(center_node)</span>
<span id="cb8-104"><a href="#cb8-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-105"><a href="#cb8-105" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the modified data as a new JSON file</span></span>
<span id="cb8-106"><a href="#cb8-106" aria-hidden="true" tabindex="-1"></a>new_data <span class="op">=</span> {<span class="st">'nodes'</span>: nodes, <span class="st">'links'</span>: links}</span>
<span id="cb8-107"><a href="#cb8-107" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">"./net/new_filtered_network_with_center.json"</span>, <span class="st">"w"</span>) <span class="im">as</span> f:</span>
<span id="cb8-108"><a href="#cb8-108" aria-hidden="true" tabindex="-1"></a>    json.dump(new_data, f)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>This visualization necessitated substantial data cleansing efforts, such as generating node and link JSON files and trimming extraneous links to display only the top 3 relevant connections. Since the network visualization does not account for directional connections, it can create cross-linked nodes, resulting in a nested graph. To achieve a more visually explicit appearance, I manually duplicated the node of conditions. Furthermore, the nodes tend to gradually fade away from the screen, so incorporating a central node is essential to maintain their positions within the visualization.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9" data-startfrom="564" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 563;"><span id="cb9-564"><a href="#cb9-564" aria-hidden="true" tabindex="-1"></a>chart2 <span class="op">=</span> <span class="fu">ForceGraph</span>(miserables<span class="op">,</span> {</span>
<span id="cb9-565"><a href="#cb9-565" aria-hidden="true" tabindex="-1"></a>  <span class="dt">nodeId</span><span class="op">:</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">id</span><span class="op">,</span></span>
<span id="cb9-566"><a href="#cb9-566" aria-hidden="true" tabindex="-1"></a>  <span class="dt">nodeGroup</span><span class="op">:</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">group</span><span class="op">,</span></span>
<span id="cb9-567"><a href="#cb9-567" aria-hidden="true" tabindex="-1"></a>  <span class="dt">nodeTitle</span><span class="op">:</span> d <span class="kw">=&gt;</span> <span class="vs">`</span><span class="sc">${</span>d<span class="op">.</span><span class="at">id</span><span class="sc">}\n${</span>d<span class="op">.</span><span class="at">group</span><span class="sc">}</span><span class="vs">`</span><span class="op">,</span></span>
<span id="cb9-568"><a href="#cb9-568" aria-hidden="true" tabindex="-1"></a>  <span class="dt">linkStrokeWidth</span><span class="op">:</span> l <span class="kw">=&gt;</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">sqrt</span>(l<span class="op">.</span><span class="at">value</span>)<span class="op">,</span></span>
<span id="cb9-569"><a href="#cb9-569" aria-hidden="true" tabindex="-1"></a>  width<span class="op">,</span></span>
<span id="cb9-570"><a href="#cb9-570" aria-hidden="true" tabindex="-1"></a>  <span class="dt">height</span><span class="op">:</span> <span class="dv">600</span><span class="op">,</span></span>
<span id="cb9-571"><a href="#cb9-571" aria-hidden="true" tabindex="-1"></a>  invalidation <span class="co">// a promise to stop the simulation when the cell is re-run</span></span>
<span id="cb9-572"><a href="#cb9-572" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="ojs-cell-3" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10" data-startfrom="577" data-source-offset="-0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 576;"><span id="cb10-577"><a href="#cb10-577" aria-hidden="true" tabindex="-1"></a>miserables <span class="op">=</span> <span class="fu">FileAttachment</span>(<span class="st">"./net/new_filtered_network_with_center.json"</span>)<span class="op">.</span><span class="fu">json</span>()</span>
<span id="cb10-578"><a href="#cb10-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-579"><a href="#cb10-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-580"><a href="#cb10-580" aria-hidden="true" tabindex="-1"></a><span class="co">// Copyright 2021 Observable, Inc.</span></span>
<span id="cb10-581"><a href="#cb10-581" aria-hidden="true" tabindex="-1"></a><span class="co">// Released under the ISC license.</span></span>
<span id="cb10-582"><a href="#cb10-582" aria-hidden="true" tabindex="-1"></a><span class="co">// https://observablehq.com/@d3/force-directed-graph</span></span>
<span id="cb10-583"><a href="#cb10-583" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">ForceGraph</span>({</span>
<span id="cb10-584"><a href="#cb10-584" aria-hidden="true" tabindex="-1"></a>  nodes<span class="op">,</span> <span class="co">// an iterable of node objects (typically [{id}, …])</span></span>
<span id="cb10-585"><a href="#cb10-585" aria-hidden="true" tabindex="-1"></a>  links <span class="co">// an iterable of link objects (typically [{source, target}, …])</span></span>
<span id="cb10-586"><a href="#cb10-586" aria-hidden="true" tabindex="-1"></a>}<span class="op">,</span> {</span>
<span id="cb10-587"><a href="#cb10-587" aria-hidden="true" tabindex="-1"></a>  nodeId <span class="op">=</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">id</span><span class="op">,</span> <span class="co">// given d in nodes, returns a unique identifier (string)</span></span>
<span id="cb10-588"><a href="#cb10-588" aria-hidden="true" tabindex="-1"></a>  nodeGroup<span class="op">,</span> <span class="co">// given d in nodes, returns an (ordinal) value for color</span></span>
<span id="cb10-589"><a href="#cb10-589" aria-hidden="true" tabindex="-1"></a>  nodeGroups<span class="op">,</span> <span class="co">// an array of ordinal values representing the node groups</span></span>
<span id="cb10-590"><a href="#cb10-590" aria-hidden="true" tabindex="-1"></a>  nodeTitle<span class="op">,</span> <span class="co">// given d in nodes, a title string</span></span>
<span id="cb10-591"><a href="#cb10-591" aria-hidden="true" tabindex="-1"></a>  nodeFill <span class="op">=</span> <span class="st">"currentColor"</span><span class="op">,</span> <span class="co">// node stroke fill (if not using a group color encoding)</span></span>
<span id="cb10-592"><a href="#cb10-592" aria-hidden="true" tabindex="-1"></a>  nodeStroke <span class="op">=</span> <span class="st">"#fff"</span><span class="op">,</span> <span class="co">// node stroke color</span></span>
<span id="cb10-593"><a href="#cb10-593" aria-hidden="true" tabindex="-1"></a>  nodeStrokeWidth <span class="op">=</span> <span class="fl">1.5</span><span class="op">,</span> <span class="co">// node stroke width, in pixels</span></span>
<span id="cb10-594"><a href="#cb10-594" aria-hidden="true" tabindex="-1"></a>  nodeStrokeOpacity <span class="op">=</span> <span class="dv">1</span><span class="op">,</span> <span class="co">// node stroke opacity</span></span>
<span id="cb10-595"><a href="#cb10-595" aria-hidden="true" tabindex="-1"></a>  nodeRadius <span class="op">=</span> <span class="dv">5</span><span class="op">,</span> <span class="co">// node radius, in pixels</span></span>
<span id="cb10-596"><a href="#cb10-596" aria-hidden="true" tabindex="-1"></a>  nodeStrength<span class="op">,</span></span>
<span id="cb10-597"><a href="#cb10-597" aria-hidden="true" tabindex="-1"></a>  linkSource <span class="op">=</span> ({source}) <span class="kw">=&gt;</span> source<span class="op">,</span> <span class="co">// given d in links, returns a node identifier string</span></span>
<span id="cb10-598"><a href="#cb10-598" aria-hidden="true" tabindex="-1"></a>  linkTarget <span class="op">=</span> ({target}) <span class="kw">=&gt;</span> target<span class="op">,</span> <span class="co">// given d in links, returns a node identifier string</span></span>
<span id="cb10-599"><a href="#cb10-599" aria-hidden="true" tabindex="-1"></a>  linkStroke <span class="op">=</span> <span class="st">"#999"</span><span class="op">,</span> <span class="co">// link stroke color</span></span>
<span id="cb10-600"><a href="#cb10-600" aria-hidden="true" tabindex="-1"></a>  linkStrokeOpacity <span class="op">=</span> <span class="fl">0.6</span><span class="op">,</span> <span class="co">// link stroke opacity</span></span>
<span id="cb10-601"><a href="#cb10-601" aria-hidden="true" tabindex="-1"></a>  linkStrokeWidth <span class="op">=</span> <span class="fl">1.5</span><span class="op">,</span> <span class="co">// given d in links, returns a stroke width in pixels</span></span>
<span id="cb10-602"><a href="#cb10-602" aria-hidden="true" tabindex="-1"></a>  linkStrokeLinecap <span class="op">=</span> <span class="st">"round"</span><span class="op">,</span> <span class="co">// link stroke linecap</span></span>
<span id="cb10-603"><a href="#cb10-603" aria-hidden="true" tabindex="-1"></a>  linkStrength<span class="op">,</span></span>
<span id="cb10-604"><a href="#cb10-604" aria-hidden="true" tabindex="-1"></a>  colors <span class="op">=</span> d3<span class="op">.</span><span class="at">schemeTableau10</span><span class="op">,</span> <span class="co">// an array of color strings, for the node groups</span></span>
<span id="cb10-605"><a href="#cb10-605" aria-hidden="true" tabindex="-1"></a>  width <span class="op">=</span> <span class="dv">640</span><span class="op">,</span> <span class="co">// outer width, in pixels</span></span>
<span id="cb10-606"><a href="#cb10-606" aria-hidden="true" tabindex="-1"></a>  height <span class="op">=</span> <span class="dv">400</span><span class="op">,</span> <span class="co">// outer height, in pixels</span></span>
<span id="cb10-607"><a href="#cb10-607" aria-hidden="true" tabindex="-1"></a>  invalidation <span class="co">// when this promise resolves, stop the simulation</span></span>
<span id="cb10-608"><a href="#cb10-608" aria-hidden="true" tabindex="-1"></a>} <span class="op">=</span> {}) {</span>
<span id="cb10-609"><a href="#cb10-609" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Compute values.</span></span>
<span id="cb10-610"><a href="#cb10-610" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> N <span class="op">=</span> d3<span class="op">.</span><span class="fu">map</span>(nodes<span class="op">,</span> nodeId)<span class="op">.</span><span class="fu">map</span>(intern)<span class="op">;</span></span>
<span id="cb10-611"><a href="#cb10-611" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> LS <span class="op">=</span> d3<span class="op">.</span><span class="fu">map</span>(links<span class="op">,</span> linkSource)<span class="op">.</span><span class="fu">map</span>(intern)<span class="op">;</span></span>
<span id="cb10-612"><a href="#cb10-612" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> LT <span class="op">=</span> d3<span class="op">.</span><span class="fu">map</span>(links<span class="op">,</span> linkTarget)<span class="op">.</span><span class="fu">map</span>(intern)<span class="op">;</span></span>
<span id="cb10-613"><a href="#cb10-613" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (nodeTitle <span class="op">===</span> <span class="kw">undefined</span>) nodeTitle <span class="op">=</span> (_<span class="op">,</span> i) <span class="kw">=&gt;</span> N[i]<span class="op">;</span></span>
<span id="cb10-614"><a href="#cb10-614" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> T <span class="op">=</span> nodeTitle <span class="op">==</span> <span class="kw">null</span> <span class="op">?</span> <span class="kw">null</span> <span class="op">:</span> d3<span class="op">.</span><span class="fu">map</span>(nodes<span class="op">,</span> nodeTitle)<span class="op">;</span></span>
<span id="cb10-615"><a href="#cb10-615" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> G <span class="op">=</span> nodeGroup <span class="op">==</span> <span class="kw">null</span> <span class="op">?</span> <span class="kw">null</span> <span class="op">:</span> d3<span class="op">.</span><span class="fu">map</span>(nodes<span class="op">,</span> nodeGroup)<span class="op">.</span><span class="fu">map</span>(intern)<span class="op">;</span></span>
<span id="cb10-616"><a href="#cb10-616" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> W <span class="op">=</span> <span class="kw">typeof</span> linkStrokeWidth <span class="op">!==</span> <span class="st">"function"</span> <span class="op">?</span> <span class="kw">null</span> <span class="op">:</span> d3<span class="op">.</span><span class="fu">map</span>(links<span class="op">,</span> linkStrokeWidth)<span class="op">;</span></span>
<span id="cb10-617"><a href="#cb10-617" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> L <span class="op">=</span> <span class="kw">typeof</span> linkStroke <span class="op">!==</span> <span class="st">"function"</span> <span class="op">?</span> <span class="kw">null</span> <span class="op">:</span> d3<span class="op">.</span><span class="fu">map</span>(links<span class="op">,</span> linkStroke)<span class="op">;</span></span>
<span id="cb10-618"><a href="#cb10-618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-619"><a href="#cb10-619" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Replace the input nodes and links with mutable objects for the simulation.</span></span>
<span id="cb10-620"><a href="#cb10-620" aria-hidden="true" tabindex="-1"></a>  nodes <span class="op">=</span> d3<span class="op">.</span><span class="fu">map</span>(nodes<span class="op">,</span> (_<span class="op">,</span> i) <span class="kw">=&gt;</span> ({<span class="dt">id</span><span class="op">:</span> N[i]}))<span class="op">;</span></span>
<span id="cb10-621"><a href="#cb10-621" aria-hidden="true" tabindex="-1"></a>  links <span class="op">=</span> d3<span class="op">.</span><span class="fu">map</span>(links<span class="op">,</span> (_<span class="op">,</span> i) <span class="kw">=&gt;</span> ({<span class="dt">source</span><span class="op">:</span> LS[i]<span class="op">,</span> <span class="dt">target</span><span class="op">:</span> LT[i]}))<span class="op">;</span></span>
<span id="cb10-622"><a href="#cb10-622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-623"><a href="#cb10-623" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Compute default domains.</span></span>
<span id="cb10-624"><a href="#cb10-624" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (G <span class="op">&amp;&amp;</span> nodeGroups <span class="op">===</span> <span class="kw">undefined</span>) nodeGroups <span class="op">=</span> d3<span class="op">.</span><span class="fu">sort</span>(G)<span class="op">;</span></span>
<span id="cb10-625"><a href="#cb10-625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-626"><a href="#cb10-626" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Construct the scales.</span></span>
<span id="cb10-627"><a href="#cb10-627" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> color <span class="op">=</span> nodeGroup <span class="op">==</span> <span class="kw">null</span> <span class="op">?</span> <span class="kw">null</span> <span class="op">:</span> d3<span class="op">.</span><span class="fu">scaleOrdinal</span>(nodeGroups<span class="op">,</span> colors)<span class="op">;</span></span>
<span id="cb10-628"><a href="#cb10-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-629"><a href="#cb10-629" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Construct the forces.</span></span>
<span id="cb10-630"><a href="#cb10-630" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> forceNode <span class="op">=</span> d3<span class="op">.</span><span class="fu">forceManyBody</span>()<span class="op">;</span></span>
<span id="cb10-631"><a href="#cb10-631" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> forceLink <span class="op">=</span> d3<span class="op">.</span><span class="fu">forceLink</span>(links)<span class="op">.</span><span class="fu">id</span>(({<span class="dt">index</span><span class="op">:</span> i}) <span class="kw">=&gt;</span> N[i])<span class="op">;</span></span>
<span id="cb10-632"><a href="#cb10-632" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (nodeStrength <span class="op">!==</span> <span class="kw">undefined</span>) forceNode<span class="op">.</span><span class="fu">strength</span>(nodeStrength)<span class="op">;</span></span>
<span id="cb10-633"><a href="#cb10-633" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (linkStrength <span class="op">!==</span> <span class="kw">undefined</span>) forceLink<span class="op">.</span><span class="fu">strength</span>(linkStrength)<span class="op">;</span></span>
<span id="cb10-634"><a href="#cb10-634" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-635"><a href="#cb10-635" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> simulation <span class="op">=</span> d3<span class="op">.</span><span class="fu">forceSimulation</span>(nodes)</span>
<span id="cb10-636"><a href="#cb10-636" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">force</span>(<span class="st">"link"</span><span class="op">,</span> forceLink)</span>
<span id="cb10-637"><a href="#cb10-637" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">force</span>(<span class="st">"charge"</span><span class="op">,</span> forceNode)</span>
<span id="cb10-638"><a href="#cb10-638" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">force</span>(<span class="st">"center"</span><span class="op">,</span>  d3<span class="op">.</span><span class="fu">forceCenter</span>())</span>
<span id="cb10-639"><a href="#cb10-639" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">on</span>(<span class="st">"tick"</span><span class="op">,</span> ticked)<span class="op">;</span></span>
<span id="cb10-640"><a href="#cb10-640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-641"><a href="#cb10-641" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> svg <span class="op">=</span> d3<span class="op">.</span><span class="fu">create</span>(<span class="st">"svg"</span>)</span>
<span id="cb10-642"><a href="#cb10-642" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"width"</span><span class="op">,</span> width)</span>
<span id="cb10-643"><a href="#cb10-643" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"height"</span><span class="op">,</span> height)</span>
<span id="cb10-644"><a href="#cb10-644" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"viewBox"</span><span class="op">,</span> [<span class="op">-</span>width <span class="op">/</span> <span class="dv">2</span><span class="op">,</span> <span class="op">-</span>height <span class="op">/</span> <span class="dv">2</span><span class="op">,</span> width<span class="op">,</span> height])</span>
<span id="cb10-645"><a href="#cb10-645" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"style"</span><span class="op">,</span> <span class="st">"max-width: 100%; height: auto; height: intrinsic;"</span>)<span class="op">;</span></span>
<span id="cb10-646"><a href="#cb10-646" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-647"><a href="#cb10-647" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> link <span class="op">=</span> svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)</span>
<span id="cb10-648"><a href="#cb10-648" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke"</span><span class="op">,</span> <span class="kw">typeof</span> linkStroke <span class="op">!==</span> <span class="st">"function"</span> <span class="op">?</span> linkStroke <span class="op">:</span> <span class="kw">null</span>)</span>
<span id="cb10-649"><a href="#cb10-649" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke-opacity"</span><span class="op">,</span> linkStrokeOpacity)</span>
<span id="cb10-650"><a href="#cb10-650" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke-width"</span><span class="op">,</span> <span class="kw">typeof</span> linkStrokeWidth <span class="op">!==</span> <span class="st">"function"</span> <span class="op">?</span> linkStrokeWidth <span class="op">:</span> <span class="kw">null</span>)</span>
<span id="cb10-651"><a href="#cb10-651" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke-linecap"</span><span class="op">,</span> linkStrokeLinecap)</span>
<span id="cb10-652"><a href="#cb10-652" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"line"</span>)</span>
<span id="cb10-653"><a href="#cb10-653" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">data</span>(links)</span>
<span id="cb10-654"><a href="#cb10-654" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">join</span>(<span class="st">"line"</span>)<span class="op">;</span></span>
<span id="cb10-655"><a href="#cb10-655" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-656"><a href="#cb10-656" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> node <span class="op">=</span> svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)</span>
<span id="cb10-657"><a href="#cb10-657" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill"</span><span class="op">,</span> nodeFill)</span>
<span id="cb10-658"><a href="#cb10-658" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke"</span><span class="op">,</span> nodeStroke)</span>
<span id="cb10-659"><a href="#cb10-659" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke-opacity"</span><span class="op">,</span> nodeStrokeOpacity)</span>
<span id="cb10-660"><a href="#cb10-660" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke-width"</span><span class="op">,</span> nodeStrokeWidth)</span>
<span id="cb10-661"><a href="#cb10-661" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"circle"</span>)</span>
<span id="cb10-662"><a href="#cb10-662" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">data</span>(nodes)</span>
<span id="cb10-663"><a href="#cb10-663" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">join</span>(<span class="st">"circle"</span>)</span>
<span id="cb10-664"><a href="#cb10-664" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"r"</span><span class="op">,</span> nodeRadius)</span>
<span id="cb10-665"><a href="#cb10-665" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">call</span>(<span class="fu">drag</span>(simulation))</span>
<span id="cb10-666"><a href="#cb10-666" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">join</span>(<span class="st">"text"</span>)</span>
<span id="cb10-667"><a href="#cb10-667" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"dx"</span><span class="op">,</span> <span class="st">".10em"</span>)</span>
<span id="cb10-668"><a href="#cb10-668" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"dy"</span><span class="op">,</span> <span class="st">".10em"</span>)</span>
<span id="cb10-669"><a href="#cb10-669" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">text</span>(<span class="kw">function</span>(d) { <span class="cf">return</span> d<span class="op">.</span><span class="at">id</span><span class="op">;</span> })<span class="op">;</span></span>
<span id="cb10-670"><a href="#cb10-670" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-671"><a href="#cb10-671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-672"><a href="#cb10-672" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-673"><a href="#cb10-673" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;!--</span> <span class="kw">var</span> circles <span class="op">=</span> node<span class="op">.</span><span class="fu">append</span>(<span class="st">"circle"</span>) <span class="op">--&gt;</span></span>
<span id="cb10-674"><a href="#cb10-674" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;!--</span> <span class="op">.</span><span class="fu">attr</span>(<span class="st">"r"</span><span class="op">,</span> nodeRadius) <span class="op">--&gt;</span></span>
<span id="cb10-675"><a href="#cb10-675" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;!--</span>     <span class="op">.</span><span class="fu">call</span>(<span class="fu">drag</span>(simulation))<span class="op">;</span> <span class="op">--&gt;</span></span>
<span id="cb10-676"><a href="#cb10-676" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-677"><a href="#cb10-677" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;!--</span> <span class="kw">var</span> labels <span class="op">=</span> node<span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>) <span class="op">--&gt;</span></span>
<span id="cb10-678"><a href="#cb10-678" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;!--</span>   <span class="op">.</span><span class="fu">attr</span>(<span class="st">"dx"</span><span class="op">,</span> <span class="st">".10em"</span>) <span class="op">--&gt;</span></span>
<span id="cb10-679"><a href="#cb10-679" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;!--</span>   <span class="op">.</span><span class="fu">attr</span>(<span class="st">"dy"</span><span class="op">,</span> <span class="st">".10em"</span>) <span class="op">--&gt;</span></span>
<span id="cb10-680"><a href="#cb10-680" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;!--</span>   <span class="op">.</span><span class="fu">text</span>(<span class="kw">function</span>(d) { <span class="cf">return</span> d<span class="op">.</span><span class="at">id</span><span class="op">;</span> })<span class="op">;</span> <span class="op">--&gt;</span></span>
<span id="cb10-681"><a href="#cb10-681" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-682"><a href="#cb10-682" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;!--</span> node<span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>) <span class="op">--&gt;</span></span>
<span id="cb10-683"><a href="#cb10-683" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;!--</span> <span class="op">.</span><span class="fu">text</span>(({id}) <span class="kw">=&gt;</span> id) <span class="co">// display the node id as text --&gt;</span></span>
<span id="cb10-684"><a href="#cb10-684" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;!--</span> <span class="op">.</span><span class="fu">attr</span>(<span class="st">"text-anchor"</span><span class="op">,</span> <span class="st">"middle"</span>) <span class="co">// center the text within the circle --&gt;</span></span>
<span id="cb10-685"><a href="#cb10-685" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;!--</span> <span class="op">.</span><span class="fu">attr</span>(<span class="st">"dy"</span><span class="op">,</span> <span class="st">"0.35em"</span>)<span class="op">;</span> <span class="co">// adjust the vertical position of the text within the circle --&gt;</span></span>
<span id="cb10-686"><a href="#cb10-686" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-687"><a href="#cb10-687" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (W) link<span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke-width"</span><span class="op">,</span> ({<span class="dt">index</span><span class="op">:</span> i}) <span class="kw">=&gt;</span> W[i])<span class="op">;</span></span>
<span id="cb10-688"><a href="#cb10-688" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (L) link<span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke"</span><span class="op">,</span> ({<span class="dt">index</span><span class="op">:</span> i}) <span class="kw">=&gt;</span> L[i])<span class="op">;</span></span>
<span id="cb10-689"><a href="#cb10-689" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (G) node<span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill"</span><span class="op">,</span> ({<span class="dt">index</span><span class="op">:</span> i}) <span class="kw">=&gt;</span> <span class="fu">color</span>(G[i]))<span class="op">;</span></span>
<span id="cb10-690"><a href="#cb10-690" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (T) node<span class="op">.</span><span class="fu">append</span>(<span class="st">"title"</span>)<span class="op">.</span><span class="fu">text</span>(({<span class="dt">index</span><span class="op">:</span> i}) <span class="kw">=&gt;</span> T[i])<span class="op">;</span></span>
<span id="cb10-691"><a href="#cb10-691" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (invalidation <span class="op">!=</span> <span class="kw">null</span>) invalidation<span class="op">.</span><span class="fu">then</span>(() <span class="kw">=&gt;</span> simulation<span class="op">.</span><span class="fu">stop</span>())<span class="op">;</span></span>
<span id="cb10-692"><a href="#cb10-692" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-693"><a href="#cb10-693" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">intern</span>(value) {</span>
<span id="cb10-694"><a href="#cb10-694" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> value <span class="op">!==</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> <span class="kw">typeof</span> value <span class="op">===</span> <span class="st">"object"</span> <span class="op">?</span> value<span class="op">.</span><span class="fu">valueOf</span>() <span class="op">:</span> value<span class="op">;</span></span>
<span id="cb10-695"><a href="#cb10-695" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-696"><a href="#cb10-696" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-697"><a href="#cb10-697" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">ticked</span>() {</span>
<span id="cb10-698"><a href="#cb10-698" aria-hidden="true" tabindex="-1"></a>    link</span>
<span id="cb10-699"><a href="#cb10-699" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">source</span><span class="op">.</span><span class="at">x</span>)</span>
<span id="cb10-700"><a href="#cb10-700" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">source</span><span class="op">.</span><span class="at">y</span>)</span>
<span id="cb10-701"><a href="#cb10-701" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">x</span>)</span>
<span id="cb10-702"><a href="#cb10-702" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">y</span>)<span class="op">;</span></span>
<span id="cb10-703"><a href="#cb10-703" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-704"><a href="#cb10-704" aria-hidden="true" tabindex="-1"></a>    node</span>
<span id="cb10-705"><a href="#cb10-705" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"cx"</span><span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">x</span>)</span>
<span id="cb10-706"><a href="#cb10-706" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"cy"</span><span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">y</span>)<span class="op">;</span></span>
<span id="cb10-707"><a href="#cb10-707" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-708"><a href="#cb10-708" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-709"><a href="#cb10-709" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">drag</span>(simulation) {    </span>
<span id="cb10-710"><a href="#cb10-710" aria-hidden="true" tabindex="-1"></a>    <span class="kw">function</span> <span class="fu">dragstarted</span>(<span class="bu">event</span>) {</span>
<span id="cb10-711"><a href="#cb10-711" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span><span class="bu">event</span><span class="op">.</span><span class="at">active</span>) simulation<span class="op">.</span><span class="fu">alphaTarget</span>(<span class="fl">0.3</span>)<span class="op">.</span><span class="fu">restart</span>()<span class="op">;</span></span>
<span id="cb10-712"><a href="#cb10-712" aria-hidden="true" tabindex="-1"></a>      <span class="bu">event</span><span class="op">.</span><span class="at">subject</span><span class="op">.</span><span class="at">fx</span> <span class="op">=</span> <span class="bu">event</span><span class="op">.</span><span class="at">subject</span><span class="op">.</span><span class="at">x</span><span class="op">;</span></span>
<span id="cb10-713"><a href="#cb10-713" aria-hidden="true" tabindex="-1"></a>      <span class="bu">event</span><span class="op">.</span><span class="at">subject</span><span class="op">.</span><span class="at">fy</span> <span class="op">=</span> <span class="bu">event</span><span class="op">.</span><span class="at">subject</span><span class="op">.</span><span class="at">y</span><span class="op">;</span></span>
<span id="cb10-714"><a href="#cb10-714" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-715"><a href="#cb10-715" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-716"><a href="#cb10-716" aria-hidden="true" tabindex="-1"></a>    <span class="kw">function</span> <span class="fu">dragged</span>(<span class="bu">event</span>) {</span>
<span id="cb10-717"><a href="#cb10-717" aria-hidden="true" tabindex="-1"></a>      <span class="bu">event</span><span class="op">.</span><span class="at">subject</span><span class="op">.</span><span class="at">fx</span> <span class="op">=</span> <span class="bu">event</span><span class="op">.</span><span class="at">x</span><span class="op">;</span></span>
<span id="cb10-718"><a href="#cb10-718" aria-hidden="true" tabindex="-1"></a>      <span class="bu">event</span><span class="op">.</span><span class="at">subject</span><span class="op">.</span><span class="at">fy</span> <span class="op">=</span> <span class="bu">event</span><span class="op">.</span><span class="at">y</span><span class="op">;</span></span>
<span id="cb10-719"><a href="#cb10-719" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-720"><a href="#cb10-720" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-721"><a href="#cb10-721" aria-hidden="true" tabindex="-1"></a>    <span class="kw">function</span> <span class="fu">dragended</span>(<span class="bu">event</span>) {</span>
<span id="cb10-722"><a href="#cb10-722" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span><span class="bu">event</span><span class="op">.</span><span class="at">active</span>) simulation<span class="op">.</span><span class="fu">alphaTarget</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb10-723"><a href="#cb10-723" aria-hidden="true" tabindex="-1"></a>      <span class="bu">event</span><span class="op">.</span><span class="at">subject</span><span class="op">.</span><span class="at">fx</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb10-724"><a href="#cb10-724" aria-hidden="true" tabindex="-1"></a>      <span class="bu">event</span><span class="op">.</span><span class="at">subject</span><span class="op">.</span><span class="at">fy</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb10-725"><a href="#cb10-725" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-726"><a href="#cb10-726" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-727"><a href="#cb10-727" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> d3<span class="op">.</span><span class="fu">drag</span>()</span>
<span id="cb10-728"><a href="#cb10-728" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">on</span>(<span class="st">"start"</span><span class="op">,</span> dragstarted)</span>
<span id="cb10-729"><a href="#cb10-729" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">on</span>(<span class="st">"drag"</span><span class="op">,</span> dragged)</span>
<span id="cb10-730"><a href="#cb10-730" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">on</span>(<span class="st">"end"</span><span class="op">,</span> dragended)<span class="op">;</span></span>
<span id="cb10-731"><a href="#cb10-731" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-732"><a href="#cb10-732" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-733"><a href="#cb10-733" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="bu">Object</span><span class="op">.</span><span class="fu">assign</span>(svg<span class="op">.</span><span class="fu">node</span>()<span class="op">,</span> {<span class="dt">scales</span><span class="op">:</span> {color}})<span class="op">;</span></span>
<span id="cb10-734"><a href="#cb10-734" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-735"><a href="#cb10-735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-736"><a href="#cb10-736" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-737"><a href="#cb10-737" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> {howto} <span class="im">from</span> <span class="st">"@d3/example-components"</span></span>
<span id="cb10-738"><a href="#cb10-738" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-739"><a href="#cb10-739" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> {Swatches} <span class="im">from</span> <span class="st">"@d3/color-legend"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-4-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-4-2" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-4-3" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-4-4" data-nodetype="declaration">

</div>
</div>
</div>
</div>
<p>This visualization displays an interactive network chart connecting death age groups with the conditions leading to those deaths. The chart effectively demonstrates the relationships between various factors contributing to COVID-19-related fatalities.</p>
<p>One limitation I encountered was the inability to add labels to the force graph. Ideally, the blue node in the center should be labeled as United States, representing the entire nation. The orange nodes represent different age groups, while the red nodes situated along the boundary indicate the top 3 conditions contributing to the deaths in each corresponding age group. The width of the links between the nodes reflects the number of death cases associated with each condition.</p>
</section>
<section id="choropleth-map-for-covid-19-deaths-by-state" class="level2">
<h2 class="anchored" data-anchor-id="choropleth-map-for-covid-19-deaths-by-state">Choropleth Map for COVID-19 Deaths by State</h2>
<p>Geocoding presents a significant challenge when creating choropleth maps. In R language, the maps library can be used to match specific location names to polygons with corresponding longitudes and latitudes on a map. In my project, these name lists are stored in lowercase:</p>
<pre><code>us_map &lt;- maps::map("state", plot = FALSE, fill = TRUE) %&gt;%
  st_as_sf() %&gt;%
  rename(State = ID)

agg_data$State &lt;- tolower(agg_data$State)
us_map$State &lt;- tolower(us_map$State)</code></pre>
<p>However, the state values in the State column were originally stored with capital initials, causing missing data throughout the map. By modifying the code as shown above, the geocoding process can now accurately map the csv data to the choropleth’s required format, successfully rendering the intended map visualization.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(maps)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(viridis)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"./choropleth/state_filtered_by_total.csv"</span>, <span class="at">header =</span> <span class="cn">TRUE</span>, <span class="at">sep =</span> <span class="st">","</span>, <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(data) <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">""</span>, <span class="fu">colnames</span>(data))</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>agg_data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(State) <span class="sc">%&gt;%</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">Total_Deaths =</span> <span class="fu">sum</span>(COVID_19_Deaths, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>us_map <span class="ot">&lt;-</span> maps<span class="sc">::</span><span class="fu">map</span>(<span class="st">"state"</span>, <span class="at">plot =</span> <span class="cn">FALSE</span>, <span class="at">fill =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">State =</span> ID)</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>agg_data<span class="sc">$</span>State <span class="ot">&lt;-</span> <span class="fu">tolower</span>(agg_data<span class="sc">$</span>State)</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>us_map<span class="sc">$</span>State <span class="ot">&lt;-</span> <span class="fu">tolower</span>(us_map<span class="sc">$</span>State)</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>merged_data <span class="ot">&lt;-</span> <span class="fu">left_join</span>(us_map, agg_data, <span class="at">by =</span> <span class="st">"State"</span>)</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>merged_data<span class="sc">$</span>Total_Deaths[<span class="fu">is.na</span>(merged_data<span class="sc">$</span>Total_Deaths)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>custom_breaks <span class="ot">&lt;-</span> <span class="cf">function</span>(limits) {</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>  default_breaks <span class="ot">&lt;-</span> <span class="fu">pretty</span>(<span class="fu">c</span>(<span class="dv">0</span>, limits[<span class="dv">2</span>]<span class="sc">^</span><span class="fl">0.5</span>), <span class="at">n =</span> <span class="dv">5</span>)<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(default_breaks)</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> merged_data) <span class="sc">+</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> Total_Deaths), <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">size =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis</span>(<span class="at">option =</span> <span class="st">"magma"</span>, <span class="at">trans =</span> <span class="st">"sqrt"</span>, , <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">name =</span> <span class="st">"COVID-19 Deaths"</span>,</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> custom_breaks,</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>                     <span class="at">guide =</span> <span class="fu">guide_colorbar</span>(<span class="at">title.position =</span> <span class="st">"top"</span>, <span class="at">title.hjust =</span> <span class="fl">0.5</span>,</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">label.position =</span> <span class="st">"bottom"</span>, <span class="at">label.hjust =</span> <span class="fl">0.5</span>,</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">barwidth =</span> <span class="dv">15</span>, <span class="at">barheight =</span> <span class="fl">0.8</span>)) <span class="sc">+</span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Choropleth Map: COVID-19 Deaths by State"</span>) <span class="sc">+</span></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid.major =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.ticks =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.key.height =</span> <span class="fu">unit</span>(<span class="dv">2</span>, <span class="st">"cm"</span>),</span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>),</span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>This Choropleth Map for COVID-19 Deaths by State effectively illustrates the spatial differences in death cases across the United States, highlighting the state-wise fatality of the pandemic. By visualizing these disparities, the map underscores the importance of understanding regional variations in public health outcomes and pandemic responses. This information is crucial for policy makers, public health officials, and researchers as they develop targeted interventions, allocate resources, and evaluate the effectiveness of various strategies in mitigating the impact of COVID-19.</p>
</section>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<p>In this blog, I have demonstrated a workflow for processing a public COVID-19 dataset from <a href="https://data.gov/">Data.gov</a> and showcasing the data characteristics using four different visualizations.</p>
<p>The first visualization, a bar chart of COVID-19 death cases, straightforwardly displays the significantly higher percentage of senior victims in the pandemic. The second visualization, a dynamic bar chart, proved a bit more challenging due to my limited familiarity with JavaScript. I spent some time fixing the bar shifting issues, but there remains an unresolved issue where some states with fewer death cases have their names overlapping the y-axis and becoming invisible to the audience. A potential solution could involve applying the <code>x(0)</code> variable to shift the labels accordingly, but this adjustment might also lead to broken visualizations.</p>
<p>The third visualization, a force graph, did not turn out as intended. It fails to convey useful information about the dataset since I was unable to add labels to the graph. I decided to include it here because it required significant effort on my part.</p>
<p>The final visualization, a Choropleth Map, was relatively straightforward to create, with the main challenge being the integration of lowercase state names.</p>
<p>Throughout the course, I have learned many powerful and effective visualization techniques that have been invaluable to me. Due to time constraints, I could not include all these techniques in this blog. I would like to extend my gratitude to Professor Barrie for the invaluable lessons.</p>


<!-- -->

</section>

</main> <!-- /main -->

<script type="ojs-module-contents">
{"contents":[{"methodName":"interpret","cellName":"ojs-cell-1","inline":false,"source":"\ndata = d3.csvParse(await FileAttachment(\"./horizontal/output2.csv\").text(), d3.autoType)\nviewof replay = html`<button>Replay`\n\n"},{"methodName":"interpret","cellName":"ojs-cell-2","inline":false,"source":"chart = {\n  \n  replay;\n\n  const svg = d3.create(\"svg\")\n      .attr(\"viewBox\", [0, 0, width, height]);\n\n  const updateBars = bars(svg);\n  const updateAxis = axis(svg);\n  const updateLabels = labels(svg);\n  const updateTicker = ticker(svg);\n\n  yield svg.node();\n\n  for (const keyframe of keyframes) {\n    const transition = svg.transition()\n        .duration(duration)\n        .ease(d3.easeLinear);\n\n    // Extract the top bar’s value.\n    x.domain([0, keyframe[1][0].value]);\n\n    updateAxis(keyframe, transition);\n    updateBars(keyframe, transition);\n    updateLabels(keyframe, transition);\n    updateTicker(keyframe, transition);\n\n    invalidation.then(() => svg.interrupt());\n    await transition.end();\n  }\n}\n\n\nduration = 250\nn = 50\nk = 10\nnames = new Set(data.map(d => d.name))\n\n\ndatevalues = Array.from(d3.rollup(data, ([d]) => d.value, d => +d.date, d => d.name))\n  .map(([date, data]) => [new Date(date), data])\n  .sort(([a], [b]) => d3.ascending(a, b))\n  \n  \nfunction rank(value) {\n  const data = Array.from(names, name => ({name, value: value(name)}));\n  data.sort((a, b) => d3.descending(a.value, b.value));\n  for (let i = 0; i < data.length; ++i) data[i].rank = Math.min(n, i);\n  return data;\n}\n\nkeyframes = {\n  const keyframes = [];\n  let ka, a, kb, b;\n  for ([[ka, a], [kb, b]] of d3.pairs(datevalues)) {\n    for (let i = 0; i < k; ++i) {\n      const t = i / k;\n      keyframes.push([\n        new Date(ka * (1 - t) + kb * t),\n        rank(name => (a.get(name) || 0) * (1 - t) + (b.get(name) || 0) * t)\n      ]);\n    }\n  }\n  keyframes.push([new Date(kb), rank(name => b.get(name) || 0)]);\n  return keyframes;\n}\n\nnameframes = d3.groups(keyframes.flatMap(([, data]) => data), d => d.name)\n\nprev = new Map(nameframes.flatMap(([, data]) => d3.pairs(data, (a, b) => [b, a])))\n\nnext = new Map(nameframes.flatMap(([, data]) => d3.pairs(data)))\n\nfunction bars(svg) {\n  let bar = svg.append(\"g\")\n      .attr(\"fill-opacity\", 0.6)\n    .selectAll(\"rect\");\n\n  return ([date, data], transition) => bar = bar\n    .data(data.slice(0, n), d => d.name)\n    .join(\n      enter => enter.append(\"rect\")\n        .attr(\"fill\", color)\n        .attr(\"height\", y.bandwidth())\n        <!-- .attr(\"x\", x(0)) -->\n        .attr(\"x\", -6)\n        .attr(\"y\", d => y((prev.get(d) || d).rank))\n        .attr(\"width\", d => x((prev.get(d) || d).value) - x(0)),\n      update => update,\n      exit => exit.transition(transition).remove()\n        .attr(\"y\", d => y((next.get(d) || d).rank))\n        .attr(\"width\", d => x((next.get(d) || d).value) - x(0))\n    )\n    .call(bar => bar.transition(transition)\n      .attr(\"y\", d => y(d.rank))\n      .attr(\"width\", d => x(d.value) - x(0)));\n}\n\n\nfunction labels(svg) {\n  let label = svg.append(\"g\")\n      .style(\"font\", \"bold 12px var(--sans-serif)\")\n      .style(\"font-variant-numeric\", \"tabular-nums\")\n      .attr(\"text-anchor\", \"end\")\n    .selectAll(\"text\");\n\n  return ([date, data], transition) => label = label\n    .data(data.slice(0, n), d => d.name)\n    .join(\n      enter => enter.append(\"text\")\n        .attr(\"transform\", d => `translate(${x((prev.get(d) || d).value)},${y((prev.get(d) || d).rank)})`)\n        .attr(\"y\", y.bandwidth() / 2)\n        .attr(\"x\", -6)\n        .attr(\"dy\", \"-0.25em\")\n        .text(d => d.name)\n        .call(text => text.append(\"tspan\")\n          .attr(\"fill-opacity\", 0.7)\n          .attr(\"font-weight\", \"normal\")\n          .attr(\"x\", -6)\n          .attr(\"dy\", \"1.15em\")),\n      update => update,\n      exit => exit.transition(transition).remove()\n        .attr(\"transform\", d => `translate(${x((next.get(d) || d).value)},${y((next.get(d) || d).rank)})`)\n        .call(g => g.select(\"tspan\").tween(\"text\", d => textTween(d.value, (next.get(d) || d).value)))\n    )\n    .call(bar => bar.transition(transition)\n      .attr(\"transform\", d => `translate(${x(d.value)},${y(d.rank)})`)\n      .call(g => g.select(\"tspan\").tween(\"text\", d => textTween((prev.get(d) || d).value, d.value))))\n}\n\nfunction textTween(a, b) {\n  const i = d3.interpolateNumber(a, b);\n  return function(t) {\n    this.textContent = formatNumber(i(t));\n  };\n}\n\nformatNumber = d3.format(\",d\")\n\nfunction axis(svg) {\n  const g = svg.append(\"g\")\n      .attr(\"transform\", `translate(0,${margin.top})`);\n\n  const axis = d3.axisTop(x)\n      .ticks(width / 160)\n      .tickSizeOuter(0)\n      .tickSizeInner(-barSize * (n + y.padding()));\n\n  return (_, transition) => {\n    g.transition(transition).call(axis);\n    g.select(\".tick:first-of-type text\").remove();\n    g.selectAll(\".tick:not(:first-of-type) line\").attr(\"stroke\", \"white\");\n    g.select(\".domain\").remove();\n  };\n}\n\nfunction ticker(svg) {\n  const now = svg.append(\"text\")\n      .style(\"font\", `bold ${barSize}px var(--sans-serif)`)\n      .style(\"font-variant-numeric\", \"tabular-nums\")\n      .attr(\"text-anchor\", \"end\")\n      .attr(\"x\", width - 6)\n      .attr(\"y\", margin.top + barSize * (n - 0.45))\n      .attr(\"dy\", \"0.32em\")\n      .text(formatDate(keyframes[0][0]));\n\n  return ([date], transition) => {\n    transition.end().then(() => now.text(formatDate(date)));\n  };\n}\n\nformatDate = d3.utcFormat(\"%Y\")\n\ncolor = {\n  const scale = d3.scaleSequential(d3.interpolate(\"red\", \"blue\")).domain([1, 48]);\n  if (data.some(d => d.category !== undefined)) {\n    const categoryByName = new Map(data.map(d => [d.name, d.category]))\n    scale.domain(Array.from(categoryByName.values()));\n    return d => scale(categoryByName.get(d.name));\n  }\n  return d => scale(d.name);\n}\n\n\n<!-- color = { -->\n<!--   const scale = d3.scaleSequential(d3.interpolate(\"red\", \"blue\")).domain([1, 48]); -->\n<!--   if (data.some(d => d.category !== undefined)) { -->\n<!--     const categoryByName = new Map(data.map(d => [d.name, d.category])); -->\n<!--     const categories = Array.from(categoryByName.values()).filter((d, i, arr) => arr.indexOf(d) === i); -->\n<!--     const scaleByCategory = typeof categories[0] === \"number\" ?  -->\n<!--       d3.scaleSequential(d3.interpolateSpectral).domain(d3.extent(categories)) : -->\n<!--       d3.scaleOrdinal().domain(categories).range(d3.quantize(d3.interpolateSpectral, categories.length)); -->\n<!--     return d => scale(scaleByCategory(categoryByName.get(d.name))); -->\n<!--   } -->\n<!--   return (d, i) => scale(i); -->\n<!-- } -->\n\n<!-- x = d3.scaleLinear([0, 1], [margin.left, width - margin.right]) -->\nx = d3.scaleLinear([0, 1], [margin.left,  width - margin.right])\n\ny = d3.scaleBand()\n    .domain(d3.range(n + 1))\n    .rangeRound([margin.top, margin.top + barSize * (n + 1 + 0.1)])\n    .padding(0.1)\n    \nheight = margin.top + barSize * n + margin.bottom\n\nbarSize = 48\n\nmargin = ({top: 16, right: 6, bottom: 6, left: 0})\n\nd3 = require(\"d3@6\")\n\n"},{"methodName":"interpret","cellName":"ojs-cell-3","inline":false,"source":"chart2 = ForceGraph(miserables, {\n  nodeId: d => d.id,\n  nodeGroup: d => d.group,\n  nodeTitle: d => `${d.id}\\n${d.group}`,\n  linkStrokeWidth: l => Math.sqrt(l.value),\n  width,\n  height: 600,\n  invalidation // a promise to stop the simulation when the cell is re-run\n})\n"},{"methodName":"interpret","cellName":"ojs-cell-4","inline":false,"source":"miserables = FileAttachment(\"./net/new_filtered_network_with_center.json\").json()\n\n\n// Copyright 2021 Observable, Inc.\n// Released under the ISC license.\n// https://observablehq.com/@d3/force-directed-graph\nfunction ForceGraph({\n  nodes, // an iterable of node objects (typically [{id}, …])\n  links // an iterable of link objects (typically [{source, target}, …])\n}, {\n  nodeId = d => d.id, // given d in nodes, returns a unique identifier (string)\n  nodeGroup, // given d in nodes, returns an (ordinal) value for color\n  nodeGroups, // an array of ordinal values representing the node groups\n  nodeTitle, // given d in nodes, a title string\n  nodeFill = \"currentColor\", // node stroke fill (if not using a group color encoding)\n  nodeStroke = \"#fff\", // node stroke color\n  nodeStrokeWidth = 1.5, // node stroke width, in pixels\n  nodeStrokeOpacity = 1, // node stroke opacity\n  nodeRadius = 5, // node radius, in pixels\n  nodeStrength,\n  linkSource = ({source}) => source, // given d in links, returns a node identifier string\n  linkTarget = ({target}) => target, // given d in links, returns a node identifier string\n  linkStroke = \"#999\", // link stroke color\n  linkStrokeOpacity = 0.6, // link stroke opacity\n  linkStrokeWidth = 1.5, // given d in links, returns a stroke width in pixels\n  linkStrokeLinecap = \"round\", // link stroke linecap\n  linkStrength,\n  colors = d3.schemeTableau10, // an array of color strings, for the node groups\n  width = 640, // outer width, in pixels\n  height = 400, // outer height, in pixels\n  invalidation // when this promise resolves, stop the simulation\n} = {}) {\n  // Compute values.\n  const N = d3.map(nodes, nodeId).map(intern);\n  const LS = d3.map(links, linkSource).map(intern);\n  const LT = d3.map(links, linkTarget).map(intern);\n  if (nodeTitle === undefined) nodeTitle = (_, i) => N[i];\n  const T = nodeTitle == null ? null : d3.map(nodes, nodeTitle);\n  const G = nodeGroup == null ? null : d3.map(nodes, nodeGroup).map(intern);\n  const W = typeof linkStrokeWidth !== \"function\" ? null : d3.map(links, linkStrokeWidth);\n  const L = typeof linkStroke !== \"function\" ? null : d3.map(links, linkStroke);\n\n  // Replace the input nodes and links with mutable objects for the simulation.\n  nodes = d3.map(nodes, (_, i) => ({id: N[i]}));\n  links = d3.map(links, (_, i) => ({source: LS[i], target: LT[i]}));\n\n  // Compute default domains.\n  if (G && nodeGroups === undefined) nodeGroups = d3.sort(G);\n\n  // Construct the scales.\n  const color = nodeGroup == null ? null : d3.scaleOrdinal(nodeGroups, colors);\n\n  // Construct the forces.\n  const forceNode = d3.forceManyBody();\n  const forceLink = d3.forceLink(links).id(({index: i}) => N[i]);\n  if (nodeStrength !== undefined) forceNode.strength(nodeStrength);\n  if (linkStrength !== undefined) forceLink.strength(linkStrength);\n\n  const simulation = d3.forceSimulation(nodes)\n      .force(\"link\", forceLink)\n      .force(\"charge\", forceNode)\n      .force(\"center\",  d3.forceCenter())\n      .on(\"tick\", ticked);\n\n  const svg = d3.create(\"svg\")\n      .attr(\"width\", width)\n      .attr(\"height\", height)\n      .attr(\"viewBox\", [-width / 2, -height / 2, width, height])\n      .attr(\"style\", \"max-width: 100%; height: auto; height: intrinsic;\");\n\n  const link = svg.append(\"g\")\n      .attr(\"stroke\", typeof linkStroke !== \"function\" ? linkStroke : null)\n      .attr(\"stroke-opacity\", linkStrokeOpacity)\n      .attr(\"stroke-width\", typeof linkStrokeWidth !== \"function\" ? linkStrokeWidth : null)\n      .attr(\"stroke-linecap\", linkStrokeLinecap)\n    .selectAll(\"line\")\n    .data(links)\n    .join(\"line\");\n\n  const node = svg.append(\"g\")\n      .attr(\"fill\", nodeFill)\n      .attr(\"stroke\", nodeStroke)\n      .attr(\"stroke-opacity\", nodeStrokeOpacity)\n      .attr(\"stroke-width\", nodeStrokeWidth)\n    .selectAll(\"circle\")\n    .data(nodes)\n    .join(\"circle\")\n      .attr(\"r\", nodeRadius)\n      .call(drag(simulation))\n    .join(\"text\")\n    .attr(\"dx\", \".10em\")\n    .attr(\"dy\", \".10em\")\n    .text(function(d) { return d.id; });\n  \n\n  \n  <!-- var circles = node.append(\"circle\") -->\n  <!-- .attr(\"r\", nodeRadius) -->\n  <!--     .call(drag(simulation)); -->\n\n  <!-- var labels = node.append(\"text\") -->\n  <!--   .attr(\"dx\", \".10em\") -->\n  <!--   .attr(\"dy\", \".10em\") -->\n  <!--   .text(function(d) { return d.id; }); -->\n\n  <!-- node.append(\"text\") -->\n  <!-- .text(({id}) => id) // display the node id as text -->\n  <!-- .attr(\"text-anchor\", \"middle\") // center the text within the circle -->\n  <!-- .attr(\"dy\", \"0.35em\"); // adjust the vertical position of the text within the circle -->\n\n  if (W) link.attr(\"stroke-width\", ({index: i}) => W[i]);\n  if (L) link.attr(\"stroke\", ({index: i}) => L[i]);\n  if (G) node.attr(\"fill\", ({index: i}) => color(G[i]));\n  if (T) node.append(\"title\").text(({index: i}) => T[i]);\n  if (invalidation != null) invalidation.then(() => simulation.stop());\n\n  function intern(value) {\n    return value !== null && typeof value === \"object\" ? value.valueOf() : value;\n  }\n\n  function ticked() {\n    link\n      .attr(\"x1\", d => d.source.x)\n      .attr(\"y1\", d => d.source.y)\n      .attr(\"x2\", d => d.target.x)\n      .attr(\"y2\", d => d.target.y);\n\n    node\n      .attr(\"cx\", d => d.x)\n      .attr(\"cy\", d => d.y);\n  }\n\n  function drag(simulation) {    \n    function dragstarted(event) {\n      if (!event.active) simulation.alphaTarget(0.3).restart();\n      event.subject.fx = event.subject.x;\n      event.subject.fy = event.subject.y;\n    }\n    \n    function dragged(event) {\n      event.subject.fx = event.x;\n      event.subject.fy = event.y;\n    }\n    \n    function dragended(event) {\n      if (!event.active) simulation.alphaTarget(0);\n      event.subject.fx = null;\n      event.subject.fy = null;\n    }\n    \n    return d3.drag()\n      .on(\"start\", dragstarted)\n      .on(\"drag\", dragged)\n      .on(\"end\", dragended);\n  }\n\n  return Object.assign(svg.node(), {scales: {color}});\n}\n\n\nimport {howto} from \"@d3/example-components\"\n\nimport {Swatches} from \"@d3/color-legend\"\n\n"},{"methodName":"interpretQuiet","source":"shinyInput('replay')"}]}
</script>
<script type="module">
window._ojs.paths.runtimeToDoc = "../../posts/final";
window._ojs.paths.runtimeToRoot = "../..";
window._ojs.paths.docToRoot = "../..";
window._ojs.selfContained = false;
window._ojs.runtime.interpretFromScriptTags();
</script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb14" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "End of the Term: Visualizing the Death of COVID-19"</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "Jiyin Zhang"</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> " Creating Effective Visualizations for COVID-19 Death Cases"</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> "2023-05-08"</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span><span class="co"> [Visualization, COVID-19, Observable, Assignment]</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="an">image:</span><span class="co"> qJaIxHR4S5Zun3z8veat--1--n8qpv.jpg</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="an">code-fold:</span><span class="co"> true</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="an">code-tools:</span><span class="co"> true</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="an">description:</span><span class="co"> "Discover the power of data visualization as we explore COVID-19 death cases in the United States through various charts."</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span><span class="co"> html</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="fu"># PREAMBLE</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;p</span> <span class="er">style</span><span class="ot">=</span><span class="st">"color:red"</span><span class="kw">&gt;</span>Covid-19.<span class="kw">&lt;/p&gt;</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>The COVID-19 pandemic has undoubtedly affected every aspect of our lives, and understanding its impact is crucial in our ongoing efforts to mitigate the spread of the virus and protect vulnerable populations. One valuable resource for understanding this impact is the dataset titled <span class="co">[</span><span class="ot">"Conditions Contributing to COVID-19 Deaths, by State and Age, Provisional 2020-2023"</span><span class="co">](https://catalog.data.gov/dataset/conditions-contributing-to-deaths-involving-coronavirus-disease-2019-covid-19-by-age-group)</span> which offers a comprehensive look at the health conditions and causes mentioned in conjunction with COVID-19 related deaths across different age groups and jurisdictions. </span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>In this blog post, I will explore this dataset and showcase a series of visualizations that aim to provide greater insight into the patterns, trends, and relationships hidden within the data. Our visualizations will include a **state-wise stacked bar chart of ages of COVID-19 deaths**, an **animated visualization capturing the changing dynamics of deaths in each state**, an **interactive network chart connecting death age groups with the conditions leading to death**, and finally, a **choropleth map illustrating COVID-19 deaths by state**. By delving into these visualizations, I hope to not only improve our understanding of the pandemic's impact on various communities but also inspire data-driven decision-making in our ongoing fight against COVID-19. So, let's dive in and uncover the stories hidden within the data.</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a><span class="fu"># Data Preparation</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the input CSV file</span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>input_file <span class="op">=</span> <span class="st">'Conditions_Contributing_to_COVID-19_Deaths__by_State_and_Age__Provisional_2020-2023.csv'</span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(input_file)</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Split the DataFrame based on the "Group" column values</span></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>df_by_total <span class="op">=</span> df[df[<span class="st">'Group'</span>] <span class="op">==</span> <span class="st">'By Total'</span>]</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>df_by_month <span class="op">=</span> df[df[<span class="st">'Group'</span>] <span class="op">==</span> <span class="st">'By Month'</span>]</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>df_by_year <span class="op">=</span> df[df[<span class="st">'Group'</span>] <span class="op">==</span> <span class="st">'By Year'</span>]</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Write the DataFrames to separate CSV files</span></span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>df_by_total.to_csv(<span class="st">'by_total.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>df_by_month.to_csv(<span class="st">'by_month.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>df_by_year.to_csv(<span class="st">'by_year.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> state_comparison():</span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># List of U.S. states</span></span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>    us_states <span class="op">=</span> [</span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Alabama'</span>, <span class="st">'Alaska'</span>, <span class="st">'Arizona'</span>, <span class="st">'Arkansas'</span>, <span class="st">'California'</span>, <span class="st">'Colorado'</span>, <span class="st">'Connecticut'</span>,</span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Delaware'</span>, <span class="st">'Florida'</span>, <span class="st">'Georgia'</span>, <span class="st">'Hawaii'</span>, <span class="st">'Idaho'</span>, <span class="st">'Illinois'</span>, <span class="st">'Indiana'</span>, <span class="st">'Iowa'</span>,</span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Kansas'</span>, <span class="st">'Kentucky'</span>, <span class="st">'Louisiana'</span>, <span class="st">'Maine'</span>, <span class="st">'Maryland'</span>, <span class="st">'Massachusetts'</span>, <span class="st">'Michigan'</span>,</span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Minnesota'</span>, <span class="st">'Mississippi'</span>, <span class="st">'Missouri'</span>, <span class="st">'Montana'</span>, <span class="st">'Nebraska'</span>, <span class="st">'Nevada'</span>, <span class="st">'New Hampshire'</span>,</span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>        <span class="st">'New Jersey'</span>, <span class="st">'New Mexico'</span>, <span class="st">'New York'</span>, <span class="st">'North Carolina'</span>, <span class="st">'North Dakota'</span>, <span class="st">'Ohio'</span>, <span class="st">'Oklahoma'</span>,</span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Oregon'</span>, <span class="st">'Pennsylvania'</span>, <span class="st">'Rhode Island'</span>, <span class="st">'South Carolina'</span>, <span class="st">'South Dakota'</span>, <span class="st">'Tennessee'</span>,</span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Texas'</span>, <span class="st">'Utah'</span>, <span class="st">'Vermont'</span>, <span class="st">'Virginia'</span>, <span class="st">'Washington'</span>, <span class="st">'West Virginia'</span>, <span class="st">'Wisconsin'</span>, <span class="st">'Wyoming'</span></span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Read the CSV file</span></span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>    input_file <span class="op">=</span> <span class="st">'by_year.csv'</span></span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(input_file)</span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract unique state values from the 'State' column</span></span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a>    unique_states_in_csv <span class="op">=</span> df[<span class="st">'State'</span>].unique()</span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compare the unique state values with the U.S. states list</span></span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a>    missing_states <span class="op">=</span> <span class="bu">set</span>(us_states) <span class="op">-</span> <span class="bu">set</span>(unique_states_in_csv)</span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a>    extra_states <span class="op">=</span> <span class="bu">set</span>(unique_states_in_csv) <span class="op">-</span> <span class="bu">set</span>(us_states)</span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Missing states:"</span>, missing_states)</span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Extra states:"</span>, extra_states)</span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> state_filter(filename):</span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Read the input CSV file</span></span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a>    <span class="co">#input_file = 'Conditions_Contributing_to_COVID-19_Deaths__by_State_and_Age__Provisional_2020-2023.csv'</span></span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(filename)</span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-75"><a href="#cb14-75" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter out rows with 'State' column having the value 'Puerto Rico'</span></span>
<span id="cb14-76"><a href="#cb14-76" aria-hidden="true" tabindex="-1"></a>    filtered_df <span class="op">=</span> df[df[<span class="st">'State'</span>] <span class="op">!=</span> <span class="st">'Puerto Rico'</span>]</span>
<span id="cb14-77"><a href="#cb14-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-78"><a href="#cb14-78" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Write the filtered DataFrame to a new CSV file</span></span>
<span id="cb14-79"><a href="#cb14-79" aria-hidden="true" tabindex="-1"></a>    output_file <span class="op">=</span> <span class="st">'filtered_'</span> <span class="op">+</span> filename</span>
<span id="cb14-80"><a href="#cb14-80" aria-hidden="true" tabindex="-1"></a>    filtered_df.to_csv(output_file, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb14-81"><a href="#cb14-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-82"><a href="#cb14-82" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">'__main__'</span>:</span>
<span id="cb14-83"><a href="#cb14-83" aria-hidden="true" tabindex="-1"></a>    <span class="co">#state_comparison()</span></span>
<span id="cb14-84"><a href="#cb14-84" aria-hidden="true" tabindex="-1"></a>    <span class="co">#state_filter('by_month.csv')</span></span>
<span id="cb14-85"><a href="#cb14-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-86"><a href="#cb14-86" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-87"><a href="#cb14-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-88"><a href="#cb14-88" aria-hidden="true" tabindex="-1"></a>In the data preparation stage, I utilized Python to divide the entire CSV file into three separate subfiles based on the granularity of time - by total, by year, and by month. I then applied a filter to verify the validity of values under the 'State' column. An unexpected subset for 'Puerto Rico' was discovered and subsequently discarded. Additionally, 'District of Columbia' and 'New York City' were singled out from the states.</span>
<span id="cb14-89"><a href="#cb14-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-90"><a href="#cb14-90" aria-hidden="true" tabindex="-1"></a>To plot the choropleth, I found a mapping function for R that geocodes state names, including 'District of Columbia,' into a map with regions represented by longitudes and latitudes. Unfortunately, the function did not include New York City, so I had to exclude this part of the data when creating the choropleth visualization.</span>
<span id="cb14-91"><a href="#cb14-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-92"><a href="#cb14-92" aria-hidden="true" tabindex="-1"></a>In addition to these preprocessing steps, I carried out further data cleansing tasks using Python, tailored to the specific requirements of each visualization task.</span>
<span id="cb14-93"><a href="#cb14-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-94"><a href="#cb14-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-95"><a href="#cb14-95" aria-hidden="true" tabindex="-1"></a><span class="fu"># Visualizations</span></span>
<span id="cb14-96"><a href="#cb14-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-97"><a href="#cb14-97" aria-hidden="true" tabindex="-1"></a><span class="fu">## Bar Chart for COVID-19 Deaths by State and Age Group</span></span>
<span id="cb14-98"><a href="#cb14-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-101"><a href="#cb14-101" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-102"><a href="#cb14-102" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb14-103"><a href="#cb14-103" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: false</span></span>
<span id="cb14-104"><a href="#cb14-104" aria-hidden="true" tabindex="-1"></a><span class="co">#library(viridisLite)</span></span>
<span id="cb14-105"><a href="#cb14-105" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(viridis)</span>
<span id="cb14-106"><a href="#cb14-106" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-107"><a href="#cb14-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-110"><a href="#cb14-110" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-111"><a href="#cb14-111" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb14-112"><a href="#cb14-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-113"><a href="#cb14-113" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the CSV file</span></span>
<span id="cb14-114"><a href="#cb14-114" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"./piechart/filtered_by_total.csv"</span>)</span>
<span id="cb14-115"><a href="#cb14-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-116"><a href="#cb14-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-117"><a href="#cb14-117" aria-hidden="true" tabindex="-1"></a><span class="co"># Group the data by state and age group</span></span>
<span id="cb14-118"><a href="#cb14-118" aria-hidden="true" tabindex="-1"></a>df_grouped <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(COVID.<span class="fl">19.</span>Deaths <span class="sc">~</span> State <span class="sc">+</span> Age.Group, <span class="at">data =</span> df, sum)</span>
<span id="cb14-119"><a href="#cb14-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-120"><a href="#cb14-120" aria-hidden="true" tabindex="-1"></a><span class="co"># Exclude the "United States" rows</span></span>
<span id="cb14-121"><a href="#cb14-121" aria-hidden="true" tabindex="-1"></a>df_grouped <span class="ot">&lt;-</span> <span class="fu">subset</span>(df_grouped, State <span class="sc">!=</span> <span class="st">"United States"</span>)</span>
<span id="cb14-122"><a href="#cb14-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-123"><a href="#cb14-123" aria-hidden="true" tabindex="-1"></a><span class="co"># Order the states by total number of deaths</span></span>
<span id="cb14-124"><a href="#cb14-124" aria-hidden="true" tabindex="-1"></a>state_order <span class="ot">&lt;-</span> <span class="fu">with</span>(df_grouped, <span class="fu">reorder</span>(State, <span class="sc">-</span>COVID.<span class="fl">19.</span>Deaths, sum))</span>
<span id="cb14-125"><a href="#cb14-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-126"><a href="#cb14-126" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the stacked bar chart</span></span>
<span id="cb14-127"><a href="#cb14-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-128"><a href="#cb14-128" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_grouped, <span class="fu">aes</span>(<span class="at">x =</span> state_order, <span class="at">y =</span> COVID.<span class="fl">19.</span>Deaths, <span class="at">fill =</span> Age.Group)) <span class="sc">+</span></span>
<span id="cb14-129"><a href="#cb14-129" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb14-130"><a href="#cb14-130" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"COVID-19 Deaths by State and Age Group"</span>) <span class="sc">+</span></span>
<span id="cb14-131"><a href="#cb14-131" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"State"</span>) <span class="sc">+</span></span>
<span id="cb14-132"><a href="#cb14-132" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Number of Deaths"</span>) <span class="sc">+</span></span>
<span id="cb14-133"><a href="#cb14-133" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb14-134"><a href="#cb14-134" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>) <span class="sc">+</span></span>
<span id="cb14-135"><a href="#cb14-135" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill=</span><span class="fu">guide_legend</span>(<span class="at">title=</span><span class="st">"Age Group"</span>)) <span class="sc">+</span></span>
<span id="cb14-136"><a href="#cb14-136" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis</span>(<span class="at">discrete =</span> <span class="cn">TRUE</span>, <span class="at">option =</span> <span class="st">"viridis"</span>, <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb14-137"><a href="#cb14-137" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-138"><a href="#cb14-138" aria-hidden="true" tabindex="-1"></a>This visualization presents data from the *"Conditions Contributing to COVID-19 Deaths, by State and Age, Provisional 2020-2023"* dataset, which provides information on the number of COVID-19 deaths by state, age group, and time period. This visualization focuses on the total number of COVID-19 deaths by state and age group, using data from the "By Total" time period.</span>
<span id="cb14-139"><a href="#cb14-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-140"><a href="#cb14-140" aria-hidden="true" tabindex="-1"></a>The bars in the chart represent the total number of COVID-19 deaths for each state and age group, with the color of each bar indicating the age group. The chart allows for easy comparison of the number of COVID-19 deaths between different states and age groups, with the height of each bar corresponding to the number of deaths.</span>
<span id="cb14-141"><a href="#cb14-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-142"><a href="#cb14-142" aria-hidden="true" tabindex="-1"></a>To provide a clear representation of the data, the information for the United States as a whole has been filtered out from the visualization. This is because including it would compress the height of individual state bars, making it difficult to distinguish between the states.</span>
<span id="cb14-143"><a href="#cb14-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-144"><a href="#cb14-144" aria-hidden="true" tabindex="-1"></a><span class="fu">## Animated Visualization for COVID-19 Deaths in Each State</span></span>
<span id="cb14-145"><a href="#cb14-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-148"><a href="#cb14-148" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb14-149"><a href="#cb14-149" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb14-150"><a href="#cb14-150" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb14-151"><a href="#cb14-151" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb14-152"><a href="#cb14-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-153"><a href="#cb14-153" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the CSV file</span></span>
<span id="cb14-154"><a href="#cb14-154" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">"filtered_by_month.csv"</span>)</span>
<span id="cb14-155"><a href="#cb14-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-156"><a href="#cb14-156" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the US states list</span></span>
<span id="cb14-157"><a href="#cb14-157" aria-hidden="true" tabindex="-1"></a>us_states <span class="op">=</span> [<span class="st">'District of Columbia'</span>, <span class="st">'New York City'</span>, <span class="st">'Alabama'</span>, <span class="st">'Alaska'</span>, <span class="st">'Arizona'</span>, <span class="st">'Arkansas'</span>, </span>
<span id="cb14-158"><a href="#cb14-158" aria-hidden="true" tabindex="-1"></a>             <span class="st">'California'</span>, <span class="st">'Colorado'</span>, <span class="st">'Connecticut'</span>, <span class="st">'Delaware'</span>, <span class="st">'Florida'</span>, <span class="st">'Georgia'</span>, <span class="st">'Hawaii'</span>, <span class="st">'Idaho'</span>, <span class="st">'Illinois'</span>, </span>
<span id="cb14-159"><a href="#cb14-159" aria-hidden="true" tabindex="-1"></a>             <span class="st">'Indiana'</span>, <span class="st">'Iowa'</span>, <span class="st">'Kansas'</span>, <span class="st">'Kentucky'</span>, <span class="st">'Louisiana'</span>, <span class="st">'Maine'</span>, <span class="st">'Maryland'</span>, <span class="st">'Massachusetts'</span>, <span class="st">'Michigan'</span>,</span>
<span id="cb14-160"><a href="#cb14-160" aria-hidden="true" tabindex="-1"></a>             <span class="st">'Minnesota'</span>, <span class="st">'Mississippi'</span>, <span class="st">'Missouri'</span>, <span class="st">'Montana'</span>, <span class="st">'Nebraska'</span>, <span class="st">'Nevada'</span>, <span class="st">'New Hampshire'</span>, <span class="st">'New Jersey'</span>,</span>
<span id="cb14-161"><a href="#cb14-161" aria-hidden="true" tabindex="-1"></a>             <span class="st">'New Mexico'</span>, <span class="st">'New York'</span>, <span class="st">'North Carolina'</span>, <span class="st">'North Dakota'</span>, <span class="st">'Ohio'</span>, <span class="st">'Oklahoma'</span>, <span class="st">'Oregon'</span>, <span class="st">'Pennsylvania'</span>,</span>
<span id="cb14-162"><a href="#cb14-162" aria-hidden="true" tabindex="-1"></a>             <span class="st">'Rhode Island'</span>, <span class="st">'South Carolina'</span>, <span class="st">'South Dakota'</span>, <span class="st">'Tennessee'</span>, <span class="st">'Texas'</span>, <span class="st">'Utah'</span>, <span class="st">'Vermont'</span>, <span class="st">'Virginia'</span>,</span>
<span id="cb14-163"><a href="#cb14-163" aria-hidden="true" tabindex="-1"></a>             <span class="st">'Washington'</span>, <span class="st">'West Virginia'</span>, <span class="st">'Wisconsin'</span>, <span class="st">'Wyoming'</span>]</span>
<span id="cb14-164"><a href="#cb14-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-165"><a href="#cb14-165" aria-hidden="true" tabindex="-1"></a><span class="co"># Exclude rows where the 'name' column is 'United States'</span></span>
<span id="cb14-166"><a href="#cb14-166" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df[df[<span class="st">'State'</span>] <span class="op">!=</span> <span class="st">'United States'</span>]</span>
<span id="cb14-167"><a href="#cb14-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-168"><a href="#cb14-168" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the necessary columns and rename them</span></span>
<span id="cb14-169"><a href="#cb14-169" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df[[<span class="st">'Start Date'</span>, <span class="st">'State'</span>, <span class="st">'COVID-19 Deaths'</span>]]</span>
<span id="cb14-170"><a href="#cb14-170" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.rename(columns<span class="op">=</span>{<span class="st">'Start Date'</span>: <span class="st">'date'</span>, <span class="st">'State'</span>: <span class="st">'name'</span>, <span class="st">'COVID-19 Deaths'</span>: <span class="st">'value'</span>})</span>
<span id="cb14-171"><a href="#cb14-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-172"><a href="#cb14-172" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the date column to datetime format</span></span>
<span id="cb14-173"><a href="#cb14-173" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'date'</span>] <span class="op">=</span> pd.to_datetime(df[<span class="st">'date'</span>], <span class="bu">format</span><span class="op">=</span><span class="st">'%m/</span><span class="sc">%d</span><span class="st">/%Y'</span>)</span>
<span id="cb14-174"><a href="#cb14-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-175"><a href="#cb14-175" aria-hidden="true" tabindex="-1"></a><span class="co"># Format the date column as '1970-01-01'</span></span>
<span id="cb14-176"><a href="#cb14-176" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'date'</span>] <span class="op">=</span> df[<span class="st">'date'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: x.strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>))</span>
<span id="cb14-177"><a href="#cb14-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-178"><a href="#cb14-178" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the category column using the US states list</span></span>
<span id="cb14-179"><a href="#cb14-179" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'category'</span>] <span class="op">=</span> df[<span class="st">'name'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: us_states.index(x))</span>
<span id="cb14-180"><a href="#cb14-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-181"><a href="#cb14-181" aria-hidden="true" tabindex="-1"></a><span class="co"># Group the data by date, name, and category, and sum the values</span></span>
<span id="cb14-182"><a href="#cb14-182" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.groupby([<span class="st">'date'</span>, <span class="st">'name'</span>, <span class="st">'category'</span>], as_index<span class="op">=</span><span class="va">False</span>).<span class="bu">sum</span>()</span>
<span id="cb14-183"><a href="#cb14-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-184"><a href="#cb14-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-185"><a href="#cb14-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-186"><a href="#cb14-186" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the index column and reorder the columns</span></span>
<span id="cb14-187"><a href="#cb14-187" aria-hidden="true" tabindex="-1"></a>df.insert(<span class="dv">0</span>, <span class="st">'index'</span>, <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(df) <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb14-188"><a href="#cb14-188" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df[[<span class="st">'index'</span>, <span class="st">'date'</span>, <span class="st">'name'</span>, <span class="st">'category'</span>, <span class="st">'value'</span>]]</span>
<span id="cb14-189"><a href="#cb14-189" aria-hidden="true" tabindex="-1"></a><span class="co"># Cast the index and name columns to string</span></span>
<span id="cb14-190"><a href="#cb14-190" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'index'</span>] <span class="op">=</span> df[<span class="st">'index'</span>].astype(<span class="bu">str</span>)</span>
<span id="cb14-191"><a href="#cb14-191" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'name'</span>] <span class="op">=</span> df[<span class="st">'name'</span>].astype(<span class="bu">str</span>)</span>
<span id="cb14-192"><a href="#cb14-192" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the output to a CSV file</span></span>
<span id="cb14-193"><a href="#cb14-193" aria-hidden="true" tabindex="-1"></a>df.to_csv(<span class="st">'./horizontal/output.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb14-194"><a href="#cb14-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-195"><a href="#cb14-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-196"><a href="#cb14-196" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb14-197"><a href="#cb14-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-198"><a href="#cb14-198" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the CSV file</span></span>
<span id="cb14-199"><a href="#cb14-199" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'output.csv'</span>, <span class="st">'r'</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb14-200"><a href="#cb14-200" aria-hidden="true" tabindex="-1"></a>    csv_data <span class="op">=</span> <span class="bu">file</span>.read()</span>
<span id="cb14-201"><a href="#cb14-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-202"><a href="#cb14-202" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the regex pattern</span></span>
<span id="cb14-203"><a href="#cb14-203" aria-hidden="true" tabindex="-1"></a>pattern <span class="op">=</span> <span class="vs">r'(?&lt;=,)([a-zA-Z ]+)(?=,)'</span></span>
<span id="cb14-204"><a href="#cb14-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-205"><a href="#cb14-205" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the replacement string</span></span>
<span id="cb14-206"><a href="#cb14-206" aria-hidden="true" tabindex="-1"></a>replace_str <span class="op">=</span> <span class="vs">r'"\1"'</span></span>
<span id="cb14-207"><a href="#cb14-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-208"><a href="#cb14-208" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace the matches with the original text enclosed in quotes</span></span>
<span id="cb14-209"><a href="#cb14-209" aria-hidden="true" tabindex="-1"></a>csv_data <span class="op">=</span> re.sub(pattern, replace_str, csv_data)</span>
<span id="cb14-210"><a href="#cb14-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-211"><a href="#cb14-211" aria-hidden="true" tabindex="-1"></a><span class="co"># Write the updated CSV file</span></span>
<span id="cb14-212"><a href="#cb14-212" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'output2.csv'</span>, <span class="st">'w'</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb14-213"><a href="#cb14-213" aria-hidden="true" tabindex="-1"></a>    <span class="bu">file</span>.write(csv_data)</span>
<span id="cb14-214"><a href="#cb14-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-215"><a href="#cb14-215" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-216"><a href="#cb14-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-217"><a href="#cb14-217" aria-hidden="true" tabindex="-1"></a>This visualization required significant data cleansing and adjustments to the code, which I didn't initially expect. I used the <span class="co">[</span><span class="ot">`Zomstates.csv`</span><span class="co">](https://github.com/ProfessorPolymorphic/RobisonWebSite/blob/master/BCB520/posts/T8-MidtermExample/Zomstates.csv)</span> as a reference to modify my csv file. I also employed regular expressions to add quotes around the State names to prevent spaces from causing issues in the code.</span>
<span id="cb14-218"><a href="#cb14-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-219"><a href="#cb14-219" aria-hidden="true" tabindex="-1"></a>Moreover, the visualization didn't work correctly when copying and pasting from the <span class="co">[</span><span class="ot">`.qmd ` file</span><span class="co">](https://github.com/ProfessorPolymorphic/RobisonWebSite/blob/master/BCB520/posts/T8-MidtermExample/index.qmd)</span>. I made a modification in the function bars(svg) as follows:</span>
<span id="cb14-220"><a href="#cb14-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-221"><a href="#cb14-221" aria-hidden="true" tabindex="-1"></a><span class="in">        &lt;!-- .attr("x", x(0)) --&gt;</span></span>
<span id="cb14-222"><a href="#cb14-222" aria-hidden="true" tabindex="-1"></a><span class="in">        .attr("x", -6)</span></span>
<span id="cb14-223"><a href="#cb14-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-224"><a href="#cb14-224" aria-hidden="true" tabindex="-1"></a>The variable x(0) appeared unstable, causing many of the bars' x-axis positions to shift towards the center of the screen. Only a small portion of the data functioned correctly, starting from the left margin. I'm not entirely sure, but -6 might be related to the margin variable. Without this modification, the bars would start from the middle of the graph.</span>
<span id="cb14-225"><a href="#cb14-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-226"><a href="#cb14-226" aria-hidden="true" tabindex="-1"></a>I also found that the original animation speed was too fast for my data compared to the initial zombie data. I increased the duration tenfold to 250.</span>
<span id="cb14-227"><a href="#cb14-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-230"><a href="#cb14-230" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb14-231"><a href="#cb14-231" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> d3<span class="op">.</span><span class="fu">csvParse</span>(<span class="cf">await</span> <span class="fu">FileAttachment</span>(<span class="st">"./horizontal/output2.csv"</span>)<span class="op">.</span><span class="fu">text</span>()<span class="op">,</span> d3<span class="op">.</span><span class="at">autoType</span>)</span>
<span id="cb14-232"><a href="#cb14-232" aria-hidden="true" tabindex="-1"></a>viewof replay <span class="op">=</span> <span class="fu">html</span><span class="vs">`&lt;button&gt;Replay`</span></span>
<span id="cb14-233"><a href="#cb14-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-234"><a href="#cb14-234" aria-hidden="true" tabindex="-1"></a><span class="vs">```</span></span>
<span id="cb14-235"><a href="#cb14-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-238"><a href="#cb14-238" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb14-239"><a href="#cb14-239" aria-hidden="true" tabindex="-1"></a>chart <span class="op">=</span> {</span>
<span id="cb14-240"><a href="#cb14-240" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-241"><a href="#cb14-241" aria-hidden="true" tabindex="-1"></a>  replay<span class="op">;</span></span>
<span id="cb14-242"><a href="#cb14-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-243"><a href="#cb14-243" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> svg <span class="op">=</span> d3<span class="op">.</span><span class="fu">create</span>(<span class="st">"svg"</span>)</span>
<span id="cb14-244"><a href="#cb14-244" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"viewBox"</span><span class="op">,</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> width<span class="op">,</span> height])<span class="op">;</span></span>
<span id="cb14-245"><a href="#cb14-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-246"><a href="#cb14-246" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> updateBars <span class="op">=</span> <span class="fu">bars</span>(svg)<span class="op">;</span></span>
<span id="cb14-247"><a href="#cb14-247" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> updateAxis <span class="op">=</span> <span class="fu">axis</span>(svg)<span class="op">;</span></span>
<span id="cb14-248"><a href="#cb14-248" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> updateLabels <span class="op">=</span> <span class="fu">labels</span>(svg)<span class="op">;</span></span>
<span id="cb14-249"><a href="#cb14-249" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> updateTicker <span class="op">=</span> <span class="fu">ticker</span>(svg)<span class="op">;</span></span>
<span id="cb14-250"><a href="#cb14-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-251"><a href="#cb14-251" aria-hidden="true" tabindex="-1"></a>  <span class="kw">yield</span> svg<span class="op">.</span><span class="fu">node</span>()<span class="op">;</span></span>
<span id="cb14-252"><a href="#cb14-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-253"><a href="#cb14-253" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">const</span> keyframe <span class="kw">of</span> keyframes) {</span>
<span id="cb14-254"><a href="#cb14-254" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> transition <span class="op">=</span> svg<span class="op">.</span><span class="fu">transition</span>()</span>
<span id="cb14-255"><a href="#cb14-255" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">duration</span>(duration)</span>
<span id="cb14-256"><a href="#cb14-256" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">ease</span>(d3<span class="op">.</span><span class="at">easeLinear</span>)<span class="op">;</span></span>
<span id="cb14-257"><a href="#cb14-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-258"><a href="#cb14-258" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Extract the top bar’s value.</span></span>
<span id="cb14-259"><a href="#cb14-259" aria-hidden="true" tabindex="-1"></a>    x<span class="op">.</span><span class="fu">domain</span>([<span class="dv">0</span><span class="op">,</span> keyframe[<span class="dv">1</span>][<span class="dv">0</span>]<span class="op">.</span><span class="at">value</span>])<span class="op">;</span></span>
<span id="cb14-260"><a href="#cb14-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-261"><a href="#cb14-261" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updateAxis</span>(keyframe<span class="op">,</span> transition)<span class="op">;</span></span>
<span id="cb14-262"><a href="#cb14-262" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updateBars</span>(keyframe<span class="op">,</span> transition)<span class="op">;</span></span>
<span id="cb14-263"><a href="#cb14-263" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updateLabels</span>(keyframe<span class="op">,</span> transition)<span class="op">;</span></span>
<span id="cb14-264"><a href="#cb14-264" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updateTicker</span>(keyframe<span class="op">,</span> transition)<span class="op">;</span></span>
<span id="cb14-265"><a href="#cb14-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-266"><a href="#cb14-266" aria-hidden="true" tabindex="-1"></a>    invalidation<span class="op">.</span><span class="fu">then</span>(() <span class="kw">=&gt;</span> svg<span class="op">.</span><span class="fu">interrupt</span>())<span class="op">;</span></span>
<span id="cb14-267"><a href="#cb14-267" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> transition<span class="op">.</span><span class="fu">end</span>()<span class="op">;</span></span>
<span id="cb14-268"><a href="#cb14-268" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-269"><a href="#cb14-269" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-270"><a href="#cb14-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-271"><a href="#cb14-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-272"><a href="#cb14-272" aria-hidden="true" tabindex="-1"></a>duration <span class="op">=</span> <span class="dv">250</span></span>
<span id="cb14-273"><a href="#cb14-273" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="dv">50</span></span>
<span id="cb14-274"><a href="#cb14-274" aria-hidden="true" tabindex="-1"></a>k <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb14-275"><a href="#cb14-275" aria-hidden="true" tabindex="-1"></a>names <span class="op">=</span> <span class="kw">new</span> <span class="bu">Set</span>(data<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">name</span>))</span>
<span id="cb14-276"><a href="#cb14-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-277"><a href="#cb14-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-278"><a href="#cb14-278" aria-hidden="true" tabindex="-1"></a>datevalues <span class="op">=</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(d3<span class="op">.</span><span class="fu">rollup</span>(data<span class="op">,</span> ([d]) <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">value</span><span class="op">,</span> d <span class="kw">=&gt;</span> <span class="op">+</span>d<span class="op">.</span><span class="at">date</span><span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">name</span>))</span>
<span id="cb14-279"><a href="#cb14-279" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(([date<span class="op">,</span> data]) <span class="kw">=&gt;</span> [<span class="kw">new</span> <span class="bu">Date</span>(date)<span class="op">,</span> data])</span>
<span id="cb14-280"><a href="#cb14-280" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">sort</span>(([a]<span class="op">,</span> [b]) <span class="kw">=&gt;</span> d3<span class="op">.</span><span class="fu">ascending</span>(a<span class="op">,</span> b))</span>
<span id="cb14-281"><a href="#cb14-281" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-282"><a href="#cb14-282" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-283"><a href="#cb14-283" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">rank</span>(value) {</span>
<span id="cb14-284"><a href="#cb14-284" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> data <span class="op">=</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(names<span class="op">,</span> name <span class="kw">=&gt;</span> ({name<span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="fu">value</span>(name)}))<span class="op">;</span></span>
<span id="cb14-285"><a href="#cb14-285" aria-hidden="true" tabindex="-1"></a>  data<span class="op">.</span><span class="fu">sort</span>((a<span class="op">,</span> b) <span class="kw">=&gt;</span> d3<span class="op">.</span><span class="fu">descending</span>(a<span class="op">.</span><span class="at">value</span><span class="op">,</span> b<span class="op">.</span><span class="at">value</span>))<span class="op">;</span></span>
<span id="cb14-286"><a href="#cb14-286" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> data<span class="op">.</span><span class="at">length</span><span class="op">;</span> <span class="op">++</span>i) data[i]<span class="op">.</span><span class="at">rank</span> <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">min</span>(n<span class="op">,</span> i)<span class="op">;</span></span>
<span id="cb14-287"><a href="#cb14-287" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> data<span class="op">;</span></span>
<span id="cb14-288"><a href="#cb14-288" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-289"><a href="#cb14-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-290"><a href="#cb14-290" aria-hidden="true" tabindex="-1"></a>keyframes <span class="op">=</span> {</span>
<span id="cb14-291"><a href="#cb14-291" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> keyframes <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb14-292"><a href="#cb14-292" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> ka<span class="op">,</span> a<span class="op">,</span> kb<span class="op">,</span> b<span class="op">;</span></span>
<span id="cb14-293"><a href="#cb14-293" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> ([[ka<span class="op">,</span> a]<span class="op">,</span> [kb<span class="op">,</span> b]] <span class="kw">of</span> d3<span class="op">.</span><span class="fu">pairs</span>(datevalues)) {</span>
<span id="cb14-294"><a href="#cb14-294" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> k<span class="op">;</span> <span class="op">++</span>i) {</span>
<span id="cb14-295"><a href="#cb14-295" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> t <span class="op">=</span> i <span class="op">/</span> k<span class="op">;</span></span>
<span id="cb14-296"><a href="#cb14-296" aria-hidden="true" tabindex="-1"></a>      keyframes<span class="op">.</span><span class="fu">push</span>([</span>
<span id="cb14-297"><a href="#cb14-297" aria-hidden="true" tabindex="-1"></a>        <span class="kw">new</span> <span class="bu">Date</span>(ka <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> t) <span class="op">+</span> kb <span class="op">*</span> t)<span class="op">,</span></span>
<span id="cb14-298"><a href="#cb14-298" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rank</span>(name <span class="kw">=&gt;</span> (a<span class="op">.</span><span class="fu">get</span>(name) <span class="op">||</span> <span class="dv">0</span>) <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> t) <span class="op">+</span> (b<span class="op">.</span><span class="fu">get</span>(name) <span class="op">||</span> <span class="dv">0</span>) <span class="op">*</span> t)</span>
<span id="cb14-299"><a href="#cb14-299" aria-hidden="true" tabindex="-1"></a>      ])<span class="op">;</span></span>
<span id="cb14-300"><a href="#cb14-300" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-301"><a href="#cb14-301" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-302"><a href="#cb14-302" aria-hidden="true" tabindex="-1"></a>  keyframes<span class="op">.</span><span class="fu">push</span>([<span class="kw">new</span> <span class="bu">Date</span>(kb)<span class="op">,</span> <span class="fu">rank</span>(name <span class="kw">=&gt;</span> b<span class="op">.</span><span class="fu">get</span>(name) <span class="op">||</span> <span class="dv">0</span>)])<span class="op">;</span></span>
<span id="cb14-303"><a href="#cb14-303" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> keyframes<span class="op">;</span></span>
<span id="cb14-304"><a href="#cb14-304" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-305"><a href="#cb14-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-306"><a href="#cb14-306" aria-hidden="true" tabindex="-1"></a>nameframes <span class="op">=</span> d3<span class="op">.</span><span class="fu">groups</span>(keyframes<span class="op">.</span><span class="fu">flatMap</span>(([<span class="op">,</span> data]) <span class="kw">=&gt;</span> data)<span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">name</span>)</span>
<span id="cb14-307"><a href="#cb14-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-308"><a href="#cb14-308" aria-hidden="true" tabindex="-1"></a>prev <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>(nameframes<span class="op">.</span><span class="fu">flatMap</span>(([<span class="op">,</span> data]) <span class="kw">=&gt;</span> d3<span class="op">.</span><span class="fu">pairs</span>(data<span class="op">,</span> (a<span class="op">,</span> b) <span class="kw">=&gt;</span> [b<span class="op">,</span> a])))</span>
<span id="cb14-309"><a href="#cb14-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-310"><a href="#cb14-310" aria-hidden="true" tabindex="-1"></a>next <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>(nameframes<span class="op">.</span><span class="fu">flatMap</span>(([<span class="op">,</span> data]) <span class="kw">=&gt;</span> d3<span class="op">.</span><span class="fu">pairs</span>(data)))</span>
<span id="cb14-311"><a href="#cb14-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-312"><a href="#cb14-312" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">bars</span>(svg) {</span>
<span id="cb14-313"><a href="#cb14-313" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> bar <span class="op">=</span> svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)</span>
<span id="cb14-314"><a href="#cb14-314" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill-opacity"</span><span class="op">,</span> <span class="fl">0.6</span>)</span>
<span id="cb14-315"><a href="#cb14-315" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"rect"</span>)<span class="op">;</span></span>
<span id="cb14-316"><a href="#cb14-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-317"><a href="#cb14-317" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> ([date<span class="op">,</span> data]<span class="op">,</span> transition) <span class="kw">=&gt;</span> bar <span class="op">=</span> bar</span>
<span id="cb14-318"><a href="#cb14-318" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">data</span>(data<span class="op">.</span><span class="fu">slice</span>(<span class="dv">0</span><span class="op">,</span> n)<span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">name</span>)</span>
<span id="cb14-319"><a href="#cb14-319" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">join</span>(</span>
<span id="cb14-320"><a href="#cb14-320" aria-hidden="true" tabindex="-1"></a>      enter <span class="kw">=&gt;</span> enter<span class="op">.</span><span class="fu">append</span>(<span class="st">"rect"</span>)</span>
<span id="cb14-321"><a href="#cb14-321" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill"</span><span class="op">,</span> color)</span>
<span id="cb14-322"><a href="#cb14-322" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"height"</span><span class="op">,</span> y<span class="op">.</span><span class="fu">bandwidth</span>())</span>
<span id="cb14-323"><a href="#cb14-323" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;!--</span> <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> <span class="fu">x</span>(<span class="dv">0</span>)) <span class="op">--&gt;</span></span>
<span id="cb14-324"><a href="#cb14-324" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> <span class="op">-</span><span class="dv">6</span>)</span>
<span id="cb14-325"><a href="#cb14-325" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> d <span class="kw">=&gt;</span> <span class="fu">y</span>((prev<span class="op">.</span><span class="fu">get</span>(d) <span class="op">||</span> d)<span class="op">.</span><span class="at">rank</span>))</span>
<span id="cb14-326"><a href="#cb14-326" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"width"</span><span class="op">,</span> d <span class="kw">=&gt;</span> <span class="fu">x</span>((prev<span class="op">.</span><span class="fu">get</span>(d) <span class="op">||</span> d)<span class="op">.</span><span class="at">value</span>) <span class="op">-</span> <span class="fu">x</span>(<span class="dv">0</span>))<span class="op">,</span></span>
<span id="cb14-327"><a href="#cb14-327" aria-hidden="true" tabindex="-1"></a>      update <span class="kw">=&gt;</span> update<span class="op">,</span></span>
<span id="cb14-328"><a href="#cb14-328" aria-hidden="true" tabindex="-1"></a>      exit <span class="kw">=&gt;</span> exit<span class="op">.</span><span class="fu">transition</span>(transition)<span class="op">.</span><span class="fu">remove</span>()</span>
<span id="cb14-329"><a href="#cb14-329" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> d <span class="kw">=&gt;</span> <span class="fu">y</span>((next<span class="op">.</span><span class="fu">get</span>(d) <span class="op">||</span> d)<span class="op">.</span><span class="at">rank</span>))</span>
<span id="cb14-330"><a href="#cb14-330" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"width"</span><span class="op">,</span> d <span class="kw">=&gt;</span> <span class="fu">x</span>((next<span class="op">.</span><span class="fu">get</span>(d) <span class="op">||</span> d)<span class="op">.</span><span class="at">value</span>) <span class="op">-</span> <span class="fu">x</span>(<span class="dv">0</span>))</span>
<span id="cb14-331"><a href="#cb14-331" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-332"><a href="#cb14-332" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">call</span>(bar <span class="kw">=&gt;</span> bar<span class="op">.</span><span class="fu">transition</span>(transition)</span>
<span id="cb14-333"><a href="#cb14-333" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> d <span class="kw">=&gt;</span> <span class="fu">y</span>(d<span class="op">.</span><span class="at">rank</span>))</span>
<span id="cb14-334"><a href="#cb14-334" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"width"</span><span class="op">,</span> d <span class="kw">=&gt;</span> <span class="fu">x</span>(d<span class="op">.</span><span class="at">value</span>) <span class="op">-</span> <span class="fu">x</span>(<span class="dv">0</span>)))<span class="op">;</span></span>
<span id="cb14-335"><a href="#cb14-335" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-336"><a href="#cb14-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-337"><a href="#cb14-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-338"><a href="#cb14-338" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">labels</span>(svg) {</span>
<span id="cb14-339"><a href="#cb14-339" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> label <span class="op">=</span> svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)</span>
<span id="cb14-340"><a href="#cb14-340" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">style</span>(<span class="st">"font"</span><span class="op">,</span> <span class="st">"bold 12px var(--sans-serif)"</span>)</span>
<span id="cb14-341"><a href="#cb14-341" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">style</span>(<span class="st">"font-variant-numeric"</span><span class="op">,</span> <span class="st">"tabular-nums"</span>)</span>
<span id="cb14-342"><a href="#cb14-342" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"text-anchor"</span><span class="op">,</span> <span class="st">"end"</span>)</span>
<span id="cb14-343"><a href="#cb14-343" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"text"</span>)<span class="op">;</span></span>
<span id="cb14-344"><a href="#cb14-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-345"><a href="#cb14-345" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> ([date<span class="op">,</span> data]<span class="op">,</span> transition) <span class="kw">=&gt;</span> label <span class="op">=</span> label</span>
<span id="cb14-346"><a href="#cb14-346" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">data</span>(data<span class="op">.</span><span class="fu">slice</span>(<span class="dv">0</span><span class="op">,</span> n)<span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">name</span>)</span>
<span id="cb14-347"><a href="#cb14-347" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">join</span>(</span>
<span id="cb14-348"><a href="#cb14-348" aria-hidden="true" tabindex="-1"></a>      enter <span class="kw">=&gt;</span> enter<span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>)</span>
<span id="cb14-349"><a href="#cb14-349" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"transform"</span><span class="op">,</span> d <span class="kw">=&gt;</span> <span class="vs">`translate(</span><span class="sc">${</span><span class="fu">x</span>((prev<span class="op">.</span><span class="fu">get</span>(d) <span class="op">||</span> d)<span class="op">.</span><span class="at">value</span>)<span class="sc">}</span><span class="vs">,</span><span class="sc">${</span><span class="fu">y</span>((prev<span class="op">.</span><span class="fu">get</span>(d) <span class="op">||</span> d)<span class="op">.</span><span class="at">rank</span>)<span class="sc">}</span><span class="vs">)`</span>)</span>
<span id="cb14-350"><a href="#cb14-350" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> y<span class="op">.</span><span class="fu">bandwidth</span>() <span class="op">/</span> <span class="dv">2</span>)</span>
<span id="cb14-351"><a href="#cb14-351" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> <span class="op">-</span><span class="dv">6</span>)</span>
<span id="cb14-352"><a href="#cb14-352" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"dy"</span><span class="op">,</span> <span class="st">"-0.25em"</span>)</span>
<span id="cb14-353"><a href="#cb14-353" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">text</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">name</span>)</span>
<span id="cb14-354"><a href="#cb14-354" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">call</span>(text <span class="kw">=&gt;</span> text<span class="op">.</span><span class="fu">append</span>(<span class="st">"tspan"</span>)</span>
<span id="cb14-355"><a href="#cb14-355" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill-opacity"</span><span class="op">,</span> <span class="fl">0.7</span>)</span>
<span id="cb14-356"><a href="#cb14-356" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">attr</span>(<span class="st">"font-weight"</span><span class="op">,</span> <span class="st">"normal"</span>)</span>
<span id="cb14-357"><a href="#cb14-357" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> <span class="op">-</span><span class="dv">6</span>)</span>
<span id="cb14-358"><a href="#cb14-358" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">attr</span>(<span class="st">"dy"</span><span class="op">,</span> <span class="st">"1.15em"</span>))<span class="op">,</span></span>
<span id="cb14-359"><a href="#cb14-359" aria-hidden="true" tabindex="-1"></a>      update <span class="kw">=&gt;</span> update<span class="op">,</span></span>
<span id="cb14-360"><a href="#cb14-360" aria-hidden="true" tabindex="-1"></a>      exit <span class="kw">=&gt;</span> exit<span class="op">.</span><span class="fu">transition</span>(transition)<span class="op">.</span><span class="fu">remove</span>()</span>
<span id="cb14-361"><a href="#cb14-361" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"transform"</span><span class="op">,</span> d <span class="kw">=&gt;</span> <span class="vs">`translate(</span><span class="sc">${</span><span class="fu">x</span>((next<span class="op">.</span><span class="fu">get</span>(d) <span class="op">||</span> d)<span class="op">.</span><span class="at">value</span>)<span class="sc">}</span><span class="vs">,</span><span class="sc">${</span><span class="fu">y</span>((next<span class="op">.</span><span class="fu">get</span>(d) <span class="op">||</span> d)<span class="op">.</span><span class="at">rank</span>)<span class="sc">}</span><span class="vs">)`</span>)</span>
<span id="cb14-362"><a href="#cb14-362" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">call</span>(g <span class="kw">=&gt;</span> g<span class="op">.</span><span class="fu">select</span>(<span class="st">"tspan"</span>)<span class="op">.</span><span class="fu">tween</span>(<span class="st">"text"</span><span class="op">,</span> d <span class="kw">=&gt;</span> <span class="fu">textTween</span>(d<span class="op">.</span><span class="at">value</span><span class="op">,</span> (next<span class="op">.</span><span class="fu">get</span>(d) <span class="op">||</span> d)<span class="op">.</span><span class="at">value</span>)))</span>
<span id="cb14-363"><a href="#cb14-363" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-364"><a href="#cb14-364" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">call</span>(bar <span class="kw">=&gt;</span> bar<span class="op">.</span><span class="fu">transition</span>(transition)</span>
<span id="cb14-365"><a href="#cb14-365" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"transform"</span><span class="op">,</span> d <span class="kw">=&gt;</span> <span class="vs">`translate(</span><span class="sc">${</span><span class="fu">x</span>(d<span class="op">.</span><span class="at">value</span>)<span class="sc">}</span><span class="vs">,</span><span class="sc">${</span><span class="fu">y</span>(d<span class="op">.</span><span class="at">rank</span>)<span class="sc">}</span><span class="vs">)`</span>)</span>
<span id="cb14-366"><a href="#cb14-366" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">call</span>(g <span class="kw">=&gt;</span> g<span class="op">.</span><span class="fu">select</span>(<span class="st">"tspan"</span>)<span class="op">.</span><span class="fu">tween</span>(<span class="st">"text"</span><span class="op">,</span> d <span class="kw">=&gt;</span> <span class="fu">textTween</span>((prev<span class="op">.</span><span class="fu">get</span>(d) <span class="op">||</span> d)<span class="op">.</span><span class="at">value</span><span class="op">,</span> d<span class="op">.</span><span class="at">value</span>))))</span>
<span id="cb14-367"><a href="#cb14-367" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-368"><a href="#cb14-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-369"><a href="#cb14-369" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">textTween</span>(a<span class="op">,</span> b) {</span>
<span id="cb14-370"><a href="#cb14-370" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> i <span class="op">=</span> d3<span class="op">.</span><span class="fu">interpolateNumber</span>(a<span class="op">,</span> b)<span class="op">;</span></span>
<span id="cb14-371"><a href="#cb14-371" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="kw">function</span>(t) {</span>
<span id="cb14-372"><a href="#cb14-372" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> <span class="fu">formatNumber</span>(<span class="fu">i</span>(t))<span class="op">;</span></span>
<span id="cb14-373"><a href="#cb14-373" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb14-374"><a href="#cb14-374" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-375"><a href="#cb14-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-376"><a href="#cb14-376" aria-hidden="true" tabindex="-1"></a>formatNumber <span class="op">=</span> d3<span class="op">.</span><span class="fu">format</span>(<span class="st">",d"</span>)</span>
<span id="cb14-377"><a href="#cb14-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-378"><a href="#cb14-378" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">axis</span>(svg) {</span>
<span id="cb14-379"><a href="#cb14-379" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> g <span class="op">=</span> svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)</span>
<span id="cb14-380"><a href="#cb14-380" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"transform"</span><span class="op">,</span> <span class="vs">`translate(0,</span><span class="sc">${</span>margin<span class="op">.</span><span class="at">top</span><span class="sc">}</span><span class="vs">)`</span>)<span class="op">;</span></span>
<span id="cb14-381"><a href="#cb14-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-382"><a href="#cb14-382" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> axis <span class="op">=</span> d3<span class="op">.</span><span class="fu">axisTop</span>(x)</span>
<span id="cb14-383"><a href="#cb14-383" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">ticks</span>(width <span class="op">/</span> <span class="dv">160</span>)</span>
<span id="cb14-384"><a href="#cb14-384" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">tickSizeOuter</span>(<span class="dv">0</span>)</span>
<span id="cb14-385"><a href="#cb14-385" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">tickSizeInner</span>(<span class="op">-</span>barSize <span class="op">*</span> (n <span class="op">+</span> y<span class="op">.</span><span class="fu">padding</span>()))<span class="op">;</span></span>
<span id="cb14-386"><a href="#cb14-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-387"><a href="#cb14-387" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> (_<span class="op">,</span> transition) <span class="kw">=&gt;</span> {</span>
<span id="cb14-388"><a href="#cb14-388" aria-hidden="true" tabindex="-1"></a>    g<span class="op">.</span><span class="fu">transition</span>(transition)<span class="op">.</span><span class="fu">call</span>(axis)<span class="op">;</span></span>
<span id="cb14-389"><a href="#cb14-389" aria-hidden="true" tabindex="-1"></a>    g<span class="op">.</span><span class="fu">select</span>(<span class="st">".tick:first-of-type text"</span>)<span class="op">.</span><span class="fu">remove</span>()<span class="op">;</span></span>
<span id="cb14-390"><a href="#cb14-390" aria-hidden="true" tabindex="-1"></a>    g<span class="op">.</span><span class="fu">selectAll</span>(<span class="st">".tick:not(:first-of-type) line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke"</span><span class="op">,</span> <span class="st">"white"</span>)<span class="op">;</span></span>
<span id="cb14-391"><a href="#cb14-391" aria-hidden="true" tabindex="-1"></a>    g<span class="op">.</span><span class="fu">select</span>(<span class="st">".domain"</span>)<span class="op">.</span><span class="fu">remove</span>()<span class="op">;</span></span>
<span id="cb14-392"><a href="#cb14-392" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb14-393"><a href="#cb14-393" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-394"><a href="#cb14-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-395"><a href="#cb14-395" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">ticker</span>(svg) {</span>
<span id="cb14-396"><a href="#cb14-396" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> now <span class="op">=</span> svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>)</span>
<span id="cb14-397"><a href="#cb14-397" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">style</span>(<span class="st">"font"</span><span class="op">,</span> <span class="vs">`bold </span><span class="sc">${</span>barSize<span class="sc">}</span><span class="vs">px var(--sans-serif)`</span>)</span>
<span id="cb14-398"><a href="#cb14-398" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">style</span>(<span class="st">"font-variant-numeric"</span><span class="op">,</span> <span class="st">"tabular-nums"</span>)</span>
<span id="cb14-399"><a href="#cb14-399" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"text-anchor"</span><span class="op">,</span> <span class="st">"end"</span>)</span>
<span id="cb14-400"><a href="#cb14-400" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> width <span class="op">-</span> <span class="dv">6</span>)</span>
<span id="cb14-401"><a href="#cb14-401" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> margin<span class="op">.</span><span class="at">top</span> <span class="op">+</span> barSize <span class="op">*</span> (n <span class="op">-</span> <span class="fl">0.45</span>))</span>
<span id="cb14-402"><a href="#cb14-402" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"dy"</span><span class="op">,</span> <span class="st">"0.32em"</span>)</span>
<span id="cb14-403"><a href="#cb14-403" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">text</span>(<span class="fu">formatDate</span>(keyframes[<span class="dv">0</span>][<span class="dv">0</span>]))<span class="op">;</span></span>
<span id="cb14-404"><a href="#cb14-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-405"><a href="#cb14-405" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> ([date]<span class="op">,</span> transition) <span class="kw">=&gt;</span> {</span>
<span id="cb14-406"><a href="#cb14-406" aria-hidden="true" tabindex="-1"></a>    transition<span class="op">.</span><span class="fu">end</span>()<span class="op">.</span><span class="fu">then</span>(() <span class="kw">=&gt;</span> now<span class="op">.</span><span class="fu">text</span>(<span class="fu">formatDate</span>(date)))<span class="op">;</span></span>
<span id="cb14-407"><a href="#cb14-407" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb14-408"><a href="#cb14-408" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-409"><a href="#cb14-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-410"><a href="#cb14-410" aria-hidden="true" tabindex="-1"></a>formatDate <span class="op">=</span> d3<span class="op">.</span><span class="fu">utcFormat</span>(<span class="st">"%Y"</span>)</span>
<span id="cb14-411"><a href="#cb14-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-412"><a href="#cb14-412" aria-hidden="true" tabindex="-1"></a>color <span class="op">=</span> {</span>
<span id="cb14-413"><a href="#cb14-413" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> scale <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleSequential</span>(d3<span class="op">.</span><span class="fu">interpolate</span>(<span class="st">"red"</span><span class="op">,</span> <span class="st">"blue"</span>))<span class="op">.</span><span class="fu">domain</span>([<span class="dv">1</span><span class="op">,</span> <span class="dv">48</span>])<span class="op">;</span></span>
<span id="cb14-414"><a href="#cb14-414" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (data<span class="op">.</span><span class="fu">some</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">category</span> <span class="op">!==</span> <span class="kw">undefined</span>)) {</span>
<span id="cb14-415"><a href="#cb14-415" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> categoryByName <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>(data<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> [d<span class="op">.</span><span class="at">name</span><span class="op">,</span> d<span class="op">.</span><span class="at">category</span>]))</span>
<span id="cb14-416"><a href="#cb14-416" aria-hidden="true" tabindex="-1"></a>    scale<span class="op">.</span><span class="fu">domain</span>(<span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(categoryByName<span class="op">.</span><span class="fu">values</span>()))<span class="op">;</span></span>
<span id="cb14-417"><a href="#cb14-417" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> d <span class="kw">=&gt;</span> <span class="fu">scale</span>(categoryByName<span class="op">.</span><span class="fu">get</span>(d<span class="op">.</span><span class="at">name</span>))<span class="op">;</span></span>
<span id="cb14-418"><a href="#cb14-418" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-419"><a href="#cb14-419" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> d <span class="kw">=&gt;</span> <span class="fu">scale</span>(d<span class="op">.</span><span class="at">name</span>)<span class="op">;</span></span>
<span id="cb14-420"><a href="#cb14-420" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-421"><a href="#cb14-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-422"><a href="#cb14-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-423"><a href="#cb14-423" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;!--</span> color <span class="op">=</span> { <span class="op">--&gt;</span></span>
<span id="cb14-424"><a href="#cb14-424" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;!--</span>   <span class="kw">const</span> scale <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleSequential</span>(d3<span class="op">.</span><span class="fu">interpolate</span>(<span class="st">"red"</span><span class="op">,</span> <span class="st">"blue"</span>))<span class="op">.</span><span class="fu">domain</span>([<span class="dv">1</span><span class="op">,</span> <span class="dv">48</span>])<span class="op">;</span> <span class="op">--&gt;</span></span>
<span id="cb14-425"><a href="#cb14-425" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;!--</span>   <span class="cf">if</span> (data<span class="op">.</span><span class="fu">some</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">category</span> <span class="op">!==</span> <span class="kw">undefined</span>)) { <span class="op">--&gt;</span></span>
<span id="cb14-426"><a href="#cb14-426" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;!--</span>     <span class="kw">const</span> categoryByName <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>(data<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> [d<span class="op">.</span><span class="at">name</span><span class="op">,</span> d<span class="op">.</span><span class="at">category</span>]))<span class="op">;</span> <span class="op">--&gt;</span></span>
<span id="cb14-427"><a href="#cb14-427" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;!--</span>     <span class="kw">const</span> categories <span class="op">=</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(categoryByName<span class="op">.</span><span class="fu">values</span>())<span class="op">.</span><span class="fu">filter</span>((d<span class="op">,</span> i<span class="op">,</span> arr) <span class="kw">=&gt;</span> arr<span class="op">.</span><span class="fu">indexOf</span>(d) <span class="op">===</span> i)<span class="op">;</span> <span class="op">--&gt;</span></span>
<span id="cb14-428"><a href="#cb14-428" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;!--</span>     <span class="kw">const</span> scaleByCategory <span class="op">=</span> <span class="kw">typeof</span> categories[<span class="dv">0</span>] <span class="op">===</span> <span class="st">"number"</span> <span class="op">?</span>  <span class="op">--&gt;</span></span>
<span id="cb14-429"><a href="#cb14-429" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;!--</span>       d3<span class="op">.</span><span class="fu">scaleSequential</span>(d3<span class="op">.</span><span class="at">interpolateSpectral</span>)<span class="op">.</span><span class="fu">domain</span>(d3<span class="op">.</span><span class="fu">extent</span>(categories)) <span class="op">:</span> <span class="op">--&gt;</span></span>
<span id="cb14-430"><a href="#cb14-430" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;!--</span>       d3<span class="op">.</span><span class="fu">scaleOrdinal</span>()<span class="op">.</span><span class="fu">domain</span>(categories)<span class="op">.</span><span class="fu">range</span>(d3<span class="op">.</span><span class="fu">quantize</span>(d3<span class="op">.</span><span class="at">interpolateSpectral</span><span class="op">,</span> categories<span class="op">.</span><span class="at">length</span>))<span class="op">;</span> <span class="op">--&gt;</span></span>
<span id="cb14-431"><a href="#cb14-431" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;!--</span>     <span class="cf">return</span> d <span class="kw">=&gt;</span> <span class="fu">scale</span>(<span class="fu">scaleByCategory</span>(categoryByName<span class="op">.</span><span class="fu">get</span>(d<span class="op">.</span><span class="at">name</span>)))<span class="op">;</span> <span class="op">--&gt;</span></span>
<span id="cb14-432"><a href="#cb14-432" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;!--</span>   } <span class="op">--&gt;</span></span>
<span id="cb14-433"><a href="#cb14-433" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;!--</span>   <span class="cf">return</span> (d<span class="op">,</span> i) <span class="kw">=&gt;</span> <span class="fu">scale</span>(i)<span class="op">;</span> <span class="op">--&gt;</span></span>
<span id="cb14-434"><a href="#cb14-434" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;!--</span> } <span class="op">--&gt;</span></span>
<span id="cb14-435"><a href="#cb14-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-436"><a href="#cb14-436" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;!--</span> x <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleLinear</span>([<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span>]<span class="op">,</span> [margin<span class="op">.</span><span class="at">left</span><span class="op">,</span> width <span class="op">-</span> margin<span class="op">.</span><span class="at">right</span>]) <span class="op">--&gt;</span></span>
<span id="cb14-437"><a href="#cb14-437" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleLinear</span>([<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span>]<span class="op">,</span> [margin<span class="op">.</span><span class="at">left</span><span class="op">,</span>  width <span class="op">-</span> margin<span class="op">.</span><span class="at">right</span>])</span>
<span id="cb14-438"><a href="#cb14-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-439"><a href="#cb14-439" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleBand</span>()</span>
<span id="cb14-440"><a href="#cb14-440" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">domain</span>(d3<span class="op">.</span><span class="fu">range</span>(n <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb14-441"><a href="#cb14-441" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">rangeRound</span>([margin<span class="op">.</span><span class="at">top</span><span class="op">,</span> margin<span class="op">.</span><span class="at">top</span> <span class="op">+</span> barSize <span class="op">*</span> (n <span class="op">+</span> <span class="dv">1</span> <span class="op">+</span> <span class="fl">0.1</span>)])</span>
<span id="cb14-442"><a href="#cb14-442" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">padding</span>(<span class="fl">0.1</span>)</span>
<span id="cb14-443"><a href="#cb14-443" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-444"><a href="#cb14-444" aria-hidden="true" tabindex="-1"></a>height <span class="op">=</span> margin<span class="op">.</span><span class="at">top</span> <span class="op">+</span> barSize <span class="op">*</span> n <span class="op">+</span> margin<span class="op">.</span><span class="at">bottom</span></span>
<span id="cb14-445"><a href="#cb14-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-446"><a href="#cb14-446" aria-hidden="true" tabindex="-1"></a>barSize <span class="op">=</span> <span class="dv">48</span></span>
<span id="cb14-447"><a href="#cb14-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-448"><a href="#cb14-448" aria-hidden="true" tabindex="-1"></a>margin <span class="op">=</span> ({<span class="dt">top</span><span class="op">:</span> <span class="dv">16</span><span class="op">,</span> <span class="dt">right</span><span class="op">:</span> <span class="dv">6</span><span class="op">,</span> <span class="dt">bottom</span><span class="op">:</span> <span class="dv">6</span><span class="op">,</span> <span class="dt">left</span><span class="op">:</span> <span class="dv">0</span>})</span>
<span id="cb14-449"><a href="#cb14-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-450"><a href="#cb14-450" aria-hidden="true" tabindex="-1"></a>d3 <span class="op">=</span> <span class="pp">require</span>(<span class="st">"d3@6"</span>)</span>
<span id="cb14-451"><a href="#cb14-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-452"><a href="#cb14-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-453"><a href="#cb14-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-454"><a href="#cb14-454" aria-hidden="true" tabindex="-1"></a><span class="vs">```</span></span>
<span id="cb14-455"><a href="#cb14-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-456"><a href="#cb14-456" aria-hidden="true" tabindex="-1"></a><span class="vs">This visualization presents the dynamic monthly changes in COVID-19 death cases from 2020 to 2023 in each state across the United States. By showcasing the data in a ranked format, it provides an intuitive way to understand the shifts in state rankings as the pandemic progressed. This visualization helps to identify states with the highest death tolls at different points in time.</span></span>
<span id="cb14-457"><a href="#cb14-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-458"><a href="#cb14-458" aria-hidden="true" tabindex="-1"></a><span class="vs">## Interactive Network Chart for Ages and Conditions</span></span>
<span id="cb14-459"><a href="#cb14-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-462"><a href="#cb14-462" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb14-463"><a href="#cb14-463" aria-hidden="true" tabindex="-1"></a>#<span class="op">|</span> eval<span class="op">:</span> <span class="kw">false</span></span>
<span id="cb14-464"><a href="#cb14-464" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> csv</span>
<span id="cb14-465"><a href="#cb14-465" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb14-466"><a href="#cb14-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-467"><a href="#cb14-467" aria-hidden="true" tabindex="-1"></a># Read <span class="kw">in</span> the CSV file</span>
<span id="cb14-468"><a href="#cb14-468" aria-hidden="true" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">"./net/filtered_by_total.csv"</span></span>
<span id="cb14-469"><a href="#cb14-469" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="fu">open</span>(filename<span class="op">,</span> <span class="st">"r"</span>) <span class="im">as</span> csvfile<span class="op">:</span></span>
<span id="cb14-470"><a href="#cb14-470" aria-hidden="true" tabindex="-1"></a>    reader <span class="op">=</span> csv<span class="op">.</span><span class="fu">DictReader</span>(csvfile)</span>
<span id="cb14-471"><a href="#cb14-471" aria-hidden="true" tabindex="-1"></a>    rows <span class="op">=</span> [row <span class="cf">for</span> row <span class="kw">in</span> reader <span class="cf">if</span> row[<span class="st">"State"</span>] <span class="op">==</span> <span class="st">"United States"</span>]</span>
<span id="cb14-472"><a href="#cb14-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-473"><a href="#cb14-473" aria-hidden="true" tabindex="-1"></a># Create nodes dictionary</span>
<span id="cb14-474"><a href="#cb14-474" aria-hidden="true" tabindex="-1"></a>age_groups <span class="op">=</span> <span class="fu">list</span>(<span class="fu">set</span>(row[<span class="st">"Age Group"</span>] <span class="cf">for</span> row <span class="kw">in</span> rows))</span>
<span id="cb14-475"><a href="#cb14-475" aria-hidden="true" tabindex="-1"></a>condition_groups <span class="op">=</span> <span class="fu">list</span>(<span class="fu">set</span>(row[<span class="st">"Condition Group"</span>] <span class="cf">for</span> row <span class="kw">in</span> rows))</span>
<span id="cb14-476"><a href="#cb14-476" aria-hidden="true" tabindex="-1"></a>nodes <span class="op">=</span> [{<span class="st">"id"</span><span class="op">:</span> group<span class="op">,</span> <span class="st">"group"</span><span class="op">:</span> i} <span class="cf">for</span> i<span class="op">,</span> group <span class="kw">in</span> <span class="fu">enumerate</span>(age_groups <span class="op">+</span> condition_groups)]</span>
<span id="cb14-477"><a href="#cb14-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-478"><a href="#cb14-478" aria-hidden="true" tabindex="-1"></a># Create links dictionary</span>
<span id="cb14-479"><a href="#cb14-479" aria-hidden="true" tabindex="-1"></a>max_value <span class="op">=</span> <span class="fu">max</span>(<span class="fu">int</span>(row[<span class="st">"COVID-19 Deaths"</span>]) <span class="cf">for</span> row <span class="kw">in</span> rows)</span>
<span id="cb14-480"><a href="#cb14-480" aria-hidden="true" tabindex="-1"></a>min_value <span class="op">=</span> <span class="fu">min</span>(<span class="fu">int</span>(row[<span class="st">"COVID-19 Deaths"</span>]) <span class="cf">for</span> row <span class="kw">in</span> rows)</span>
<span id="cb14-481"><a href="#cb14-481" aria-hidden="true" tabindex="-1"></a>links <span class="op">=</span> [{<span class="st">"source"</span><span class="op">:</span> row[<span class="st">"Age Group"</span>]<span class="op">,</span> <span class="st">"target"</span><span class="op">:</span> row[<span class="st">"Condition Group"</span>]<span class="op">,</span> <span class="st">"value"</span><span class="op">:</span> (<span class="fu">int</span>(row[<span class="st">"COVID-19 Deaths"</span>]) <span class="op">-</span> min_value) <span class="op">/</span> (max_value <span class="op">-</span> min_value) <span class="op">*</span> <span class="dv">100</span>} <span class="cf">for</span> row <span class="kw">in</span> rows]</span>
<span id="cb14-482"><a href="#cb14-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-483"><a href="#cb14-483" aria-hidden="true" tabindex="-1"></a># Combine nodes and links into a single dictionary</span>
<span id="cb14-484"><a href="#cb14-484" aria-hidden="true" tabindex="-1"></a>network <span class="op">=</span> {<span class="st">"nodes"</span><span class="op">:</span> nodes<span class="op">,</span> <span class="st">"links"</span><span class="op">:</span> links}</span>
<span id="cb14-485"><a href="#cb14-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-486"><a href="#cb14-486" aria-hidden="true" tabindex="-1"></a># Write to a <span class="bu">JSON</span> file</span>
<span id="cb14-487"><a href="#cb14-487" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="fu">open</span>(<span class="st">"./net/network.json"</span><span class="op">,</span> <span class="st">"w"</span>) <span class="im">as</span> outfile<span class="op">:</span></span>
<span id="cb14-488"><a href="#cb14-488" aria-hidden="true" tabindex="-1"></a>    json<span class="op">.</span><span class="fu">dump</span>(network<span class="op">,</span> outfile<span class="op">,</span> indent<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb14-489"><a href="#cb14-489" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-490"><a href="#cb14-490" aria-hidden="true" tabindex="-1"></a># Load the <span class="bu">JSON</span> data</span>
<span id="cb14-491"><a href="#cb14-491" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="fu">open</span>(<span class="st">'./net/network.json'</span><span class="op">,</span> <span class="st">'r'</span>) <span class="im">as</span> f<span class="op">:</span></span>
<span id="cb14-492"><a href="#cb14-492" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> json<span class="op">.</span><span class="fu">load</span>(f)</span>
<span id="cb14-493"><a href="#cb14-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-494"><a href="#cb14-494" aria-hidden="true" tabindex="-1"></a># Create a dictionary to store the max values <span class="cf">for</span> each source</span>
<span id="cb14-495"><a href="#cb14-495" aria-hidden="true" tabindex="-1"></a>max_values <span class="op">=</span> {}</span>
<span id="cb14-496"><a href="#cb14-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-497"><a href="#cb14-497" aria-hidden="true" tabindex="-1"></a># Loop through the links to find the max value <span class="cf">for</span> each source</span>
<span id="cb14-498"><a href="#cb14-498" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> link <span class="kw">in</span> data[<span class="st">'links'</span>]<span class="op">:</span></span>
<span id="cb14-499"><a href="#cb14-499" aria-hidden="true" tabindex="-1"></a>    source <span class="op">=</span> link[<span class="st">'source'</span>]</span>
<span id="cb14-500"><a href="#cb14-500" aria-hidden="true" tabindex="-1"></a>    value <span class="op">=</span> link[<span class="st">'value'</span>]</span>
<span id="cb14-501"><a href="#cb14-501" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> source <span class="kw">in</span> max_values<span class="op">:</span></span>
<span id="cb14-502"><a href="#cb14-502" aria-hidden="true" tabindex="-1"></a>        max_values[source]<span class="op">.</span><span class="fu">append</span>(value)</span>
<span id="cb14-503"><a href="#cb14-503" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span><span class="op">:</span></span>
<span id="cb14-504"><a href="#cb14-504" aria-hidden="true" tabindex="-1"></a>        max_values[source] <span class="op">=</span> [value]</span>
<span id="cb14-505"><a href="#cb14-505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-506"><a href="#cb14-506" aria-hidden="true" tabindex="-1"></a># Loop through the links again to filter out those <span class="cf">with</span> values less than the top <span class="dv">3</span></span>
<span id="cb14-507"><a href="#cb14-507" aria-hidden="true" tabindex="-1"></a>filtered_links <span class="op">=</span> []</span>
<span id="cb14-508"><a href="#cb14-508" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> link <span class="kw">in</span> data[<span class="st">'links'</span>]<span class="op">:</span></span>
<span id="cb14-509"><a href="#cb14-509" aria-hidden="true" tabindex="-1"></a>    source <span class="op">=</span> link[<span class="st">'source'</span>]</span>
<span id="cb14-510"><a href="#cb14-510" aria-hidden="true" tabindex="-1"></a>    value <span class="op">=</span> link[<span class="st">'value'</span>]</span>
<span id="cb14-511"><a href="#cb14-511" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="fu">len</span>(max_values[source]) <span class="op">&gt;</span> <span class="dv">3</span> and value <span class="op">&lt;</span> <span class="fu">sorted</span>(max_values[source]<span class="op">,</span> reverse<span class="op">=</span>True)[<span class="dv">2</span>]<span class="op">:</span></span>
<span id="cb14-512"><a href="#cb14-512" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb14-513"><a href="#cb14-513" aria-hidden="true" tabindex="-1"></a>    filtered_links<span class="op">.</span><span class="fu">append</span>(link)</span>
<span id="cb14-514"><a href="#cb14-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-515"><a href="#cb14-515" aria-hidden="true" tabindex="-1"></a># Create a <span class="kw">new</span> dictionary <span class="cf">with</span> the filtered links</span>
<span id="cb14-516"><a href="#cb14-516" aria-hidden="true" tabindex="-1"></a>filtered_data <span class="op">=</span> {</span>
<span id="cb14-517"><a href="#cb14-517" aria-hidden="true" tabindex="-1"></a>    <span class="st">'nodes'</span><span class="op">:</span> data[<span class="st">'nodes'</span>]<span class="op">,</span></span>
<span id="cb14-518"><a href="#cb14-518" aria-hidden="true" tabindex="-1"></a>    <span class="st">'links'</span><span class="op">:</span> filtered_links</span>
<span id="cb14-519"><a href="#cb14-519" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-520"><a href="#cb14-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-521"><a href="#cb14-521" aria-hidden="true" tabindex="-1"></a># Save the filtered data to a <span class="kw">new</span> <span class="bu">JSON</span> file</span>
<span id="cb14-522"><a href="#cb14-522" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="fu">open</span>(<span class="st">'./net/filtered_network.json'</span><span class="op">,</span> <span class="st">'w'</span>) <span class="im">as</span> f<span class="op">:</span></span>
<span id="cb14-523"><a href="#cb14-523" aria-hidden="true" tabindex="-1"></a>    json<span class="op">.</span><span class="fu">dump</span>(filtered_data<span class="op">,</span> f<span class="op">,</span> indent<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb14-524"><a href="#cb14-524" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-525"><a href="#cb14-525" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="fu">open</span>(<span class="st">'./net/filtered_network.json'</span>) <span class="im">as</span> f<span class="op">:</span></span>
<span id="cb14-526"><a href="#cb14-526" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> json<span class="op">.</span><span class="fu">load</span>(f)</span>
<span id="cb14-527"><a href="#cb14-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-528"><a href="#cb14-528" aria-hidden="true" tabindex="-1"></a>nodes <span class="op">=</span> []</span>
<span id="cb14-529"><a href="#cb14-529" aria-hidden="true" tabindex="-1"></a>new_links <span class="op">=</span> []</span>
<span id="cb14-530"><a href="#cb14-530" aria-hidden="true" tabindex="-1"></a>sources <span class="op">=</span> <span class="fu">set</span>([link[<span class="st">'source'</span>] <span class="cf">for</span> link <span class="kw">in</span> data[<span class="st">'links'</span>]])</span>
<span id="cb14-531"><a href="#cb14-531" aria-hidden="true" tabindex="-1"></a>targets <span class="op">=</span> <span class="fu">set</span>([link[<span class="st">'target'</span>] <span class="cf">for</span> link <span class="kw">in</span> data[<span class="st">'links'</span>]])</span>
<span id="cb14-532"><a href="#cb14-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-533"><a href="#cb14-533" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> node <span class="kw">in</span> sources<span class="op">.</span><span class="fu">union</span>(targets)<span class="op">:</span></span>
<span id="cb14-534"><a href="#cb14-534" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> node <span class="kw">in</span> sources<span class="op">:</span></span>
<span id="cb14-535"><a href="#cb14-535" aria-hidden="true" tabindex="-1"></a>        nodes<span class="op">.</span><span class="fu">append</span>({<span class="st">"id"</span><span class="op">:</span> node<span class="op">,</span> <span class="st">"group"</span><span class="op">:</span> <span class="dv">0</span>})</span>
<span id="cb14-536"><a href="#cb14-536" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span><span class="op">:</span></span>
<span id="cb14-537"><a href="#cb14-537" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> source <span class="kw">in</span> sources<span class="op">:</span></span>
<span id="cb14-538"><a href="#cb14-538" aria-hidden="true" tabindex="-1"></a>            new_node_id <span class="op">=</span> f<span class="st">"{node}({source})"</span></span>
<span id="cb14-539"><a href="#cb14-539" aria-hidden="true" tabindex="-1"></a>            nodes<span class="op">.</span><span class="fu">append</span>({<span class="st">"id"</span><span class="op">:</span> new_node_id<span class="op">,</span> <span class="st">"group"</span><span class="op">:</span> <span class="dv">1</span>})</span>
<span id="cb14-540"><a href="#cb14-540" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> link <span class="kw">in</span> data[<span class="st">'links'</span>]<span class="op">:</span></span>
<span id="cb14-541"><a href="#cb14-541" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> link[<span class="st">'source'</span>] <span class="op">==</span> source and link[<span class="st">'target'</span>] <span class="op">==</span> node<span class="op">:</span></span>
<span id="cb14-542"><a href="#cb14-542" aria-hidden="true" tabindex="-1"></a>                    new_links<span class="op">.</span><span class="fu">append</span>({<span class="st">"source"</span><span class="op">:</span> source<span class="op">,</span> <span class="st">"target"</span><span class="op">:</span> new_node_id<span class="op">,</span> <span class="st">"value"</span><span class="op">:</span> link[<span class="st">'value'</span>]})</span>
<span id="cb14-543"><a href="#cb14-543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-544"><a href="#cb14-544" aria-hidden="true" tabindex="-1"></a>new_data <span class="op">=</span> {<span class="st">"nodes"</span><span class="op">:</span> nodes<span class="op">,</span> <span class="st">"links"</span><span class="op">:</span> new_links}</span>
<span id="cb14-545"><a href="#cb14-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-546"><a href="#cb14-546" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="fu">open</span>(<span class="st">'./net/new_filtered_network.json'</span><span class="op">,</span> <span class="st">'w'</span>) <span class="im">as</span> f<span class="op">:</span></span>
<span id="cb14-547"><a href="#cb14-547" aria-hidden="true" tabindex="-1"></a>    json<span class="op">.</span><span class="fu">dump</span>(new_data<span class="op">,</span> f<span class="op">,</span> indent<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb14-548"><a href="#cb14-548" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-549"><a href="#cb14-549" aria-hidden="true" tabindex="-1"></a># Load the <span class="bu">JSON</span> file</span>
<span id="cb14-550"><a href="#cb14-550" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="fu">open</span>(<span class="st">"./net/new_filtered_network.json"</span>) <span class="im">as</span> f<span class="op">:</span></span>
<span id="cb14-551"><a href="#cb14-551" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> json<span class="op">.</span><span class="fu">load</span>(f)</span>
<span id="cb14-552"><a href="#cb14-552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-553"><a href="#cb14-553" aria-hidden="true" tabindex="-1"></a># Find all nodes <span class="kw">in</span> group <span class="dv">0</span></span>
<span id="cb14-554"><a href="#cb14-554" aria-hidden="true" tabindex="-1"></a>group0_nodes <span class="op">=</span> [node <span class="cf">for</span> node <span class="kw">in</span> data[<span class="st">'nodes'</span>] <span class="cf">if</span> node[<span class="st">'group'</span>] <span class="op">==</span> <span class="dv">0</span>]</span>
<span id="cb14-555"><a href="#cb14-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-556"><a href="#cb14-556" aria-hidden="true" tabindex="-1"></a># Create a center node</span>
<span id="cb14-557"><a href="#cb14-557" aria-hidden="true" tabindex="-1"></a>center_node <span class="op">=</span> {<span class="st">'id'</span><span class="op">:</span> <span class="st">'center'</span><span class="op">,</span> <span class="st">'group'</span><span class="op">:</span> <span class="op">-</span><span class="dv">1</span>}</span>
<span id="cb14-558"><a href="#cb14-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-559"><a href="#cb14-559" aria-hidden="true" tabindex="-1"></a># Add links <span class="im">from</span> center node to all group <span class="dv">0</span> nodes</span>
<span id="cb14-560"><a href="#cb14-560" aria-hidden="true" tabindex="-1"></a>links <span class="op">=</span> data[<span class="st">'links'</span>]</span>
<span id="cb14-561"><a href="#cb14-561" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> node <span class="kw">in</span> group0_nodes<span class="op">:</span></span>
<span id="cb14-562"><a href="#cb14-562" aria-hidden="true" tabindex="-1"></a>    links<span class="op">.</span><span class="fu">append</span>({<span class="st">'source'</span><span class="op">:</span> <span class="st">'center'</span><span class="op">,</span> <span class="st">'target'</span><span class="op">:</span> node[<span class="st">'id'</span>]<span class="op">,</span> <span class="st">'value'</span><span class="op">:</span> <span class="dv">1</span>})</span>
<span id="cb14-563"><a href="#cb14-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-564"><a href="#cb14-564" aria-hidden="true" tabindex="-1"></a># Add the center node to the nodes list</span>
<span id="cb14-565"><a href="#cb14-565" aria-hidden="true" tabindex="-1"></a>nodes <span class="op">=</span> data[<span class="st">'nodes'</span>]</span>
<span id="cb14-566"><a href="#cb14-566" aria-hidden="true" tabindex="-1"></a>nodes<span class="op">.</span><span class="fu">append</span>(center_node)</span>
<span id="cb14-567"><a href="#cb14-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-568"><a href="#cb14-568" aria-hidden="true" tabindex="-1"></a># Save the modified data <span class="im">as</span> a <span class="kw">new</span> <span class="bu">JSON</span> file</span>
<span id="cb14-569"><a href="#cb14-569" aria-hidden="true" tabindex="-1"></a>new_data <span class="op">=</span> {<span class="st">'nodes'</span><span class="op">:</span> nodes<span class="op">,</span> <span class="st">'links'</span><span class="op">:</span> links}</span>
<span id="cb14-570"><a href="#cb14-570" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="fu">open</span>(<span class="st">"./net/new_filtered_network_with_center.json"</span><span class="op">,</span> <span class="st">"w"</span>) <span class="im">as</span> f<span class="op">:</span></span>
<span id="cb14-571"><a href="#cb14-571" aria-hidden="true" tabindex="-1"></a>    json<span class="op">.</span><span class="fu">dump</span>(new_data<span class="op">,</span> f)</span>
<span id="cb14-572"><a href="#cb14-572" aria-hidden="true" tabindex="-1"></a><span class="vs">```</span></span>
<span id="cb14-573"><a href="#cb14-573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-574"><a href="#cb14-574" aria-hidden="true" tabindex="-1"></a><span class="vs">This visualization necessitated substantial data cleansing efforts, such as generating node and link JSON files and trimming extraneous links to display only the top 3 relevant connections. Since the network visualization does not account for directional connections, it can create cross-linked nodes, resulting in a nested graph. To achieve a more visually explicit appearance, I manually duplicated the node of conditions. Furthermore, the nodes tend to gradually fade away from the screen, so incorporating a central node is essential to maintain their positions within the visualization.</span></span>
<span id="cb14-575"><a href="#cb14-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-576"><a href="#cb14-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-579"><a href="#cb14-579" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb14-580"><a href="#cb14-580" aria-hidden="true" tabindex="-1"></a>chart2 <span class="op">=</span> <span class="fu">ForceGraph</span>(miserables<span class="op">,</span> {</span>
<span id="cb14-581"><a href="#cb14-581" aria-hidden="true" tabindex="-1"></a>  <span class="dt">nodeId</span><span class="op">:</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">id</span><span class="op">,</span></span>
<span id="cb14-582"><a href="#cb14-582" aria-hidden="true" tabindex="-1"></a>  <span class="dt">nodeGroup</span><span class="op">:</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">group</span><span class="op">,</span></span>
<span id="cb14-583"><a href="#cb14-583" aria-hidden="true" tabindex="-1"></a>  <span class="dt">nodeTitle</span><span class="op">:</span> d <span class="kw">=&gt;</span> <span class="vs">`</span><span class="sc">${</span>d<span class="op">.</span><span class="at">id</span><span class="sc">}\n${</span>d<span class="op">.</span><span class="at">group</span><span class="sc">}</span><span class="vs">`</span><span class="op">,</span></span>
<span id="cb14-584"><a href="#cb14-584" aria-hidden="true" tabindex="-1"></a>  <span class="dt">linkStrokeWidth</span><span class="op">:</span> l <span class="kw">=&gt;</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">sqrt</span>(l<span class="op">.</span><span class="at">value</span>)<span class="op">,</span></span>
<span id="cb14-585"><a href="#cb14-585" aria-hidden="true" tabindex="-1"></a>  width<span class="op">,</span></span>
<span id="cb14-586"><a href="#cb14-586" aria-hidden="true" tabindex="-1"></a>  <span class="dt">height</span><span class="op">:</span> <span class="dv">600</span><span class="op">,</span></span>
<span id="cb14-587"><a href="#cb14-587" aria-hidden="true" tabindex="-1"></a>  invalidation <span class="co">// a promise to stop the simulation when the cell is re-run</span></span>
<span id="cb14-588"><a href="#cb14-588" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb14-589"><a href="#cb14-589" aria-hidden="true" tabindex="-1"></a><span class="vs">```</span></span>
<span id="cb14-590"><a href="#cb14-590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-593"><a href="#cb14-593" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb14-594"><a href="#cb14-594" aria-hidden="true" tabindex="-1"></a>miserables <span class="op">=</span> <span class="fu">FileAttachment</span>(<span class="st">"./net/new_filtered_network_with_center.json"</span>)<span class="op">.</span><span class="fu">json</span>()</span>
<span id="cb14-595"><a href="#cb14-595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-596"><a href="#cb14-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-597"><a href="#cb14-597" aria-hidden="true" tabindex="-1"></a><span class="co">// Copyright 2021 Observable, Inc.</span></span>
<span id="cb14-598"><a href="#cb14-598" aria-hidden="true" tabindex="-1"></a><span class="co">// Released under the ISC license.</span></span>
<span id="cb14-599"><a href="#cb14-599" aria-hidden="true" tabindex="-1"></a><span class="co">// https://observablehq.com/@d3/force-directed-graph</span></span>
<span id="cb14-600"><a href="#cb14-600" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">ForceGraph</span>({</span>
<span id="cb14-601"><a href="#cb14-601" aria-hidden="true" tabindex="-1"></a>  nodes<span class="op">,</span> <span class="co">// an iterable of node objects (typically [{id}, …])</span></span>
<span id="cb14-602"><a href="#cb14-602" aria-hidden="true" tabindex="-1"></a>  links <span class="co">// an iterable of link objects (typically [{source, target}, …])</span></span>
<span id="cb14-603"><a href="#cb14-603" aria-hidden="true" tabindex="-1"></a>}<span class="op">,</span> {</span>
<span id="cb14-604"><a href="#cb14-604" aria-hidden="true" tabindex="-1"></a>  nodeId <span class="op">=</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">id</span><span class="op">,</span> <span class="co">// given d in nodes, returns a unique identifier (string)</span></span>
<span id="cb14-605"><a href="#cb14-605" aria-hidden="true" tabindex="-1"></a>  nodeGroup<span class="op">,</span> <span class="co">// given d in nodes, returns an (ordinal) value for color</span></span>
<span id="cb14-606"><a href="#cb14-606" aria-hidden="true" tabindex="-1"></a>  nodeGroups<span class="op">,</span> <span class="co">// an array of ordinal values representing the node groups</span></span>
<span id="cb14-607"><a href="#cb14-607" aria-hidden="true" tabindex="-1"></a>  nodeTitle<span class="op">,</span> <span class="co">// given d in nodes, a title string</span></span>
<span id="cb14-608"><a href="#cb14-608" aria-hidden="true" tabindex="-1"></a>  nodeFill <span class="op">=</span> <span class="st">"currentColor"</span><span class="op">,</span> <span class="co">// node stroke fill (if not using a group color encoding)</span></span>
<span id="cb14-609"><a href="#cb14-609" aria-hidden="true" tabindex="-1"></a>  nodeStroke <span class="op">=</span> <span class="st">"#fff"</span><span class="op">,</span> <span class="co">// node stroke color</span></span>
<span id="cb14-610"><a href="#cb14-610" aria-hidden="true" tabindex="-1"></a>  nodeStrokeWidth <span class="op">=</span> <span class="fl">1.5</span><span class="op">,</span> <span class="co">// node stroke width, in pixels</span></span>
<span id="cb14-611"><a href="#cb14-611" aria-hidden="true" tabindex="-1"></a>  nodeStrokeOpacity <span class="op">=</span> <span class="dv">1</span><span class="op">,</span> <span class="co">// node stroke opacity</span></span>
<span id="cb14-612"><a href="#cb14-612" aria-hidden="true" tabindex="-1"></a>  nodeRadius <span class="op">=</span> <span class="dv">5</span><span class="op">,</span> <span class="co">// node radius, in pixels</span></span>
<span id="cb14-613"><a href="#cb14-613" aria-hidden="true" tabindex="-1"></a>  nodeStrength<span class="op">,</span></span>
<span id="cb14-614"><a href="#cb14-614" aria-hidden="true" tabindex="-1"></a>  linkSource <span class="op">=</span> ({source}) <span class="kw">=&gt;</span> source<span class="op">,</span> <span class="co">// given d in links, returns a node identifier string</span></span>
<span id="cb14-615"><a href="#cb14-615" aria-hidden="true" tabindex="-1"></a>  linkTarget <span class="op">=</span> ({target}) <span class="kw">=&gt;</span> target<span class="op">,</span> <span class="co">// given d in links, returns a node identifier string</span></span>
<span id="cb14-616"><a href="#cb14-616" aria-hidden="true" tabindex="-1"></a>  linkStroke <span class="op">=</span> <span class="st">"#999"</span><span class="op">,</span> <span class="co">// link stroke color</span></span>
<span id="cb14-617"><a href="#cb14-617" aria-hidden="true" tabindex="-1"></a>  linkStrokeOpacity <span class="op">=</span> <span class="fl">0.6</span><span class="op">,</span> <span class="co">// link stroke opacity</span></span>
<span id="cb14-618"><a href="#cb14-618" aria-hidden="true" tabindex="-1"></a>  linkStrokeWidth <span class="op">=</span> <span class="fl">1.5</span><span class="op">,</span> <span class="co">// given d in links, returns a stroke width in pixels</span></span>
<span id="cb14-619"><a href="#cb14-619" aria-hidden="true" tabindex="-1"></a>  linkStrokeLinecap <span class="op">=</span> <span class="st">"round"</span><span class="op">,</span> <span class="co">// link stroke linecap</span></span>
<span id="cb14-620"><a href="#cb14-620" aria-hidden="true" tabindex="-1"></a>  linkStrength<span class="op">,</span></span>
<span id="cb14-621"><a href="#cb14-621" aria-hidden="true" tabindex="-1"></a>  colors <span class="op">=</span> d3<span class="op">.</span><span class="at">schemeTableau10</span><span class="op">,</span> <span class="co">// an array of color strings, for the node groups</span></span>
<span id="cb14-622"><a href="#cb14-622" aria-hidden="true" tabindex="-1"></a>  width <span class="op">=</span> <span class="dv">640</span><span class="op">,</span> <span class="co">// outer width, in pixels</span></span>
<span id="cb14-623"><a href="#cb14-623" aria-hidden="true" tabindex="-1"></a>  height <span class="op">=</span> <span class="dv">400</span><span class="op">,</span> <span class="co">// outer height, in pixels</span></span>
<span id="cb14-624"><a href="#cb14-624" aria-hidden="true" tabindex="-1"></a>  invalidation <span class="co">// when this promise resolves, stop the simulation</span></span>
<span id="cb14-625"><a href="#cb14-625" aria-hidden="true" tabindex="-1"></a>} <span class="op">=</span> {}) {</span>
<span id="cb14-626"><a href="#cb14-626" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Compute values.</span></span>
<span id="cb14-627"><a href="#cb14-627" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> N <span class="op">=</span> d3<span class="op">.</span><span class="fu">map</span>(nodes<span class="op">,</span> nodeId)<span class="op">.</span><span class="fu">map</span>(intern)<span class="op">;</span></span>
<span id="cb14-628"><a href="#cb14-628" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> LS <span class="op">=</span> d3<span class="op">.</span><span class="fu">map</span>(links<span class="op">,</span> linkSource)<span class="op">.</span><span class="fu">map</span>(intern)<span class="op">;</span></span>
<span id="cb14-629"><a href="#cb14-629" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> LT <span class="op">=</span> d3<span class="op">.</span><span class="fu">map</span>(links<span class="op">,</span> linkTarget)<span class="op">.</span><span class="fu">map</span>(intern)<span class="op">;</span></span>
<span id="cb14-630"><a href="#cb14-630" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (nodeTitle <span class="op">===</span> <span class="kw">undefined</span>) nodeTitle <span class="op">=</span> (_<span class="op">,</span> i) <span class="kw">=&gt;</span> N[i]<span class="op">;</span></span>
<span id="cb14-631"><a href="#cb14-631" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> T <span class="op">=</span> nodeTitle <span class="op">==</span> <span class="kw">null</span> <span class="op">?</span> <span class="kw">null</span> <span class="op">:</span> d3<span class="op">.</span><span class="fu">map</span>(nodes<span class="op">,</span> nodeTitle)<span class="op">;</span></span>
<span id="cb14-632"><a href="#cb14-632" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> G <span class="op">=</span> nodeGroup <span class="op">==</span> <span class="kw">null</span> <span class="op">?</span> <span class="kw">null</span> <span class="op">:</span> d3<span class="op">.</span><span class="fu">map</span>(nodes<span class="op">,</span> nodeGroup)<span class="op">.</span><span class="fu">map</span>(intern)<span class="op">;</span></span>
<span id="cb14-633"><a href="#cb14-633" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> W <span class="op">=</span> <span class="kw">typeof</span> linkStrokeWidth <span class="op">!==</span> <span class="st">"function"</span> <span class="op">?</span> <span class="kw">null</span> <span class="op">:</span> d3<span class="op">.</span><span class="fu">map</span>(links<span class="op">,</span> linkStrokeWidth)<span class="op">;</span></span>
<span id="cb14-634"><a href="#cb14-634" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> L <span class="op">=</span> <span class="kw">typeof</span> linkStroke <span class="op">!==</span> <span class="st">"function"</span> <span class="op">?</span> <span class="kw">null</span> <span class="op">:</span> d3<span class="op">.</span><span class="fu">map</span>(links<span class="op">,</span> linkStroke)<span class="op">;</span></span>
<span id="cb14-635"><a href="#cb14-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-636"><a href="#cb14-636" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Replace the input nodes and links with mutable objects for the simulation.</span></span>
<span id="cb14-637"><a href="#cb14-637" aria-hidden="true" tabindex="-1"></a>  nodes <span class="op">=</span> d3<span class="op">.</span><span class="fu">map</span>(nodes<span class="op">,</span> (_<span class="op">,</span> i) <span class="kw">=&gt;</span> ({<span class="dt">id</span><span class="op">:</span> N[i]}))<span class="op">;</span></span>
<span id="cb14-638"><a href="#cb14-638" aria-hidden="true" tabindex="-1"></a>  links <span class="op">=</span> d3<span class="op">.</span><span class="fu">map</span>(links<span class="op">,</span> (_<span class="op">,</span> i) <span class="kw">=&gt;</span> ({<span class="dt">source</span><span class="op">:</span> LS[i]<span class="op">,</span> <span class="dt">target</span><span class="op">:</span> LT[i]}))<span class="op">;</span></span>
<span id="cb14-639"><a href="#cb14-639" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-640"><a href="#cb14-640" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Compute default domains.</span></span>
<span id="cb14-641"><a href="#cb14-641" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (G <span class="op">&amp;&amp;</span> nodeGroups <span class="op">===</span> <span class="kw">undefined</span>) nodeGroups <span class="op">=</span> d3<span class="op">.</span><span class="fu">sort</span>(G)<span class="op">;</span></span>
<span id="cb14-642"><a href="#cb14-642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-643"><a href="#cb14-643" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Construct the scales.</span></span>
<span id="cb14-644"><a href="#cb14-644" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> color <span class="op">=</span> nodeGroup <span class="op">==</span> <span class="kw">null</span> <span class="op">?</span> <span class="kw">null</span> <span class="op">:</span> d3<span class="op">.</span><span class="fu">scaleOrdinal</span>(nodeGroups<span class="op">,</span> colors)<span class="op">;</span></span>
<span id="cb14-645"><a href="#cb14-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-646"><a href="#cb14-646" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Construct the forces.</span></span>
<span id="cb14-647"><a href="#cb14-647" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> forceNode <span class="op">=</span> d3<span class="op">.</span><span class="fu">forceManyBody</span>()<span class="op">;</span></span>
<span id="cb14-648"><a href="#cb14-648" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> forceLink <span class="op">=</span> d3<span class="op">.</span><span class="fu">forceLink</span>(links)<span class="op">.</span><span class="fu">id</span>(({<span class="dt">index</span><span class="op">:</span> i}) <span class="kw">=&gt;</span> N[i])<span class="op">;</span></span>
<span id="cb14-649"><a href="#cb14-649" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (nodeStrength <span class="op">!==</span> <span class="kw">undefined</span>) forceNode<span class="op">.</span><span class="fu">strength</span>(nodeStrength)<span class="op">;</span></span>
<span id="cb14-650"><a href="#cb14-650" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (linkStrength <span class="op">!==</span> <span class="kw">undefined</span>) forceLink<span class="op">.</span><span class="fu">strength</span>(linkStrength)<span class="op">;</span></span>
<span id="cb14-651"><a href="#cb14-651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-652"><a href="#cb14-652" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> simulation <span class="op">=</span> d3<span class="op">.</span><span class="fu">forceSimulation</span>(nodes)</span>
<span id="cb14-653"><a href="#cb14-653" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">force</span>(<span class="st">"link"</span><span class="op">,</span> forceLink)</span>
<span id="cb14-654"><a href="#cb14-654" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">force</span>(<span class="st">"charge"</span><span class="op">,</span> forceNode)</span>
<span id="cb14-655"><a href="#cb14-655" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">force</span>(<span class="st">"center"</span><span class="op">,</span>  d3<span class="op">.</span><span class="fu">forceCenter</span>())</span>
<span id="cb14-656"><a href="#cb14-656" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">on</span>(<span class="st">"tick"</span><span class="op">,</span> ticked)<span class="op">;</span></span>
<span id="cb14-657"><a href="#cb14-657" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-658"><a href="#cb14-658" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> svg <span class="op">=</span> d3<span class="op">.</span><span class="fu">create</span>(<span class="st">"svg"</span>)</span>
<span id="cb14-659"><a href="#cb14-659" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"width"</span><span class="op">,</span> width)</span>
<span id="cb14-660"><a href="#cb14-660" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"height"</span><span class="op">,</span> height)</span>
<span id="cb14-661"><a href="#cb14-661" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"viewBox"</span><span class="op">,</span> [<span class="op">-</span>width <span class="op">/</span> <span class="dv">2</span><span class="op">,</span> <span class="op">-</span>height <span class="op">/</span> <span class="dv">2</span><span class="op">,</span> width<span class="op">,</span> height])</span>
<span id="cb14-662"><a href="#cb14-662" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"style"</span><span class="op">,</span> <span class="st">"max-width: 100%; height: auto; height: intrinsic;"</span>)<span class="op">;</span></span>
<span id="cb14-663"><a href="#cb14-663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-664"><a href="#cb14-664" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> link <span class="op">=</span> svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)</span>
<span id="cb14-665"><a href="#cb14-665" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke"</span><span class="op">,</span> <span class="kw">typeof</span> linkStroke <span class="op">!==</span> <span class="st">"function"</span> <span class="op">?</span> linkStroke <span class="op">:</span> <span class="kw">null</span>)</span>
<span id="cb14-666"><a href="#cb14-666" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke-opacity"</span><span class="op">,</span> linkStrokeOpacity)</span>
<span id="cb14-667"><a href="#cb14-667" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke-width"</span><span class="op">,</span> <span class="kw">typeof</span> linkStrokeWidth <span class="op">!==</span> <span class="st">"function"</span> <span class="op">?</span> linkStrokeWidth <span class="op">:</span> <span class="kw">null</span>)</span>
<span id="cb14-668"><a href="#cb14-668" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke-linecap"</span><span class="op">,</span> linkStrokeLinecap)</span>
<span id="cb14-669"><a href="#cb14-669" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"line"</span>)</span>
<span id="cb14-670"><a href="#cb14-670" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">data</span>(links)</span>
<span id="cb14-671"><a href="#cb14-671" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">join</span>(<span class="st">"line"</span>)<span class="op">;</span></span>
<span id="cb14-672"><a href="#cb14-672" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-673"><a href="#cb14-673" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> node <span class="op">=</span> svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)</span>
<span id="cb14-674"><a href="#cb14-674" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill"</span><span class="op">,</span> nodeFill)</span>
<span id="cb14-675"><a href="#cb14-675" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke"</span><span class="op">,</span> nodeStroke)</span>
<span id="cb14-676"><a href="#cb14-676" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke-opacity"</span><span class="op">,</span> nodeStrokeOpacity)</span>
<span id="cb14-677"><a href="#cb14-677" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke-width"</span><span class="op">,</span> nodeStrokeWidth)</span>
<span id="cb14-678"><a href="#cb14-678" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"circle"</span>)</span>
<span id="cb14-679"><a href="#cb14-679" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">data</span>(nodes)</span>
<span id="cb14-680"><a href="#cb14-680" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">join</span>(<span class="st">"circle"</span>)</span>
<span id="cb14-681"><a href="#cb14-681" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"r"</span><span class="op">,</span> nodeRadius)</span>
<span id="cb14-682"><a href="#cb14-682" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">call</span>(<span class="fu">drag</span>(simulation))</span>
<span id="cb14-683"><a href="#cb14-683" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">join</span>(<span class="st">"text"</span>)</span>
<span id="cb14-684"><a href="#cb14-684" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"dx"</span><span class="op">,</span> <span class="st">".10em"</span>)</span>
<span id="cb14-685"><a href="#cb14-685" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"dy"</span><span class="op">,</span> <span class="st">".10em"</span>)</span>
<span id="cb14-686"><a href="#cb14-686" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">text</span>(<span class="kw">function</span>(d) { <span class="cf">return</span> d<span class="op">.</span><span class="at">id</span><span class="op">;</span> })<span class="op">;</span></span>
<span id="cb14-687"><a href="#cb14-687" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-688"><a href="#cb14-688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-689"><a href="#cb14-689" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-690"><a href="#cb14-690" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;!--</span> <span class="kw">var</span> circles <span class="op">=</span> node<span class="op">.</span><span class="fu">append</span>(<span class="st">"circle"</span>) <span class="op">--&gt;</span></span>
<span id="cb14-691"><a href="#cb14-691" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;!--</span> <span class="op">.</span><span class="fu">attr</span>(<span class="st">"r"</span><span class="op">,</span> nodeRadius) <span class="op">--&gt;</span></span>
<span id="cb14-692"><a href="#cb14-692" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;!--</span>     <span class="op">.</span><span class="fu">call</span>(<span class="fu">drag</span>(simulation))<span class="op">;</span> <span class="op">--&gt;</span></span>
<span id="cb14-693"><a href="#cb14-693" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-694"><a href="#cb14-694" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;!--</span> <span class="kw">var</span> labels <span class="op">=</span> node<span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>) <span class="op">--&gt;</span></span>
<span id="cb14-695"><a href="#cb14-695" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;!--</span>   <span class="op">.</span><span class="fu">attr</span>(<span class="st">"dx"</span><span class="op">,</span> <span class="st">".10em"</span>) <span class="op">--&gt;</span></span>
<span id="cb14-696"><a href="#cb14-696" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;!--</span>   <span class="op">.</span><span class="fu">attr</span>(<span class="st">"dy"</span><span class="op">,</span> <span class="st">".10em"</span>) <span class="op">--&gt;</span></span>
<span id="cb14-697"><a href="#cb14-697" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;!--</span>   <span class="op">.</span><span class="fu">text</span>(<span class="kw">function</span>(d) { <span class="cf">return</span> d<span class="op">.</span><span class="at">id</span><span class="op">;</span> })<span class="op">;</span> <span class="op">--&gt;</span></span>
<span id="cb14-698"><a href="#cb14-698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-699"><a href="#cb14-699" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;!--</span> node<span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>) <span class="op">--&gt;</span></span>
<span id="cb14-700"><a href="#cb14-700" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;!--</span> <span class="op">.</span><span class="fu">text</span>(({id}) <span class="kw">=&gt;</span> id) <span class="co">// display the node id as text --&gt;</span></span>
<span id="cb14-701"><a href="#cb14-701" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;!--</span> <span class="op">.</span><span class="fu">attr</span>(<span class="st">"text-anchor"</span><span class="op">,</span> <span class="st">"middle"</span>) <span class="co">// center the text within the circle --&gt;</span></span>
<span id="cb14-702"><a href="#cb14-702" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;!--</span> <span class="op">.</span><span class="fu">attr</span>(<span class="st">"dy"</span><span class="op">,</span> <span class="st">"0.35em"</span>)<span class="op">;</span> <span class="co">// adjust the vertical position of the text within the circle --&gt;</span></span>
<span id="cb14-703"><a href="#cb14-703" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-704"><a href="#cb14-704" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (W) link<span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke-width"</span><span class="op">,</span> ({<span class="dt">index</span><span class="op">:</span> i}) <span class="kw">=&gt;</span> W[i])<span class="op">;</span></span>
<span id="cb14-705"><a href="#cb14-705" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (L) link<span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke"</span><span class="op">,</span> ({<span class="dt">index</span><span class="op">:</span> i}) <span class="kw">=&gt;</span> L[i])<span class="op">;</span></span>
<span id="cb14-706"><a href="#cb14-706" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (G) node<span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill"</span><span class="op">,</span> ({<span class="dt">index</span><span class="op">:</span> i}) <span class="kw">=&gt;</span> <span class="fu">color</span>(G[i]))<span class="op">;</span></span>
<span id="cb14-707"><a href="#cb14-707" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (T) node<span class="op">.</span><span class="fu">append</span>(<span class="st">"title"</span>)<span class="op">.</span><span class="fu">text</span>(({<span class="dt">index</span><span class="op">:</span> i}) <span class="kw">=&gt;</span> T[i])<span class="op">;</span></span>
<span id="cb14-708"><a href="#cb14-708" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (invalidation <span class="op">!=</span> <span class="kw">null</span>) invalidation<span class="op">.</span><span class="fu">then</span>(() <span class="kw">=&gt;</span> simulation<span class="op">.</span><span class="fu">stop</span>())<span class="op">;</span></span>
<span id="cb14-709"><a href="#cb14-709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-710"><a href="#cb14-710" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">intern</span>(value) {</span>
<span id="cb14-711"><a href="#cb14-711" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> value <span class="op">!==</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> <span class="kw">typeof</span> value <span class="op">===</span> <span class="st">"object"</span> <span class="op">?</span> value<span class="op">.</span><span class="fu">valueOf</span>() <span class="op">:</span> value<span class="op">;</span></span>
<span id="cb14-712"><a href="#cb14-712" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-713"><a href="#cb14-713" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-714"><a href="#cb14-714" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">ticked</span>() {</span>
<span id="cb14-715"><a href="#cb14-715" aria-hidden="true" tabindex="-1"></a>    link</span>
<span id="cb14-716"><a href="#cb14-716" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">source</span><span class="op">.</span><span class="at">x</span>)</span>
<span id="cb14-717"><a href="#cb14-717" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">source</span><span class="op">.</span><span class="at">y</span>)</span>
<span id="cb14-718"><a href="#cb14-718" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">x</span>)</span>
<span id="cb14-719"><a href="#cb14-719" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">y</span>)<span class="op">;</span></span>
<span id="cb14-720"><a href="#cb14-720" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-721"><a href="#cb14-721" aria-hidden="true" tabindex="-1"></a>    node</span>
<span id="cb14-722"><a href="#cb14-722" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"cx"</span><span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">x</span>)</span>
<span id="cb14-723"><a href="#cb14-723" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"cy"</span><span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">y</span>)<span class="op">;</span></span>
<span id="cb14-724"><a href="#cb14-724" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-725"><a href="#cb14-725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-726"><a href="#cb14-726" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">drag</span>(simulation) {    </span>
<span id="cb14-727"><a href="#cb14-727" aria-hidden="true" tabindex="-1"></a>    <span class="kw">function</span> <span class="fu">dragstarted</span>(<span class="bu">event</span>) {</span>
<span id="cb14-728"><a href="#cb14-728" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span><span class="bu">event</span><span class="op">.</span><span class="at">active</span>) simulation<span class="op">.</span><span class="fu">alphaTarget</span>(<span class="fl">0.3</span>)<span class="op">.</span><span class="fu">restart</span>()<span class="op">;</span></span>
<span id="cb14-729"><a href="#cb14-729" aria-hidden="true" tabindex="-1"></a>      <span class="bu">event</span><span class="op">.</span><span class="at">subject</span><span class="op">.</span><span class="at">fx</span> <span class="op">=</span> <span class="bu">event</span><span class="op">.</span><span class="at">subject</span><span class="op">.</span><span class="at">x</span><span class="op">;</span></span>
<span id="cb14-730"><a href="#cb14-730" aria-hidden="true" tabindex="-1"></a>      <span class="bu">event</span><span class="op">.</span><span class="at">subject</span><span class="op">.</span><span class="at">fy</span> <span class="op">=</span> <span class="bu">event</span><span class="op">.</span><span class="at">subject</span><span class="op">.</span><span class="at">y</span><span class="op">;</span></span>
<span id="cb14-731"><a href="#cb14-731" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-732"><a href="#cb14-732" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-733"><a href="#cb14-733" aria-hidden="true" tabindex="-1"></a>    <span class="kw">function</span> <span class="fu">dragged</span>(<span class="bu">event</span>) {</span>
<span id="cb14-734"><a href="#cb14-734" aria-hidden="true" tabindex="-1"></a>      <span class="bu">event</span><span class="op">.</span><span class="at">subject</span><span class="op">.</span><span class="at">fx</span> <span class="op">=</span> <span class="bu">event</span><span class="op">.</span><span class="at">x</span><span class="op">;</span></span>
<span id="cb14-735"><a href="#cb14-735" aria-hidden="true" tabindex="-1"></a>      <span class="bu">event</span><span class="op">.</span><span class="at">subject</span><span class="op">.</span><span class="at">fy</span> <span class="op">=</span> <span class="bu">event</span><span class="op">.</span><span class="at">y</span><span class="op">;</span></span>
<span id="cb14-736"><a href="#cb14-736" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-737"><a href="#cb14-737" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-738"><a href="#cb14-738" aria-hidden="true" tabindex="-1"></a>    <span class="kw">function</span> <span class="fu">dragended</span>(<span class="bu">event</span>) {</span>
<span id="cb14-739"><a href="#cb14-739" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span><span class="bu">event</span><span class="op">.</span><span class="at">active</span>) simulation<span class="op">.</span><span class="fu">alphaTarget</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb14-740"><a href="#cb14-740" aria-hidden="true" tabindex="-1"></a>      <span class="bu">event</span><span class="op">.</span><span class="at">subject</span><span class="op">.</span><span class="at">fx</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb14-741"><a href="#cb14-741" aria-hidden="true" tabindex="-1"></a>      <span class="bu">event</span><span class="op">.</span><span class="at">subject</span><span class="op">.</span><span class="at">fy</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb14-742"><a href="#cb14-742" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-743"><a href="#cb14-743" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-744"><a href="#cb14-744" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> d3<span class="op">.</span><span class="fu">drag</span>()</span>
<span id="cb14-745"><a href="#cb14-745" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">on</span>(<span class="st">"start"</span><span class="op">,</span> dragstarted)</span>
<span id="cb14-746"><a href="#cb14-746" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">on</span>(<span class="st">"drag"</span><span class="op">,</span> dragged)</span>
<span id="cb14-747"><a href="#cb14-747" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">on</span>(<span class="st">"end"</span><span class="op">,</span> dragended)<span class="op">;</span></span>
<span id="cb14-748"><a href="#cb14-748" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-749"><a href="#cb14-749" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-750"><a href="#cb14-750" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="bu">Object</span><span class="op">.</span><span class="fu">assign</span>(svg<span class="op">.</span><span class="fu">node</span>()<span class="op">,</span> {<span class="dt">scales</span><span class="op">:</span> {color}})<span class="op">;</span></span>
<span id="cb14-751"><a href="#cb14-751" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-752"><a href="#cb14-752" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-753"><a href="#cb14-753" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-754"><a href="#cb14-754" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> {howto} <span class="im">from</span> <span class="st">"@d3/example-components"</span></span>
<span id="cb14-755"><a href="#cb14-755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-756"><a href="#cb14-756" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> {Swatches} <span class="im">from</span> <span class="st">"@d3/color-legend"</span></span>
<span id="cb14-757"><a href="#cb14-757" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-758"><a href="#cb14-758" aria-hidden="true" tabindex="-1"></a><span class="vs">```</span></span>
<span id="cb14-759"><a href="#cb14-759" aria-hidden="true" tabindex="-1"></a><span class="vs">This visualization displays an interactive network chart connecting death age groups with the conditions leading to those deaths. The chart effectively demonstrates the relationships between various factors contributing to COVID-19-related fatalities.</span></span>
<span id="cb14-760"><a href="#cb14-760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-761"><a href="#cb14-761" aria-hidden="true" tabindex="-1"></a><span class="vs">One limitation I encountered was the inability to add labels to the force graph. Ideally, the blue node in the center should be labeled as United States, representing the entire nation. The orange nodes represent different age groups, while the red nodes situated along the boundary indicate the top 3 conditions contributing to the deaths in each corresponding age group. The width of the links between the nodes reflects the number of death cases associated with each condition.</span></span>
<span id="cb14-762"><a href="#cb14-762" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-763"><a href="#cb14-763" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-764"><a href="#cb14-764" aria-hidden="true" tabindex="-1"></a><span class="vs">## Choropleth Map for COVID-19 Deaths by State</span></span>
<span id="cb14-765"><a href="#cb14-765" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-766"><a href="#cb14-766" aria-hidden="true" tabindex="-1"></a><span class="vs">Geocoding presents a significant challenge when creating choropleth maps. In R language, the maps library can be used to match specific location names to polygons with corresponding longitudes and latitudes on a map. In my project, these name lists are stored in lowercase:</span></span>
<span id="cb14-767"><a href="#cb14-767" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-768"><a href="#cb14-768" aria-hidden="true" tabindex="-1"></a><span class="vs">    us_map &lt;- maps::map("state", plot = FALSE, fill = TRUE) %&gt;%</span></span>
<span id="cb14-769"><a href="#cb14-769" aria-hidden="true" tabindex="-1"></a><span class="vs">      st_as_sf() %&gt;%</span></span>
<span id="cb14-770"><a href="#cb14-770" aria-hidden="true" tabindex="-1"></a><span class="vs">      rename(State = ID)</span></span>
<span id="cb14-771"><a href="#cb14-771" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-772"><a href="#cb14-772" aria-hidden="true" tabindex="-1"></a><span class="vs">    agg_data$State &lt;- tolower(agg_data$State)</span></span>
<span id="cb14-773"><a href="#cb14-773" aria-hidden="true" tabindex="-1"></a><span class="vs">    us_map$State &lt;- tolower(us_map$State)</span></span>
<span id="cb14-774"><a href="#cb14-774" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-775"><a href="#cb14-775" aria-hidden="true" tabindex="-1"></a><span class="vs">However, the state values in the State column were originally stored with capital initials, causing missing data throughout the map. By modifying the code as shown above, the geocoding process can now accurately map the csv data to the choropleth's required format, successfully rendering the intended map visualization.</span></span>
<span id="cb14-776"><a href="#cb14-776" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-779"><a href="#cb14-779" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-780"><a href="#cb14-780" aria-hidden="true" tabindex="-1"></a>#<span class="op">|</span> code<span class="op">-</span>fold<span class="op">:</span> <span class="kw">true</span></span>
<span id="cb14-781"><a href="#cb14-781" aria-hidden="true" tabindex="-1"></a>#<span class="op">|</span> output<span class="op">:</span> <span class="kw">false</span></span>
<span id="cb14-782"><a href="#cb14-782" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb14-783"><a href="#cb14-783" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb14-784"><a href="#cb14-784" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb14-785"><a href="#cb14-785" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(maps)</span>
<span id="cb14-786"><a href="#cb14-786" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(viridis)</span>
<span id="cb14-787"><a href="#cb14-787" aria-hidden="true" tabindex="-1"></a><span class="vs">```</span></span>
<span id="cb14-788"><a href="#cb14-788" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-791"><a href="#cb14-791" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-792"><a href="#cb14-792" aria-hidden="true" tabindex="-1"></a>data <span class="op">&lt;-</span> read<span class="op">.</span><span class="fu">csv</span>(<span class="st">"./choropleth/state_filtered_by_total.csv"</span><span class="op">,</span> header <span class="op">=</span> TRUE<span class="op">,</span> sep <span class="op">=</span> <span class="st">","</span><span class="op">,</span> stringsAsFactors <span class="op">=</span> FALSE)</span>
<span id="cb14-793"><a href="#cb14-793" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(data) <span class="op">&lt;-</span> <span class="fu">gsub</span>(<span class="st">" "</span><span class="op">,</span> <span class="st">""</span><span class="op">,</span> <span class="fu">colnames</span>(data))</span>
<span id="cb14-794"><a href="#cb14-794" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-795"><a href="#cb14-795" aria-hidden="true" tabindex="-1"></a>agg_data <span class="op">&lt;-</span> data <span class="op">%&gt;%</span></span>
<span id="cb14-796"><a href="#cb14-796" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(State) <span class="op">%&gt;%</span></span>
<span id="cb14-797"><a href="#cb14-797" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(Total_Deaths <span class="op">=</span> <span class="fu">sum</span>(COVID_19_Deaths<span class="op">,</span> na<span class="op">.</span><span class="at">rm</span> <span class="op">=</span> TRUE))</span>
<span id="cb14-798"><a href="#cb14-798" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-799"><a href="#cb14-799" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-800"><a href="#cb14-800" aria-hidden="true" tabindex="-1"></a>us_map <span class="op">&lt;-</span> maps<span class="op">::</span><span class="fu">map</span>(<span class="st">"state"</span><span class="op">,</span> plot <span class="op">=</span> FALSE<span class="op">,</span> fill <span class="op">=</span> TRUE) <span class="op">%&gt;%</span></span>
<span id="cb14-801"><a href="#cb14-801" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>() <span class="op">%&gt;%</span></span>
<span id="cb14-802"><a href="#cb14-802" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(State <span class="op">=</span> ID)</span>
<span id="cb14-803"><a href="#cb14-803" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-804"><a href="#cb14-804" aria-hidden="true" tabindex="-1"></a>agg_data$State <span class="op">&lt;-</span> <span class="fu">tolower</span>(agg_data$State)</span>
<span id="cb14-805"><a href="#cb14-805" aria-hidden="true" tabindex="-1"></a>us_map$State <span class="op">&lt;-</span> <span class="fu">tolower</span>(us_map$State)</span>
<span id="cb14-806"><a href="#cb14-806" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-807"><a href="#cb14-807" aria-hidden="true" tabindex="-1"></a>merged_data <span class="op">&lt;-</span> <span class="fu">left_join</span>(us_map<span class="op">,</span> agg_data<span class="op">,</span> by <span class="op">=</span> <span class="st">"State"</span>)</span>
<span id="cb14-808"><a href="#cb14-808" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-809"><a href="#cb14-809" aria-hidden="true" tabindex="-1"></a>merged_data$Total_Deaths[is<span class="op">.</span><span class="fu">na</span>(merged_data$Total_Deaths)] <span class="op">&lt;-</span> <span class="dv">0</span></span>
<span id="cb14-810"><a href="#cb14-810" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-811"><a href="#cb14-811" aria-hidden="true" tabindex="-1"></a>custom_breaks <span class="op">&lt;-</span> <span class="kw">function</span>(limits) {</span>
<span id="cb14-812"><a href="#cb14-812" aria-hidden="true" tabindex="-1"></a>  default_breaks <span class="op">&lt;-</span> <span class="fu">pretty</span>(<span class="fu">c</span>(<span class="dv">0</span><span class="op">,</span> limits[<span class="dv">2</span>]<span class="op">^</span><span class="fl">0.5</span>)<span class="op">,</span> n <span class="op">=</span> <span class="dv">5</span>)<span class="op">^</span><span class="dv">2</span></span>
<span id="cb14-813"><a href="#cb14-813" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span>(default_breaks)</span>
<span id="cb14-814"><a href="#cb14-814" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-815"><a href="#cb14-815" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-816"><a href="#cb14-816" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(data <span class="op">=</span> merged_data) <span class="op">+</span></span>
<span id="cb14-817"><a href="#cb14-817" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(fill <span class="op">=</span> Total_Deaths)<span class="op">,</span> color <span class="op">=</span> <span class="st">"white"</span><span class="op">,</span> size <span class="op">=</span> <span class="fl">0.2</span>) <span class="op">+</span></span>
<span id="cb14-818"><a href="#cb14-818" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis</span>(option <span class="op">=</span> <span class="st">"magma"</span><span class="op">,</span> trans <span class="op">=</span> <span class="st">"sqrt"</span><span class="op">,</span> <span class="op">,</span> direction <span class="op">=</span> <span class="op">-</span><span class="dv">1</span><span class="op">,</span> name <span class="op">=</span> <span class="st">"COVID-19 Deaths"</span><span class="op">,</span></span>
<span id="cb14-819"><a href="#cb14-819" aria-hidden="true" tabindex="-1"></a>                     breaks <span class="op">=</span> custom_breaks<span class="op">,</span></span>
<span id="cb14-820"><a href="#cb14-820" aria-hidden="true" tabindex="-1"></a>                     guide <span class="op">=</span> <span class="fu">guide_colorbar</span>(title<span class="op">.</span><span class="at">position</span> <span class="op">=</span> <span class="st">"top"</span><span class="op">,</span> title<span class="op">.</span><span class="at">hjust</span> <span class="op">=</span> <span class="fl">0.5</span><span class="op">,</span></span>
<span id="cb14-821"><a href="#cb14-821" aria-hidden="true" tabindex="-1"></a>                                            label<span class="op">.</span><span class="at">position</span> <span class="op">=</span> <span class="st">"bottom"</span><span class="op">,</span> label<span class="op">.</span><span class="at">hjust</span> <span class="op">=</span> <span class="fl">0.5</span><span class="op">,</span></span>
<span id="cb14-822"><a href="#cb14-822" aria-hidden="true" tabindex="-1"></a>                                            barwidth <span class="op">=</span> <span class="dv">15</span><span class="op">,</span> barheight <span class="op">=</span> <span class="fl">0.8</span>)) <span class="op">+</span></span>
<span id="cb14-823"><a href="#cb14-823" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(title <span class="op">=</span> <span class="st">"Choropleth Map: COVID-19 Deaths by State"</span>) <span class="op">+</span></span>
<span id="cb14-824"><a href="#cb14-824" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="op">+</span></span>
<span id="cb14-825"><a href="#cb14-825" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(panel<span class="op">.</span><span class="at">grid</span><span class="op">.</span><span class="at">major</span> <span class="op">=</span> <span class="fu">element_blank</span>()<span class="op">,</span></span>
<span id="cb14-826"><a href="#cb14-826" aria-hidden="true" tabindex="-1"></a>        panel<span class="op">.</span><span class="at">grid</span><span class="op">.</span><span class="at">minor</span> <span class="op">=</span> <span class="fu">element_blank</span>()<span class="op">,</span></span>
<span id="cb14-827"><a href="#cb14-827" aria-hidden="true" tabindex="-1"></a>        panel<span class="op">.</span><span class="at">background</span> <span class="op">=</span> <span class="fu">element_blank</span>()<span class="op">,</span></span>
<span id="cb14-828"><a href="#cb14-828" aria-hidden="true" tabindex="-1"></a>        axis<span class="op">.</span><span class="at">text</span> <span class="op">=</span> <span class="fu">element_blank</span>()<span class="op">,</span></span>
<span id="cb14-829"><a href="#cb14-829" aria-hidden="true" tabindex="-1"></a>        axis<span class="op">.</span><span class="at">ticks</span> <span class="op">=</span> <span class="fu">element_blank</span>()<span class="op">,</span></span>
<span id="cb14-830"><a href="#cb14-830" aria-hidden="true" tabindex="-1"></a>        axis<span class="op">.</span><span class="at">title</span> <span class="op">=</span> <span class="fu">element_blank</span>()<span class="op">,</span></span>
<span id="cb14-831"><a href="#cb14-831" aria-hidden="true" tabindex="-1"></a>        legend<span class="op">.</span><span class="at">position</span> <span class="op">=</span> <span class="st">"bottom"</span><span class="op">,</span></span>
<span id="cb14-832"><a href="#cb14-832" aria-hidden="true" tabindex="-1"></a>        legend<span class="op">.</span><span class="at">key</span><span class="op">.</span><span class="at">height</span> <span class="op">=</span> <span class="fu">unit</span>(<span class="dv">2</span><span class="op">,</span> <span class="st">"cm"</span>)<span class="op">,</span></span>
<span id="cb14-833"><a href="#cb14-833" aria-hidden="true" tabindex="-1"></a>        legend<span class="op">.</span><span class="at">title</span> <span class="op">=</span> <span class="fu">element_text</span>(size <span class="op">=</span> <span class="dv">11</span>)<span class="op">,</span></span>
<span id="cb14-834"><a href="#cb14-834" aria-hidden="true" tabindex="-1"></a>        legend<span class="op">.</span><span class="at">text</span> <span class="op">=</span> <span class="fu">element_text</span>(size <span class="op">=</span> <span class="dv">9</span>))</span>
<span id="cb14-835"><a href="#cb14-835" aria-hidden="true" tabindex="-1"></a><span class="vs">```</span></span>
<span id="cb14-836"><a href="#cb14-836" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-837"><a href="#cb14-837" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-838"><a href="#cb14-838" aria-hidden="true" tabindex="-1"></a><span class="vs">This Choropleth Map for COVID-19 Deaths by State effectively illustrates the spatial differences in death cases across the United States, highlighting the state-wise fatality of the pandemic. By visualizing these disparities, the map underscores the importance of understanding regional variations in public health outcomes and pandemic responses. This information is crucial for policy makers, public health officials, and researchers as they develop targeted interventions, allocate resources, and evaluate the effectiveness of various strategies in mitigating the impact of COVID-19.</span></span>
<span id="cb14-839"><a href="#cb14-839" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-840"><a href="#cb14-840" aria-hidden="true" tabindex="-1"></a><span class="vs"># Conclusion</span></span>
<span id="cb14-841"><a href="#cb14-841" aria-hidden="true" tabindex="-1"></a><span class="vs">In this blog, I have demonstrated a workflow for processing a public COVID-19 dataset from [Data.gov](https://data.gov/) and showcasing the data characteristics using four different visualizations.</span></span>
<span id="cb14-842"><a href="#cb14-842" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-843"><a href="#cb14-843" aria-hidden="true" tabindex="-1"></a><span class="vs">The first visualization, a bar chart of COVID-19 death cases, straightforwardly displays the significantly higher percentage of senior victims in the pandemic. The second visualization, a dynamic bar chart, proved a bit more challenging due to my limited familiarity with JavaScript. I spent some time fixing the bar shifting issues, but there remains an unresolved issue where some states with fewer death cases have their names overlapping the y-axis and becoming invisible to the audience. A potential solution could involve applying the `</span><span class="fu">x</span>(<span class="dv">0</span>)<span class="vs">` variable to shift the labels accordingly, but this adjustment might also lead to broken visualizations.</span></span>
<span id="cb14-844"><a href="#cb14-844" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-845"><a href="#cb14-845" aria-hidden="true" tabindex="-1"></a><span class="vs">The third visualization, a force graph, did not turn out as intended. It fails to convey useful information about the dataset since I was unable to add labels to the graph. I decided to include it here because it required significant effort on my part.</span></span>
<span id="cb14-846"><a href="#cb14-846" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-847"><a href="#cb14-847" aria-hidden="true" tabindex="-1"></a><span class="vs">The final visualization, a Choropleth Map, was relatively straightforward to create, with the main challenge being the integration of lowercase state names.</span></span>
<span id="cb14-848"><a href="#cb14-848" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-849"><a href="#cb14-849" aria-hidden="true" tabindex="-1"></a><span class="vs">Throughout the course, I have learned many powerful and effective visualization techniques that have been invaluable to me. Due to time constraints, I could not include all these techniques in this blog. I would like to extend my gratitude to Professor Barrie for the invaluable lessons.</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>